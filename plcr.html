<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PLCR - Tank Calculator</title>
  <link href="icon.png" rel="icon" type="image/png"/>
  <link rel="manifest" href="/manifest.json">
  <meta name="theme-color" content="#003366">
  <script type="module">
    import{initializeApp}from'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
    import{getFirestore,doc,getDoc,collection,getDocs}from'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
    const app=initializeApp({apiKey:"AIzaSyD7lJcoY33FEC9d6eWy67QIO9SV4lS24pg",authDomain:"tank-tools-knpc-c2d95.firebaseapp.com",projectId:"tank-tools-knpc-c2d95",storageBucket:"tank-tools-knpc-c2d95.firebasestorage.app",messagingSenderId:"510062594324",appId:"1:510062594324:web:b892fd02007a5ca2f0da01"});
    window.db=getFirestore(app);window.doc=doc;window.getDoc=getDoc;window.collection=collection;window.getDocs=getDocs;
  </script>
  <script src="permissions.js"></script>
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:Arial,sans-serif;margin:0;padding:20px;background:linear-gradient(rgba(0,0,0,0.5),rgba(0,0,0,0.5)),url('background.jpg');background-size:cover;background-position:center;background-attachment:fixed;color:white;direction:ltr;min-height:100vh}
    h2{color:white;text-align:center}
    .nav-bar{display:flex;justify-content:space-between;align-items:center;padding:10px 20px;background:rgba(0,0,0,0.5);border-radius:10px;margin-bottom:20px;flex-wrap:wrap}
    .nav-logo{font-size:24px;font-weight:bold;color:white}
    .nav-links{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .nav-link{color:white;text-decoration:none;padding:8px 16px;border-radius:8px;transition:all 0.3s ease;background:rgba(255,255,255,0.1);font-weight:500;border:1px solid rgba(255,255,255,0.2)}
    .nav-link:hover{background:rgba(255,255,255,0.2);transform:translateY(-1px)}
    .nav-link.active{background:rgba(255,255,255,0.3);font-weight:bold;border:1px solid rgba(255,255,255,0.4)}
    .nav-admin{background:linear-gradient(45deg,#FFD700,#FFA500);color:#003366;font-weight:bold;border-radius:8px;padding:8px 16px;text-decoration:none;transition:all 0.3s ease;border:1px solid #FFA500;font-size:inherit}
    .nav-admin:hover{transform:translateY(-1px);box-shadow:0 4px 12px rgba(255,215,0,0.3)}
    .nav-user{display:flex;align-items:center;gap:10px;background:rgba(255,255,255,0.1);padding:5px 15px;border-radius:20px;backdrop-filter:blur(10px)}
    .user-avatar{width:30px;height:30px;border-radius:50%;background:linear-gradient(45deg,#4CAF50,#45a049);display:flex;align-items:center;justify-content:center;font-weight:bold;font-size:14px}
    .logout-btn{background:rgba(255,0,0,0.2);border:1px solid rgba(255,0,0,0.5);color:white;padding:5px 10px;border-radius:5px;cursor:pointer;font-size:12px;transition:all 0.3s ease}
    .font-controls{display:flex;gap:5px;margin-right:10px}
    .font-btn{background:rgba(255,255,255,0.2);border:1px solid rgba(255,255,255,0.3);color:white;padding:5px 10px;border-radius:5px;cursor:pointer;font-size:14px;font-weight:bold;transition:all 0.3s ease;min-width:30px}
    .font-btn:hover{background:rgba(255,255,255,0.3);transform:translateY(-1px)}
    .container{background:rgba(255,255,255,0.1);padding:20px;border-radius:10px;max-width:600px;margin:auto;box-shadow:0 0 10px rgba(0,0,0,0.3);backdrop-filter:blur(10px)}
    label,input,select{display:block;width:100%;margin:10px 0;text-align:left}
    input,select{padding:10px;border-radius:8px;border:none;background:rgba(255,255,255,0.9);color:#003366;box-shadow:0 2px 5px rgba(0,0,0,0.3)}
    .result{margin-top:20px;font-weight:bold;text-align:center;color:#00ffff;padding:15px;background:rgba(0,0,0,0.3);border-radius:8px}
    .debug-info{margin-top:10px;font-size:12px;color:#ffcc00;background:rgba(0,0,0,0.5);padding:10px;border-radius:5px;text-align:left}
    footer{margin-top:40px;color:#ccc;text-align:center}
    .whatsapp-link{color:#25D366;text-decoration:none;font-weight:bold;transition:all 0.3s ease;cursor:pointer}
    .whatsapp-link:hover{color:#128C7E;text-shadow:0 0 5px rgba(37,211,102,0.5);transform:scale(1.05)}
    .action-button{position:fixed;width:40px;height:40px;border-radius:50%;background:rgba(255,255,255,0.3);border:none;font-size:20px;color:white;box-shadow:0 2px 5px rgba(0,0,0,0.3);cursor:pointer;display:flex;align-items:center;justify-content:center;top:10px;right:10px}
    .dark-mode{background:linear-gradient(rgba(0,0,0,0.8),rgba(0,0,0,0.8)),url('background.jpg')!important}
    .dark-mode .result{color:#ffcc00!important}
    .dark-mode input,.dark-mode select{background:rgba(50,50,70,0.9)!important;color:#eee!important}
    .dark-mode .container{background:rgba(40,40,60,0.3)!important}
    .access-denied{position:fixed;top:0;left:0;width:100%;height:100%;background:linear-gradient(rgba(0,0,0,0.8),rgba(0,0,0,0.8)),url('background.jpg');background-size:cover;background-position:center;display:flex;justify-content:center;align-items:center;z-index:9999}
    .access-denied-content{text-align:center;background:rgba(255,255,255,0.1);padding:40px;border-radius:20px;backdrop-filter:blur(10px);border:1px solid rgba(255,255,255,0.2)}
    .access-denied-icon{font-size:5rem;color:#f44336;margin-bottom:20px}
    .access-denied-title{font-size:2rem;color:#f44336;margin-bottom:15px}
    .access-denied-text{font-size:1.2rem;margin-bottom:20px;opacity:0.8}
    .login-btn{padding:12px 25px;background:linear-gradient(45deg,#4CAF50,#45a049);color:white;border:none;border-radius:10px;cursor:pointer;font-size:16px;transition:all 0.3s ease;margin:5px}
    .security-modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.9);z-index:9999;backdrop-filter:blur(5px)}
    .security-modal.show{display:flex;justify-content:center;align-items:center}
    .security-modal-content{background:rgba(255,255,255,0.95);padding:30px;border-radius:15px;max-width:500px;width:90%;color:#003366;text-align:center;animation:modalSlideIn 0.5s ease}
    @keyframes modalSlideIn{from{opacity:0;transform:scale(0.8)}to{opacity:1;transform:scale(1)}}
    .security-icon{font-size:3rem;margin-bottom:15px}
    .security-title{font-size:1.5rem;margin-bottom:15px;font-weight:bold}
    .security-text{margin-bottom:20px;line-height:1.5}
    .attempt-counter{background:rgba(255,193,7,0.2);border:1px solid rgba(255,193,7,0.5);color:#f57c00;padding:10px;border-radius:8px;margin:15px 0;font-weight:bold}
    .security-buttons{display:flex;gap:10px;justify-content:center;flex-wrap:wrap}
    .modal-btn{padding:10px 20px;border:none;border-radius:8px;cursor:pointer;font-weight:500;transition:all 0.3s ease}
    .modal-btn-primary{background:#4CAF50;color:white}
    .modal-btn-secondary{background:#2196F3;color:white}
    .modal-btn-danger{background:#f44336;color:white}
    .modal-btn:hover{transform:translateY(-2px);box-shadow:0 5px 15px rgba(0,0,0,0.3)}
    @media (max-width:600px){
      .nav-bar{flex-direction:column;gap:15px;padding:15px}
      .nav-links{order:1;justify-content:center;width:100%}
      .nav-user{order:2;width:100%;justify-content:space-between}
      .nav-link{padding:10px 15px;font-size:14px}
      .nav-admin{padding:10px 15px;font-size:14px;display:inline-flex;align-items:center}
      .container{padding:15px;margin:10px}
      .security-buttons{flex-direction:column}
      .modal-btn{width:100%}
    }
  </style>
</head>
<body>
  <!-- Security Modal -->
  <div id="securityModal" class="security-modal">
    <div class="security-modal-content">
      <div class="security-icon" id="securityIcon">‚ö†Ô∏è</div>
      <div class="security-title" id="securityTitle">Security Warning</div>
      <div class="security-text" id="securityText">We detected you trying to access developer tools.</div>
      <div class="attempt-counter" id="attemptCounter">Attempts: <span id="attemptCount">1</span>/3</div>
      <div class="security-buttons">
        <button class="modal-btn modal-btn-primary" onclick="acknowledgeWarning()">I Understand</button>
        <button class="modal-btn modal-btn-secondary" onclick="resetPage()">Reset Page</button>
        <button class="modal-btn modal-btn-danger" onclick="learnMore()">Learn More</button>
      </div>
    </div>
  </div>

  <!-- Access Denied -->
  <div id="accessDenied" class="access-denied" style="display:none">
    <div class="access-denied-content">
      <div class="access-denied-icon">üîí</div>
      <div class="access-denied-title">Login Required</div>
      <div class="access-denied-text">You need to login to access PLCR Calculator.<br>Please login with your KNPC credentials.</div>
      <button class="login-btn" onclick="goToLogin()">Go to Login</button>
    </div>
  </div>

  <!-- Main Content -->
  <div id="mainContent">
    <div class="nav-bar">
      <div class="nav-logo">Tank Tools</div>
      <div class="nav-links">
        <a class="nav-link" href="index.html">PBCR</a>
        <a class="nav-link active" href="plcr.html">PLCR</a>
        <a class="nav-link" href="NMOGASBL.html">NMOGAS</a>
        <a class="nav-link" href="live-tanks.html" id="liveTanksLink" style="display:none">üî¥ Live Tanks</a>
        <a class="nav-admin" href="dashboard.html" id="adminLink" style="display:none">üîê Dashboard</a>
      </div>
      <div class="nav-user" id="navUser">
        <div class="font-controls">
          <button class="font-btn" onclick="decreaseFontSize()" title="ÿ™ÿµÿ∫Ÿäÿ± ÿßŸÑÿÆÿ∑">-</button>
          <button class="font-btn" onclick="increaseFontSize()" title="ÿ™ŸÉÿ®Ÿäÿ± ÿßŸÑÿÆÿ∑">+</button>
        </div>
        <div class="user-avatar" id="userAvatar">U</div>
        <div id="userName">Loading...</div>
        <button class="logout-btn" onclick="logout()">Logout</button>
      </div>
    </div>

    <div class="container">
      <h2>PLCR - Tank Calculator</h2>
      
      <label for="mode">Select Mode:</label>
      <select id="mode" onchange="updateInputLabel()">
        <option value="levelToBarrels">Level to Barrels</option>
        <option value="barrelsToLevel">Barrels to Level</option>
        <option value="tonToLevel">Metric Ton to Level</option>
        <option value="levelToTon">Level to Metric Ton</option>
      </select>
      
      <label for="tk">Tank Number:</label>
      <input type="number" id="tk" placeholder="e.g. 424" oninput="calculate()">

      <label id="inputLabel" for="value">Enter Level (mm):</label>
      <input type="number" id="value" placeholder="Enter number" oninput="calculate()">

      <div class="result" id="result">Enter tank number and value to calculate</div>
      <div class="debug-info" id="debugInfo" style="display:none"></div>
    </div>
    
    <button id="darkModeButton" class="action-button" title="Dark Mode">üåô</button>
    
    <footer>
      By <a href="#" class="whatsapp-link" onclick="openWhatsApp(); return false;">Fahad - 17877</a> ‚Äì Version v4.4
      <br><small style="color:#999;font-size:10px;margin-top:5px;display:block">üì± WhatsApp: +965 55222550</small>
    </footer>
  </div>
  
  <script>
    // Global variables
    let tankConversions = {};
    let currentUser = null;
    let debugMode = false;

    // üîí Smart Security System - iPhone Optimized
    (function(){
      let attempts=0,modalOpen=false,isTyping=false,typingTimer=null;
      
      function initSecurity(){
        // Enhanced iPhone detection and typing tracking
        const isIPhone=/iPad|iPhone|iPod/.test(navigator.userAgent);
        
        // Multiple event listeners for comprehensive input tracking
        ['focusin','focus','input','keydown','keyup','touchstart'].forEach(eventType=>{
          document.addEventListener(eventType,e=>{
            if(e.target.matches('input,textarea,select')){
              isTyping=true;
              clearTimeout(typingTimer);
              typingTimer=setTimeout(()=>isTyping=false,isIPhone?1500:800);
            }
          },true);
        });
        
        // Additional safety for form interactions
        document.addEventListener('change',e=>{
          if(e.target.matches('input,textarea,select')){
            isTyping=true;
            clearTimeout(typingTimer);
            typingTimer=setTimeout(()=>isTyping=false,1000);
          }
        });
        
        // Enhanced event blocking when typing
        document.addEventListener('contextmenu',e=>{
          if(isTyping||e.target.matches('input,textarea,select')||e.target.closest('input,textarea,select'))return;
          handleViolation('context-menu')(e);
        });
        
        document.addEventListener('selectstart',e=>{
          if(isTyping||e.target.matches('input,textarea,select')||e.target.closest('input,textarea,select'))return;
          handleViolation('text-selection')(e);
        });
        
        document.addEventListener('keydown',e=>{
          if(isTyping||e.target.matches('input,textarea,select')||e.target.closest('input,textarea,select'))return;
          const dangerous=[(e.ctrlKey&&e.key==='u'),(e.ctrlKey&&e.key==='s'),(e.ctrlKey&&e.shiftKey&&e.key==='I'),(e.key==='F12'),(e.ctrlKey&&e.shiftKey&&e.key==='C'),(e.ctrlKey&&e.shiftKey&&e.key==='J')];
          if(dangerous.some(c=>c))handleViolation('keyboard-shortcut')(e);
        });
        
        // DevTools detection with typing check
        let devOpen=false;
        setInterval(()=>{
          if(isTyping)return;
          const threshold=160,wDiff=window.outerWidth-window.innerWidth,hDiff=window.outerHeight-window.innerHeight;
          if(wDiff>threshold||hDiff>threshold){
            if(!devOpen){devOpen=true;setTimeout(()=>{if(!isTyping)handleViolation('devtools-detected')()},500)}
          }else{devOpen=false}
        },isIPhone?5000:3000);
      }
      function handleViolation(type){
        return function(e){
          if(e&&e.preventDefault)e.preventDefault();
          attempts++;
          if(attempts===1)showWarning('first');
          else if(attempts===2)showWarning('second');
          else if(attempts>=3)showWarning('final');
          return false
        }
      }
      function showWarning(level){
        if(modalOpen)return;
        const modal=document.getElementById('securityModal'),icon=document.getElementById('securityIcon'),title=document.getElementById('securityTitle'),text=document.getElementById('securityText'),counter=document.getElementById('attemptCounter'),countSpan=document.getElementById('attemptCount');
        modalOpen=true;countSpan.textContent=attempts;
        if(level==='first'){
          icon.textContent='üëÄ';title.textContent='Security Notice';
          text.innerHTML='<p>We noticed you tried to access developer tools on PLCR Calculator.</p><p><strong>If this was accidental:</strong> No problem! Click "I Understand" to continue.</p><p><strong>Note:</strong> This calculator contains KNPC tank conversion data.</p>';
          counter.style.background='rgba(33,150,243,0.2)';counter.style.borderColor='rgba(33,150,243,0.5)';counter.style.color='#2196F3'
        }else if(level==='second'){
          icon.textContent='‚ö†Ô∏è';title.textContent='Security Warning';
          text.innerHTML='<p><strong>Second attempt detected on PLCR Calculator.</strong></p><p>Please note this system contains:</p><ul style="text-align:left;margin:10px 0"><li>Proprietary tank conversion algorithms</li><li>KNPC operational data</li><li>Protected calculation methods</li></ul><p>One more attempt will activate security measures.</p>';
          counter.style.background='rgba(255,193,7,0.2)';counter.style.borderColor='rgba(255,193,7,0.5)';counter.style.color='#ffc107'
        }else{
          icon.textContent='üö´';title.textContent='PLCR Security Lock';
          text.innerHTML='<p><strong>Maximum attempts exceeded on PLCR Calculator.</strong></p><p>Enhanced monitoring activated for:</p><ul style="text-align:left;margin:10px 0"><li>Tank calculation protection</li><li>KNPC data security</li><li>System integrity maintenance</li></ul><p>Use "Reset Page" to continue normally.</p>';
          counter.style.background='rgba(244,67,54,0.2)';counter.style.borderColor='rgba(244,67,54,0.5)';counter.style.color='#f44336';
          setTimeout(()=>{if(attempts>=3)implementRestrictions()},5000)
        }
        modal.classList.add('show')
      }
      function implementRestrictions(){
        document.body.style.filter='blur(3px)';
        const overlay=document.createElement('div');
        overlay.style.cssText='position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.8);z-index:10000;display:flex;justify-content:center;align-items:center;color:white;font-size:24px;text-align:center;';
        overlay.innerHTML='<div>üîí PLCR Security Lock Active<br><small style="font-size:16px;margin-top:10px;display:block;">Refresh page to continue</small></div>';
        document.body.appendChild(overlay);
        document.addEventListener('keydown',e=>e.preventDefault(),true);
        document.addEventListener('contextmenu',e=>e.preventDefault(),true)
      }
      window.acknowledgeWarning=function(){
        document.getElementById('securityModal').classList.remove('show');
        modalOpen=false
      };
      window.resetPage=function(){
        location.reload()
      };
      window.learnMore=function(){
        alert('üîí PLCR Security Information\n\nThis calculator contains:\n‚Ä¢ Proprietary KNPC tank conversion data\n‚Ä¢ Protected calculation algorithms\n‚Ä¢ Sensitive operational information\n\nDeveloper tools access is monitored for security purposes.')
      };
      initSecurity()
    })();

    // Enhanced Login Check with better error handling
    async function checkLogin() {
      try {
        const session = sessionStorage.getItem('tanktools_session');
        const userData = localStorage.getItem('tanktools_current_user');
        
        if (session !== 'active' || !userData) {
          showAccessDenied();
          return false;
        }
        
        // Parse user data with error handling
        try {
          currentUser = JSON.parse(userData);
          console.log('‚úÖ User data loaded:', currentUser);
        } catch (parseError) {
          console.error('‚ùå Error parsing user data:', parseError);
          showAccessDenied();
          return false;
        }
        
        // Load user permissions with timeout
        const permissionsLoaded = await Promise.race([
          checkUserPermissions(),
          new Promise((_, reject) => setTimeout(() => reject(new Error('Timeout')), 5000))
        ]);
        
        if (!permissionsLoaded) {
          console.error('‚ùå Failed to load user permissions');
          showAccessDenied();
          return false;
        }
        
        // Check page access
        if (!checkPageAccess('plcr')) {
          return false;
        }
        
        // Load user info after successful authentication
        loadUserInfo();
        
        // Load tank data
        await loadTankData();
        
        return true;
      } catch (error) {
        console.error('‚ùå Login check failed:', error);
        showAccessDenied();
        return false;
      }
    }

    // Enhanced User Info Loading
    function loadUserInfo() {
      try {
        if (!currentUser) {
          console.warn('‚ö†Ô∏è No current user data available');
          return;
        }
        
        const userName = document.getElementById('userName');
        const userAvatar = document.getElementById('userAvatar');
        
        if (userName && currentUser.fullName) {
          userName.textContent = currentUser.fullName;
          console.log('‚úÖ User name displayed:', currentUser.fullName);
        } else if (userName && currentUser.username) {
          userName.textContent = currentUser.username;
          console.log('‚úÖ Username displayed:', currentUser.username);
        } else {
          userName.textContent = 'User';
          console.warn('‚ö†Ô∏è No user name available, using default');
        }
        
        if (userAvatar && currentUser.fullName) {
          userAvatar.textContent = currentUser.fullName.charAt(0).toUpperCase();
        } else if (userAvatar && currentUser.username) {
          userAvatar.textContent = currentUser.username.charAt(0).toUpperCase();
        }
        
        // Apply UI restrictions based on permissions
        if (window.permissionsManager) {
          window.permissionsManager.applyUIRestrictions();
        }
      } catch (error) {
        console.error('‚ùå Error loading user info:', error);
      }
    }

    // Enhanced Tank Data Loading with proper Firebase path
    async function loadTankData() {
      try {
        console.log('üîÑ Loading tank data from Firebase...');
        
        // Try to load from the correct subcollection path
        const tanksRef = collection(db, 'tankData', 'plcr', 'tanks');
        const snapshot = await getDocs(tanksRef);
        
        if (!snapshot.empty) {
          tankConversions = {};
          let loadedCount = 0;
          
          snapshot.forEach((doc) => {
            const data = doc.data();
            const tankId = doc.id;
            
            // Convert Firebase data structure to expected format
            tankConversions[tankId] = {
              gross: data.gross || data.capacity || 0,
              factor: data.factor || data.comment || 1,
              min: data.min || 0,
              max: data.max || 10000
            };
            loadedCount++;
          });
          
          console.log(`‚úÖ Loaded ${loadedCount} tanks from Firebase`);
          updateDebugInfo(`Loaded ${loadedCount} tanks from Firebase`);
          
          // Apply permissions filtering
          if (window.permissionsManager) {
            tankConversions = window.permissionsManager.filterTankData(tankConversions, 'plcr');
          }
          
        } else {
          console.warn('‚ö†Ô∏è No tank data found in Firebase, loading fallback data');
          loadFallbackData();
        }
        
      } catch (error) {
        console.error('‚ùå Error loading tank data from Firebase:', error);
        updateDebugInfo(`Firebase Error: ${error.message}`);
        loadFallbackData();
      }
    }

    // Fallback data for when Firebase is unavailable
    function loadFallbackData() {
      console.log('üîÑ Loading fallback tank data...');
      
      // Sample PLCR tank data - replace with actual data
      tankConversions = {
        "424": { gross: 50000, factor: 0.159, min: 100, max: 9500 },
        "425": { gross: 50000, factor: 0.159, min: 100, max: 9500 },
        "426": { gross: 50000, factor: 0.159, min: 100, max: 9500 },
        "427": { gross: 50000, factor: 0.159, min: 100, max: 9500 },
        "428": { gross: 50000, factor: 0.159, min: 100, max: 9500 }
      };
      
      updateDebugInfo('Using fallback data (5 tanks)');
      console.log('‚úÖ Fallback data loaded');
    }

    // Update input label based on mode
    function updateInputLabel() {
      const mode = document.getElementById('mode').value;
      const label = document.getElementById('inputLabel');
      
      switch(mode) {
        case 'levelToBarrels':
          label.textContent = 'Enter Level (mm):';
          break;
        case 'barrelsToLevel':
          label.textContent = 'Enter Barrels:';
          break;
        case 'tonToLevel':
          label.textContent = 'Enter Metric Ton:';
          break;
        case 'levelToTon':
          label.textContent = 'Enter Level (mm):';
          break;
      }
    }

    // Enhanced calculation function
    function calculate() {
      const tankNumber = document.getElementById('tk').value;
      const value = parseFloat(document.getElementById('value').value);
      const mode = document.getElementById('mode').value;
      const resultDiv = document.getElementById('result');
      
      if (!tankNumber || isNaN(value)) {
        resultDiv.innerHTML = 'Enter tank number and value to calculate';
        return;
      }
      
      const tankData = tankConversions[tankNumber];
      if (!tankData) {
        resultDiv.innerHTML = `‚ùå Tank ${tankNumber} not found in database`;
        updateDebugInfo(`Tank ${tankNumber} not found. Available tanks: ${Object.keys(tankConversions).join(', ')}`);
        return;
      }
      
      try {
        let result;
        
        switch(mode) {
          case 'levelToBarrels':
            if (value < tankData.min || value > tankData.max) {
              resultDiv.innerHTML = `‚ö†Ô∏è Level out of range (${tankData.min}-${tankData.max} mm)`;
              return;
            }
            result = (value * tankData.factor).toFixed(2);
            resultDiv.innerHTML = `üìä <strong>${result} Barrels</strong><br><small>Tank ${tankNumber} at ${value} mm</small>`;
            break;
            
          case 'barrelsToLevel':
            const maxBarrels = tankData.max * tankData.factor;
            if (value > maxBarrels) {
              resultDiv.innerHTML = `‚ö†Ô∏è Barrels exceed tank capacity (max: ${maxBarrels.toFixed(2)})`;
              return;
            }
            result = (value / tankData.factor).toFixed(2);
            resultDiv.innerHTML = `üìè <strong>${result} mm</strong><br><small>Tank ${tankNumber} for ${value} barrels</small>`;
            break;
            
          case 'tonToLevel':
            // Assuming density conversion factor (approximate)
            const barrels = value * 7.33; // Approximate conversion from metric tons to barrels
            result = (barrels / tankData.factor).toFixed(2);
            resultDiv.innerHTML = `üìè <strong>${result} mm</strong><br><small>Tank ${tankNumber} for ${value} metric tons</small>`;
            break;
            
          case 'levelToTon':
            if (value < tankData.min || value > tankData.max) {
              resultDiv.innerHTML = `‚ö†Ô∏è Level out of range (${tankData.min}-${tankData.max} mm)`;
              return;
            }
            const barrels = value * tankData.factor;
            result = (barrels / 7.33).toFixed(2); // Approximate conversion from barrels to metric tons
            resultDiv.innerHTML = `‚öñÔ∏è <strong>${result} Metric Tons</strong><br><small>Tank ${tankNumber} at ${value} mm</small>`;
            break;
        }
        
        updateDebugInfo(`Calculation: ${mode}, Tank: ${tankNumber}, Input: ${value}, Result: ${result}`);
        
      } catch (error) {
        console.error('‚ùå Calculation error:', error);
        resultDiv.innerHTML = '‚ùå Calculation error occurred';
        updateDebugInfo(`Calculation error: ${error.message}`);
      }
    }

    // Debug information display
    function updateDebugInfo(message) {
      if (debugMode) {
        const debugDiv = document.getElementById('debugInfo');
        debugDiv.style.display = 'block';
        debugDiv.innerHTML = `Debug: ${message}<br>Tanks loaded: ${Object.keys(tankConversions).length}`;
      }
    }

    // Show access denied screen
    function showAccessDenied() {
      document.getElementById('accessDenied').style.display = 'flex';
      document.getElementById('mainContent').style.display = 'none';
    }

    // Navigation functions
    function goToLogin() {
      window.location.href = 'login.html';
    }

    function logout() {
      sessionStorage.removeItem('tanktools_session');
      localStorage.removeItem('tanktools_current_user');
      window.location.href = 'login.html';
    }

    // Font size controls
    function increaseFontSize() {
      document.body.style.fontSize = (parseFloat(getComputedStyle(document.body).fontSize) + 1) + 'px';
    }

    function decreaseFontSize() {
      const currentSize = parseFloat(getComputedStyle(document.body).fontSize);
      if (currentSize > 12) {
        document.body.style.fontSize = (currentSize - 1) + 'px';
      }
    }

    // Dark mode toggle
    function setupDarkMode() {
      const darkModeButton = document.getElementById('darkModeButton');
      const isDarkMode = localStorage.getItem('darkMode') === 'true';
      
      if (isDarkMode) {
        document.body.classList.add('dark-mode');
        darkModeButton.textContent = '‚òÄÔ∏è';
      }
      
      darkModeButton.addEventListener('click', () => {
        document.body.classList.toggle('dark-mode');
        const isNowDark = document.body.classList.contains('dark-mode');
        darkModeButton.textContent = isNowDark ? '‚òÄÔ∏è' : 'üåô';
        localStorage.setItem('darkMode', isNowDark);
      });
    }

    // WhatsApp contact
    function openWhatsApp() {
      window.open('https://wa.me/96555222550?text=Hello%20Fahad,%20I%20need%20help%20with%20PLCR%20Tank%20Calculator', '_blank');
    }

    // Enable debug mode with URL parameter
    if (window.location.search.includes('debug=true')) {
      debugMode = true;
      console.log('üêõ Debug mode enabled');
    }

    // Initialize application
    document.addEventListener('DOMContentLoaded', async () => {
      console.log('üöÄ PLCR Calculator initializing...');
      
      setupDarkMode();
      updateInputLabel();
      
      // Check login and load data
      const loginSuccess = await checkLogin();
      if (loginSuccess) {
        console.log('‚úÖ PLCR Calculator ready');
      }
    });
  </script>
</body>
</html>

