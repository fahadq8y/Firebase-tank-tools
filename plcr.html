<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PLCR - Tank Calculator</title>
  <link href="icon.png" rel="icon" type="image/png"/>
  <link rel="manifest" href="/manifest.json">
  <meta name="theme-color" content="#003366">
  <script src="permissions.js"></script>
  
  <!-- Firebase v9 SDK -->
  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js';
    import { getFirestore, collection, addDoc, getDocs, query, where, orderBy, limit } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js';
    
    // Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyBxqKJBLOvwxgGqJvOwYzKfbLhHGjQoQQE",
      authDomain: "firebase-tank-tools.firebaseapp.com",
      projectId: "firebase-tank-tools",
      storageBucket: "firebase-tank-tools.appspot.com",
      messagingSenderId: "123456789",
      appId: "1:123456789:web:abcdef123456"
    };
    
    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    
    // Make Firebase functions globally available
    window.db = db;
    window.collection = collection;
    window.addDoc = addDoc;
    window.getDocs = getDocs;
    window.query = query;
    window.where = where;
    window.orderBy = orderBy;
    window.limit = limit;
  </script>
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:Arial,sans-serif;margin:0;padding:20px;background:linear-gradient(rgba(0,0,0,0.5),rgba(0,0,0,0.5)),url('background.jpg');background-size:cover;background-position:center;background-attachment:fixed;color:white;direction:ltr;min-height:100vh}
    h2{color:white;text-align:center}
    .nav-bar{display:flex;justify-content:space-between;align-items:center;padding:10px 20px;background:rgba(0,0,0,0.5);border-radius:10px;margin-bottom:20px;flex-wrap:wrap}
    .nav-logo{font-size:24px;font-weight:bold;color:white}
    .nav-links{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .nav-link{color:white;text-decoration:none;padding:8px 16px;border-radius:8px;transition:all 0.3s ease;background:rgba(255,255,255,0.1);font-weight:500;border:1px solid rgba(255,255,255,0.2)}
    .nav-link:hover{background:rgba(255,255,255,0.2);transform:translateY(-1px)}
    .nav-link.active{background:rgba(255,255,255,0.3);font-weight:bold;border:1px solid rgba(255,255,255,0.4)}
    .nav-admin{background:linear-gradient(45deg,#FFD700,#FFA500);color:#003366;font-weight:bold;border-radius:8px;padding:8px 16px;text-decoration:none;transition:all 0.3s ease;border:1px solid #FFA500;font-size:inherit}
    .nav-admin:hover{transform:translateY(-1px);box-shadow:0 4px 12px rgba(255,215,0,0.3)}
    .nav-user{display:flex;align-items:center;gap:10px;background:rgba(255,255,255,0.1);padding:5px 15px;border-radius:20px;backdrop-filter:blur(10px)}
    .user-avatar{width:30px;height:30px;border-radius:50%;background:linear-gradient(45deg,#4CAF50,#45a049);display:flex;align-items:center;justify-content:center;font-weight:bold;font-size:14px}
    .logout-btn{background:rgba(255,0,0,0.2);border:1px solid rgba(255,0,0,0.5);color:white;padding:5px 10px;border-radius:5px;cursor:pointer;font-size:12px;transition:all 0.3s ease}
    .font-controls{display:flex;gap:5px;margin-right:10px}
    .font-btn{background:rgba(255,255,255,0.2);border:1px solid rgba(255,255,255,0.3);color:white;padding:5px 10px;border-radius:5px;cursor:pointer;font-size:14px;font-weight:bold;transition:all 0.3s ease;min-width:30px}
    .font-btn:hover{background:rgba(255,255,255,0.3);transform:translateY(-1px)}
    .container{background:rgba(255,255,255,0.1);padding:20px;border-radius:10px;max-width:600px;margin:auto;box-shadow:0 0 10px rgba(0,0,0,0.3);backdrop-filter:blur(10px)}
    label,input,select{display:block;width:100%;margin:10px 0;text-align:left}
    input,select{padding:10px;border-radius:8px;border:none;background:rgba(255,255,255,0.9);color:#003366;box-shadow:0 2px 5px rgba(0,0,0,0.3)}
    .result{margin-top:20px;font-weight:bold;text-align:center;color:#00ffff;padding:15px;background:rgba(0,0,0,0.3);border-radius:8px}
    footer{margin-top:40px;color:#ccc;text-align:center}
    .whatsapp-link{color:#25D366;text-decoration:none;font-weight:bold;transition:all 0.3s ease;cursor:pointer}
    .whatsapp-link:hover{color:#128C7E;text-shadow:0 0 5px rgba(37,211,102,0.5);transform:scale(1.05)}
    .action-button{position:fixed;width:40px;height:40px;border-radius:50%;background:rgba(255,255,255,0.3);border:none;font-size:20px;color:white;box-shadow:0 2px 5px rgba(0,0,0,0.3);cursor:pointer;display:flex;align-items:center;justify-content:center;top:10px;right:10px}
    .dark-mode{background:linear-gradient(rgba(0,0,0,0.8),rgba(0,0,0,0.8)),url('background.jpg')!important}
    .dark-mode .result{color:#ffcc00!important}
    .dark-mode input,.dark-mode select{background:rgba(50,50,70,0.9)!important;color:#eee!important}
    .dark-mode .container{background:rgba(40,40,60,0.3)!important}
    .access-denied{position:fixed;top:0;left:0;width:100%;height:100%;background:linear-gradient(rgba(0,0,0,0.8),rgba(0,0,0,0.8)),url('background.jpg');background-size:cover;background-position:center;display:flex;justify-content:center;align-items:center;z-index:9999}
    .access-denied-content{text-align:center;background:rgba(255,255,255,0.1);padding:40px;border-radius:20px;backdrop-filter:blur(10px);border:1px solid rgba(255,255,255,0.2)}
    .access-denied-icon{font-size:5rem;color:#f44336;margin-bottom:20px}
    .access-denied-title{font-size:2rem;color:#f44336;margin-bottom:15px}
    .access-denied-text{font-size:1.2rem;margin-bottom:20px;opacity:0.8}
    .login-btn{padding:12px 25px;background:linear-gradient(45deg,#4CAF50,#45a049);color:white;border:none;border-radius:10px;cursor:pointer;font-size:16px;transition:all 0.3s ease;margin:5px}
    .security-modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.9);z-index:9999;backdrop-filter:blur(5px)}
    .security-modal.show{display:flex;justify-content:center;align-items:center}
    .security-modal-content{background:rgba(255,255,255,0.95);padding:30px;border-radius:15px;max-width:500px;width:90%;color:#003366;text-align:center;animation:modalSlideIn 0.5s ease}
    @keyframes modalSlideIn{from{opacity:0;transform:scale(0.8)}to{opacity:1;transform:scale(1)}}
    .security-icon{font-size:3rem;margin-bottom:15px}
    .security-title{font-size:1.5rem;margin-bottom:15px;font-weight:bold}
    .security-text{margin-bottom:20px;line-height:1.5}
    .attempt-counter{background:rgba(255,193,7,0.2);border:1px solid rgba(255,193,7,0.5);color:#f57c00;padding:10px;border-radius:8px;margin:15px 0;font-weight:bold}
    .security-buttons{display:flex;gap:10px;justify-content:center;flex-wrap:wrap}
    .modal-btn{padding:10px 20px;border:none;border-radius:8px;cursor:pointer;font-weight:500;transition:all 0.3s ease}
    .modal-btn-primary{background:#4CAF50;color:white}
    .modal-btn-secondary{background:#2196F3;color:white}
    .modal-btn-danger{background:#f44336;color:white}
    .modal-btn:hover{transform:translateY(-2px);box-shadow:0 5px 15px rgba(0,0,0,0.3)}
    @media (max-width:600px){
      .nav-bar{flex-direction:column;gap:15px;padding:15px}
      .nav-links{order:1;justify-content:center;width:100%}
      .nav-user{order:2;width:100%;justify-content:space-between}
      .nav-link{padding:10px 15px;font-size:14px}
      .nav-admin{padding:10px 15px;font-size:14px;display:inline-flex;align-items:center}
      .container{padding:15px;margin:10px}
      .security-buttons{flex-direction:column}
      .modal-btn{width:100%}
    }
  </style>
</head>
<body>
  <!-- Security Modal -->
  <div id="securityModal" class="security-modal">
    <div class="security-modal-content">
      <div class="security-icon" id="securityIcon">‚ö†Ô∏è</div>
      <div class="security-title" id="securityTitle">Security Warning</div>
      <div class="security-text" id="securityText">We detected you trying to access developer tools.</div>
      <div class="attempt-counter" id="attemptCounter">Attempts: <span id="attemptCount">1</span>/3</div>
      <div class="security-buttons">
        <button class="modal-btn modal-btn-primary" onclick="acknowledgeWarning()">I Understand</button>
        <button class="modal-btn modal-btn-secondary" onclick="resetPage()">Reset Page</button>
        <button class="modal-btn modal-btn-danger" onclick="learnMore()">Learn More</button>
      </div>
    </div>
  </div>

  <!-- Access Denied -->
  <div id="accessDenied" class="access-denied" style="display:none">
    <div class="access-denied-content">
      <div class="access-denied-icon">üîí</div>
      <div class="access-denied-title">Login Required</div>
      <div class="access-denied-text">You need to login to access PLCR Calculator.<br>Please login with your KNPC credentials.</div>
      <button class="login-btn" onclick="goToLogin()">Go to Login</button>
    </div>
  </div>

  <!-- Main Content -->
  <div id="mainContent">
    <div class="nav-bar">
      <div class="nav-logo">Tank Tools</div>
      <div class="nav-links">
        <a class="nav-link" href="index.html">PBCR</a>
        <a class="nav-link active" href="plcr.html">PLCR</a>
        <a class="nav-link" href="NMOGASBL.html">NMOGAS</a>
        <a class="nav-link" href="live-tanks.html" id="live-tanks-btn" style="display:none">üî¥ Live Tanks</a>
        <a class="nav-admin" href="dashboard.html" id="adminLink" style="display:none">üîê Dashboard</a>
      </div>
      <div class="nav-user" id="navUser">
        <div class="font-controls">
          <button class="font-btn" onclick="decreaseFontSize()" title="ÿ™ÿµÿ∫Ÿäÿ± ÿßŸÑÿÆÿ∑">-</button>
          <button class="font-btn" onclick="increaseFontSize()" title="ÿ™ŸÉÿ®Ÿäÿ± ÿßŸÑÿÆÿ∑">+</button>
        </div>
        <div class="user-avatar" id="userAvatar">U</div>
        <div id="userName">User</div>
        <button class="logout-btn" onclick="logout()">Logout</button>
      </div>
    </div>

    <div class="container">
      <h2>PLCR - Tank Calculator</h2>
      
      <label for="mode">Select Mode:</label>
      <select id="mode">
        <option value="levelToBarrels">Level to Barrels</option>
        <option value="barrelsToLevel">Barrels to Level</option>
        <option value="tonToLevel">Metric Ton to Level</option>
        <option value="levelToTon">Level to Metric Ton</option>
      </select>
      
      <label for="tk">Tank Number:</label>
      <input type="number" id="tk" placeholder="e.g. 424" oninput="calculate()">

      <label id="inputLabel" for="value">Enter Value:</label>
      <input type="number" id="value" placeholder="Enter number" oninput="calculate()">

      <div class="result" id="result"></div>
      
      <!-- ÿßŸÑÿ≠ŸÇŸàŸÑ ÿßŸÑÿ¨ÿØŸäÿØÿ© ŸÑŸÑŸàÿ∂ÿπ ÿßŸÑŸÖÿ™ŸÇÿØŸÖ -->
      <div id="advancedFields" style="display:none;">
        <div id="currentWeight" style="margin:10px 0;font-weight:bold;color:#00ffff;text-align:center;padding:10px;background:rgba(0,0,0,0.3);border-radius:8px;"></div>
        
        <label for="amountToWithdraw">Request Quantity (MT):</label>
        <input type="number" id="amountToWithdraw" placeholder="Enter amount to withdraw" oninput="calculateAdvanced()">
        
        <label for="withdrawalRate">Rate (MT/hr):</label>
        <input type="number" id="withdrawalRate" placeholder="Enter withdrawal rate" oninput="calculateAdvanced()">
        
        <div id="finalLevel" style="margin:10px 0;font-weight:bold;text-align:center;padding:10px;background:rgba(0,0,0,0.3);border-radius:8px;"></div>
        <div id="timeNeeded" style="margin:10px 0;font-weight:bold;text-align:center;padding:10px;background:rgba(0,0,0,0.3);border-radius:8px;"></div>
        <div id="finishTime" style="margin:10px 0;font-weight:bold;text-align:center;padding:10px;background:rgba(0,0,0,0.3);border-radius:8px;"></div>
      </div>
      
      <!-- ÿßŸÑÿ£ÿ≤ÿ±ÿßÿ± ÿßŸÑÿ¨ÿØŸäÿØÿ© -->
      <div id="buttonsSection" style="display:none;margin-top:20px;">
        <button id="addToLiveTanksBtn" onclick="showAddToLiveTanksModal()" style="background:linear-gradient(45deg,#f44336,#d32f2f);color:white;border:none;padding:12px 20px;border-radius:8px;cursor:pointer;margin:5px;font-weight:bold;transition:all 0.3s ease;width:100%;">üî¥ Add to Live Tanks</button>
        <button id="addReminderBtn" onclick="addReminder()" style="background:linear-gradient(45deg,#2196F3,#1976D2);color:white;border:none;padding:12px 20px;border-radius:8px;cursor:pointer;margin:5px;font-weight:bold;transition:all 0.3s ease;width:100%;">üìÖ Add Reminder</button>
        <button id="addToTableBtn" onclick="addToPersonalTable()" style="background:linear-gradient(45deg,#4CAF50,#388E3C);color:white;border:none;padding:12px 20px;border-radius:8px;cursor:pointer;margin:5px;font-weight:bold;transition:all 0.3s ease;width:100%;">üìä Add to Table</button>
      </div>
      
      <!-- ÿßŸÑÿ¨ÿØŸàŸÑ ÿßŸÑÿ¥ÿÆÿµŸä -->
      <div id="personalTable" style="display:none;margin-top:20px;">
        <h3 style="color:#00ffff;text-align:center;margin-bottom:15px;">Your tanks finishing in current shift</h3>
        <div id="personalTableContent" style="background:rgba(0,0,0,0.3);border-radius:8px;padding:15px;max-height:300px;overflow-y:auto;"></div>
      </div>
    </div>
    
    <button id="darkModeButton" class="action-button" title="Dark Mode">üåô</button>
    
    <footer>
      By <a href="#" class="whatsapp-link" onclick="openWhatsApp(); return false;">Fahad - 17877</a> ‚Äì Version v4.2
      <br><small style="color:#999;font-size:10px;margin-top:5px;display:block">üì± WhatsApp: +965 55222550</small>
    </footer>
  </div>
  
  <script>
    // üîí Smart Security System - iPhone Optimized
    (function(){
      let attempts=0,modalOpen=false,isTyping=false,typingTimer=null;
      
      function initSecurity(){
        // Enhanced iPhone detection and typing tracking
        const isIPhone=/iPad|iPhone|iPod/.test(navigator.userAgent);
        
        // Multiple event listeners for comprehensive input tracking
        ['focusin','focus','input','keydown','keyup','touchstart'].forEach(eventType=>{
          document.addEventListener(eventType,e=>{
            if(e.target.matches('input,textarea,select')){
              isTyping=true;
              clearTimeout(typingTimer);
              typingTimer=setTimeout(()=>isTyping=false,isIPhone?1500:800);
            }
          },true);
        });
        
        // Additional safety for form interactions
        document.addEventListener('change',e=>{
          if(e.target.matches('input,textarea,select')){
            isTyping=true;
            clearTimeout(typingTimer);
            typingTimer=setTimeout(()=>isTyping=false,1000);
          }
        });
        
        // Enhanced event blocking when typing
        document.addEventListener('contextmenu',e=>{
          if(isTyping||e.target.matches('input,textarea,select')||e.target.closest('input,textarea,select'))return;
          handleViolation('context-menu')(e);
        });
        
        document.addEventListener('selectstart',e=>{
          if(isTyping||e.target.matches('input,textarea,select')||e.target.closest('input,textarea,select'))return;
          handleViolation('text-selection')(e);
        });
        
        document.addEventListener('keydown',e=>{
          if(isTyping||e.target.matches('input,textarea,select')||e.target.closest('input,textarea,select'))return;
          const dangerous=[(e.ctrlKey&&e.key==='u'),(e.ctrlKey&&e.key==='s'),(e.ctrlKey&&e.shiftKey&&e.key==='I'),(e.key==='F12'),(e.ctrlKey&&e.shiftKey&&e.key==='C'),(e.ctrlKey&&e.shiftKey&&e.key==='J')];
          if(dangerous.some(c=>c))handleViolation('keyboard-shortcut')(e);
        });
        
        // DevTools detection with typing check
        let devOpen=false;
        setInterval(()=>{
          if(isTyping)return;
          const threshold=160,wDiff=window.outerWidth-window.innerWidth,hDiff=window.outerHeight-window.innerHeight;
          if(wDiff>threshold||hDiff>threshold){
            if(!devOpen){devOpen=true;setTimeout(()=>{if(!isTyping)handleViolation('devtools-detected')()},500)}
          }else{devOpen=false}
        },isIPhone?5000:3000);
      }
      function handleViolation(type){
        return function(e){
          if(e&&e.preventDefault)e.preventDefault();
          attempts++;
          if(attempts===1)showWarning('first');
          else if(attempts===2)showWarning('second');
          else if(attempts>=3)showWarning('final');
          return false
        }
      }
      function showWarning(level){
        if(modalOpen)return;
        const modal=document.getElementById('securityModal'),icon=document.getElementById('securityIcon'),title=document.getElementById('securityTitle'),text=document.getElementById('securityText'),counter=document.getElementById('attemptCounter'),countSpan=document.getElementById('attemptCount');
        modalOpen=true;countSpan.textContent=attempts;
        if(level==='first'){
          icon.textContent='üëÄ';title.textContent='Security Notice';
          text.innerHTML='<p>We noticed you tried to access developer tools on PLCR Calculator.</p><p><strong>If this was accidental:</strong> No problem! Click "I Understand" to continue.</p><p><strong>Note:</strong> This calculator contains KNPC tank conversion data.</p>';
          counter.style.background='rgba(33,150,243,0.2)';counter.style.borderColor='rgba(33,150,243,0.5)';counter.style.color='#2196F3'
        }else if(level==='second'){
          icon.textContent='‚ö†Ô∏è';title.textContent='Security Warning';
          text.innerHTML='<p><strong>Second attempt detected on PLCR Calculator.</strong></p><p>Please note this system contains:</p><ul style="text-align:left;margin:10px 0"><li>Proprietary tank conversion algorithms</li><li>KNPC operational data</li><li>Protected calculation methods</li></ul><p>One more attempt will activate security measures.</p>';
          counter.style.background='rgba(255,193,7,0.2)';counter.style.borderColor='rgba(255,193,7,0.5)';counter.style.color='#ffc107'
        }else{
          icon.textContent='üö´';title.textContent='PLCR Security Lock';
          text.innerHTML='<p><strong>Maximum attempts exceeded on PLCR Calculator.</strong></p><p>Enhanced monitoring activated for:</p><ul style="text-align:left;margin:10px 0"><li>Tank calculation protection</li><li>KNPC data security</li><li>System integrity maintenance</li></ul><p>Use "Reset Page" to continue normally.</p>';
          counter.style.background='rgba(244,67,54,0.2)';counter.style.borderColor='rgba(244,67,54,0.5)';counter.style.color='#f44336';
          setTimeout(()=>{if(attempts>=3)implementRestrictions()},5000)
        }
        modal.classList.add('show')
      }
      function implementRestrictions(){
        document.body.style.filter='blur(3px)';
        const overlay=document.createElement('div');
        overlay.innerHTML='<div style="position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.7);color:white;display:flex;flex-direction:column;justify-content:center;align-items:center;z-index:10000;text-align:center;padding:20px"><div style="font-size:4rem;margin-bottom:20px">‚öóÔ∏è</div><h2 style="color:#FFD700;margin-bottom:15px">PLCR Calculator Protected</h2><p style="margin-bottom:30px;max-width:500px;line-height:1.5">Security monitoring active for tank conversion calculations and KNPC operational data.</p><button onclick="window.location.reload()" style="padding:12px 24px;background:#FFD700;color:#003366;border:none;border-radius:8px;cursor:pointer;font-size:16px;font-weight:bold">üîÑ Reset Calculator</button></div>';
        document.body.appendChild(overlay)
      }
      window.acknowledgeWarning=()=>{document.getElementById('securityModal').classList.remove('show');modalOpen=false;showMessage(attempts>=3?'‚ö†Ô∏è Enhanced monitoring active':'‚úÖ Continue using PLCR normally','success')};
      window.resetPage=()=>window.location.reload();
      window.learnMore=()=>{showMessage('üîí PLCR protects KNPC tank conversion data and calculation algorithms. Contact Fahad - 17877 for support.','info');document.getElementById('securityModal').classList.remove('show');modalOpen=false};
      initSecurity()
    })();

    // PLCR Application - Compact Version
    const WHATSAPP_NUMBER="96555222550";
    let currentUser=null;
    
    // Tank conversion data (compressed)
    const tankConversions={"101":{factor:0.206,gross:7.746},"204":{factor:0.605,gross:7.266},"255":{factor:1.528,gross:9.047},"256":{factor:1.528,gross:9.047},"272":{factor:0.759,gross:9.506},"273":{factor:0.437,gross:9.506},"274":{factor:0.437,gross:9.506},"275":{factor:0.999,gross:8.874},"281":{factor:0.282,gross:7.881},"282":{factor:0.282,gross:7.881},"424":{factor:2.272,gross:9.843},"425":{factor:2.414,gross:9.047},"426":{factor:2.414,gross:9.047},"456":{factor:1.321,gross:8.873},"460":{factor:1.640,gross:8.860},"461":{factor:1.640,gross:8.860},"462":{factor:1.494,gross:8.874},"467":{factor:1.358,gross:9.054},"468":{factor:1.358,gross:9.054},"469":{factor:1.358,gross:9.054},"470":{factor:1.358,gross:9.054},"521":{factor:0.508,gross:8.168},"522":{factor:1.476,gross:8.168},"531":{factor:1.506,gross:8.168},"532":{factor:1.506,gross:8.168},"533":{factor:1.506,gross:8.168},"534":{factor:1.506,gross:8.168},"600":{factor:1.227,gross:7.736},"601":{factor:1.227,gross:7.736},"603":{factor:1.519,gross:7.700},"620":{factor:4.560,gross:7.640},"621":{factor:4.560,gross:7.640},"622":{factor:0.645,gross:7.764},"664":{factor:0.914,gross:7.727},"665":{factor:0.914,gross:7.727},"668":{factor:2.154,gross:7.740},"669":{factor:2.154,gross:7.740},"670":{factor:2.154,gross:7.740},"671":{factor:2.011,gross:7.830},"672":{factor:2.011,gross:7.830},"702":{factor:1.917,gross:6.763},"703":{factor:1.917,gross:6.763},"757":{factor:1.626,gross:7.000},"758":{factor:3.040,gross:6.787},"833":{factor:0.960,gross:7.768},"834":{factor:0.960,gross:7.768},"302":{factor:0.860,gross:7.758},"301":{factor:0.860,gross:7.758},"835":{factor:0.960,gross:7.748},"836":{factor:0.960,gross:7.748}};

    // Core Functions
    window.addEventListener('load',()=>checkLoginStatus());
    
    function checkLoginStatus(){
      const session=sessionStorage.getItem('tanktools_session'),userData=localStorage.getItem('tanktools_current_user');
      if(session!=='active'||!userData){showAccessDenied();return}
      try{currentUser=JSON.parse(userData);initializeApp();logActivity('plcr_accessed',currentUser.username)}catch{showAccessDenied()}
    }
    
    function showAccessDenied(){document.getElementById('mainContent').style.display='none';document.getElementById('accessDenied').style.display='flex'}
    
    window.goToLogin=()=>{sessionStorage.setItem('tanktools_redirect','plcr.html');window.location.href='login.html'};
    
    function initializeApp(){
      document.getElementById('mainContent').style.display='block';
      document.getElementById('accessDenied').style.display='none';
      loadUserInfo();loadDataFromLocalStorage();setupDarkMode()
    }
    
    function loadUserInfo(){
      if(!currentUser)return;
      
      const userNameElement = document.getElementById('userName');
      const userAvatarElement = document.getElementById('userAvatar');
      const adminLinkElement = document.getElementById('adminLink');
      const liveTanksLinkElement = document.getElementById('live-tanks-btn');
      
      if(userNameElement) {
        userNameElement.textContent = currentUser.username;
      }
      
      if(userAvatarElement) {
        userAvatarElement.textContent = (currentUser.fullName||currentUser.username).charAt(0).toUpperCase();
      }
      
      if(adminLinkElement && (currentUser.username==='fam030'||currentUser.role==='admin')) {
        adminLinkElement.style.display='inline-block';
      }
      
      // Show Live Tanks link for allowed roles
      const allowedRoles = ["admin", "panel_operator", "supervisor", "section_head", "operator", "planning"];
      if(liveTanksLinkElement && allowedRoles.includes(currentUser.role)) {
        liveTanksLinkElement.style.display='inline-block';
      }
    }
    
    window.logout=()=>{logActivity('user_logout',currentUser.username);sessionStorage.removeItem('tanktools_session');localStorage.removeItem('tanktools_current_user');window.location.href='login.html'};
    
    function showMessage(message,type){
      const div=document.createElement('div');
      div.innerHTML=message;
      div.style.cssText=`position:fixed;top:20px;right:20px;background:${type==='success'?'#4CAF50':type==='warning'?'#ff9800':'#2196F3'};color:white;padding:15px 20px;border-radius:8px;z-index:10000;max-width:400px;box-shadow:0 4px 12px rgba(0,0,0,0.3)`;
      document.body.appendChild(div);
      setTimeout(()=>div.remove(),5000)
    }

    const modeSelect=document.getElementById("mode"),inputLabel=document.getElementById("inputLabel");
    
    modeSelect.addEventListener("change",()=>{
      const mode=modeSelect.value;
      const labelMap={levelToBarrels:"Current Level:",barrelsToLevel:"Current Barrels:",tonToLevel:"Weight (MT):",levelToTon:"Current Level:"};
      inputLabel.textContent=labelMap[mode]||"Enter value:";
      calculate()
    });

    window.calculate=()=>{
      const tk=document.getElementById("tk").value.trim(),value=parseFloat(document.getElementById("value").value),resultDiv=document.getElementById("result");
      if(!tankConversions[tk]){resultDiv.textContent="Tank number not found in database.";return}
      const tank=tankConversions[tk],mode=modeSelect.value;
      let metricTon,barrels,level;
      switch(mode){
        case "levelToBarrels":
          metricTon=value*tank.factor;barrels=metricTon*tank.gross;
          resultDiv.textContent=`Weight: ${metricTon.toFixed(2)} MT | Barrels: ${barrels.toFixed(2)} BBL`;
          break;
        case "barrelsToLevel":
          metricTon=value/tank.gross;level=metricTon/tank.factor;
          resultDiv.textContent=`Weight: ${metricTon.toFixed(2)} MT | Approx. Level: ${level.toFixed(2)}`;
          break;
        case "tonToLevel":
          level=value/tank.factor;
          resultDiv.textContent=`Approx. Level: ${level.toFixed(2)}`;
          break;
        case "levelToTon":
          metricTon=value*tank.factor;
          resultDiv.textContent=`Weight: ${metricTon.toFixed(2)} MT`;
          break;
        default:
          resultDiv.textContent="Please select a valid mode and enter data."
      }
      saveDataToLocalStorage();
      logActivity('plcr_calculation',currentUser.username)
    };
    
    function saveDataToLocalStorage(){
      const data = {
        tk: document.getElementById("tk").value,
        value: document.getElementById("value").value,
        mode: document.getElementById("mode").value,
        // ÿ≠ŸÅÿ∏ ÿßŸÑÿ≠ŸÇŸàŸÑ ÿßŸÑÿ¨ÿØŸäÿØÿ©
        currentLevel: document.getElementById("currentLevel") ? document.getElementById("currentLevel").value : '',
        amountToWithdraw: document.getElementById("amountToWithdraw") ? document.getElementById("amountToWithdraw").value : '',
        withdrawalRate: document.getElementById("withdrawalRate") ? document.getElementById("withdrawalRate").value : ''
      };
      localStorage.setItem('plcrData', JSON.stringify(data));
    }

    function loadDataFromLocalStorage(){
      const dataStr = localStorage.getItem('plcrData');
      if(dataStr){
        const data = JSON.parse(dataStr);
        
        // ÿßÿ≥ÿ™ÿ±ÿ¨ÿßÿπ ÿßŸÑÿ≠ŸÇŸàŸÑ ÿßŸÑÿ£ÿ≥ÿßÿ≥Ÿäÿ©
        document.getElementById("tk").value = data.tk || '';
        document.getElementById("value").value = data.value || '';
        document.getElementById("mode").value = data.mode || 'levelToBarrels';
        
        // ÿßÿ≥ÿ™ÿ±ÿ¨ÿßÿπ ÿßŸÑÿ≠ŸÇŸàŸÑ ÿßŸÑÿ¨ÿØŸäÿØÿ©
        if (document.getElementById("currentLevel")) {
          document.getElementById("currentLevel").value = data.currentLevel || '';
        }
        if (document.getElementById("amountToWithdraw")) {
          document.getElementById("amountToWithdraw").value = data.amountToWithdraw || '';
        }
        if (document.getElementById("withdrawalRate")) {
          document.getElementById("withdrawalRate").value = data.withdrawalRate || '';
        }
        
        const mode = data.mode;
        const labelMap = {
          levelToBarrels: "Current Level:",
          barrelsToLevel: "Current Barrels:",
          tonToLevel: "Weight (MT):",
          levelToTon: "Current Level:"
        };
        inputLabel.textContent = labelMap[mode] || "Enter value:";
        
        // ÿ•ÿπÿßÿØÿ© ÿ≠ÿ≥ÿßÿ® ÿßŸÑŸÜÿ™ÿßÿ¶ÿ¨ ÿ•ÿ∞ÿß ŸÉÿßŸÜÿ™ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ŸÖÿ™ŸàŸÅÿ±ÿ©
        if(data.tk && data.value) {
          calculate();
        }
      }
    }

    window.openWhatsApp=()=>{
      const message="ŸÖÿ±ÿ≠ÿ®ÿßÿå ÿ£ÿ™ŸàÿßÿµŸÑ ŸÖÿπŸÉ ŸÖŸÜ ÿÆŸÑÿßŸÑ ÿ™ÿ∑ÿ®ŸäŸÇ PLCR Tank Calculator",whatsappURL=`https://wa.me/${WHATSAPP_NUMBER}?text=${encodeURIComponent(message)}`;
      try{const newWindow=window.open(whatsappURL,'_blank','noopener,noreferrer');if(!newWindow)window.location.href=whatsappURL}
      catch{navigator.clipboard.writeText(whatsappURL).then(()=>alert(`ÿ™ŸÖ ŸÜÿ≥ÿÆ ÿ±ÿßÿ®ÿ∑ ÿßŸÑŸàÿßÿ™ÿ≥ÿßÿ®:\n${whatsappURL}`)).catch(()=>alert(`ÿ±ÿßÿ®ÿ∑ ÿßŸÑŸàÿßÿ™ÿ≥ÿßÿ®:\n${whatsappURL}`))}
    };

    function setupDarkMode(){
      let isDarkMode=localStorage.getItem('darkMode')==='true';
      const darkModeButton=document.getElementById('darkModeButton');
      function updateColorMode(){
        if(isDarkMode){document.body.classList.add('dark-mode');darkModeButton.innerHTML='‚òÄÔ∏è'}
        else{document.body.classList.remove('dark-mode');darkModeButton.innerHTML='üåô'}
      }
      darkModeButton.addEventListener('click',()=>{isDarkMode=!isDarkMode;localStorage.setItem('darkMode',isDarkMode);updateColorMode()});
      updateColorMode()
    }

    function logActivity(action,username){
      const activities=JSON.parse(localStorage.getItem('tanktools_activities')||'[]');
      activities.unshift({id:Date.now(),action,username,timestamp:new Date().toISOString(),ip:'local',userAgent:navigator.userAgent.substring(0,100)});
      activities.splice(100);
      localStorage.setItem('tanktools_activities',JSON.stringify(activities))
    }
    
    // Auto-save and PWA - ÿ™ÿ≠ÿØŸäÿ´ ŸÑÿ≠ŸÅÿ∏ ÿ¨ŸÖŸäÿπ ÿßŸÑÿ≠ŸÇŸàŸÑ
    document.addEventListener('input', e => {
      if(e.target.matches('#tk,#value,#currentLevel,#amountToWithdraw,#withdrawalRate')) {
        saveDataToLocalStorage();
      }
    });
    
    // ÿ≠ŸÅÿ∏ ÿπŸÜÿØ ÿ™ÿ∫ŸäŸäÿ± ÿßŸÑŸàÿ∂ÿπ
    document.addEventListener('change', e => {
      if(e.target.matches('#mode')) {
        saveDataToLocalStorage();
      }
    });
    
    if('serviceWorker' in navigator) {
      window.addEventListener('load', () => navigator.serviceWorker.register('/sw.js'));
    }
    
    // Font size control functions
    let currentFontSize = parseInt(localStorage.getItem('tanktools_font_size_plcr') || '16');
    
    function increaseFontSize() {
      if (currentFontSize < 24) {
        currentFontSize += 2;
        applyFontSize();
        localStorage.setItem('tanktools_font_size_plcr', currentFontSize);
        showFontMessage(`üìà Font size increased to ${currentFontSize}px`);
      }
    }
    
    function decreaseFontSize() {
      if (currentFontSize > 12) {
        currentFontSize -= 2;
        applyFontSize();
        localStorage.setItem('tanktools_font_size_plcr', currentFontSize);
        showFontMessage(`üìâ Font size decreased to ${currentFontSize}px`);
      }
    }
    
    function applyFontSize() {
      const style = document.createElement('style');
      style.id = 'dynamic-font-style';
      
      const existingStyle = document.getElementById('dynamic-font-style');
      if (existingStyle) {
        existingStyle.remove();
      }
      
      style.textContent = `
        input, select { font-size: ${currentFontSize}px !important; }
        label { font-size: ${currentFontSize}px !important; }
        .result { font-size: ${currentFontSize}px !important; }
        h2 { font-size: ${currentFontSize + 8}px !important; }
        .container { font-size: ${currentFontSize}px !important; }
      `;
      
      document.head.appendChild(style);
    }
    
    function showFontMessage(message) {
      const msgDiv = document.createElement('div');
      msgDiv.style.cssText = 'position:fixed;top:80px;right:20px;background:rgba(76,175,80,0.9);color:white;padding:10px 15px;border-radius:8px;font-size:12px;z-index:1000;animation:slideIn 0.3s ease';
      msgDiv.textContent = message;
      document.body.appendChild(msgDiv);
      setTimeout(() => msgDiv.remove(), 3000);
    }
    
    // Apply saved font size on page load
    applyFontSize();
    
    window.increaseFontSize = increaseFontSize;
    window.decreaseFontSize = decreaseFontSize;

    // ÿ•ÿ∂ÿßŸÅÿ© ÿßŸÑŸàÿ∏ÿßÿ¶ŸÅ ÿßŸÑÿ¨ÿØŸäÿØÿ© ŸÑŸÄ PLCR
    let calcData = null;

    // ÿ™ÿ≠ÿØŸäÿ´ ÿØÿßŸÑÿ© calculate ŸÑÿ™ÿ¥ŸÖŸÑ ÿßŸÑÿ≠ŸÇŸàŸÑ ÿßŸÑÿ¨ÿØŸäÿØÿ©
    const originalCalculate = window.calculate;
    window.calculate = () => {
      originalCalculate();
      
      const mode = document.getElementById('mode').value;
      const advancedFields = document.getElementById('advancedFields');
      const buttonsSection = document.getElementById('buttonsSection');
      const personalTable = document.getElementById('personalTable');
      
      // ÿ•ÿ∏Ÿáÿßÿ± ÿßŸÑÿ≠ŸÇŸàŸÑ ÿßŸÑÿ¨ÿØŸäÿØÿ© ŸÅŸÇÿ∑ ŸÅŸä Ÿàÿ∂ÿπ Level to Metric Ton
      if (mode === 'levelToTon') {
        advancedFields.style.display = 'block';
        buttonsSection.style.display = 'block';
        personalTable.style.display = 'block';
        
        // ÿ≠ÿ≥ÿßÿ® ÿßŸÑŸàÿ≤ŸÜ ÿßŸÑÿ≠ÿßŸÑŸä
        const tk = document.getElementById("tk").value.trim();
        const currentLevel = parseFloat(document.getElementById("value").value);
        
        if (tankConversions[tk] && !isNaN(currentLevel)) {
          const tank = tankConversions[tk];
          const currentWeight = currentLevel * tank.factor;
          
          // ÿπÿ±ÿ∂ ÿßŸÑŸàÿ≤ŸÜ ÿßŸÑÿ≠ÿßŸÑŸä ŸÅŸä ÿßŸÑÿπŸÜÿµÿ± ÿßŸÑŸÖÿÆÿµÿµ
          document.getElementById('currentWeight').textContent = `Current Weight: ${currentWeight.toFixed(2)} MT`;
          
          // ÿ≠ÿ≥ÿßÿ® ŸÖÿ™ŸÇÿØŸÖ ÿ•ÿ∞ÿß ÿ™ŸÖ ÿ•ÿØÿÆÿßŸÑ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™
          calculateAdvanced();
        }
      } else {
        advancedFields.style.display = 'none';
        buttonsSection.style.display = 'none';
        personalTable.style.display = 'none';
      }
      
      // ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑÿ¨ÿØŸàŸÑ ÿßŸÑÿ¥ÿÆÿµŸä
      updatePersonalTable();
    };

    // ÿØÿßŸÑÿ© ÿßŸÑÿ≠ÿ≥ÿßÿ® ÿßŸÑŸÖÿ™ŸÇÿØŸÖ
    window.calculateAdvanced = () => {
      const tk = document.getElementById("tk").value.trim();
      const currentLevel = parseFloat(document.getElementById("value").value);
      const amountToWithdraw = parseFloat(document.getElementById("amountToWithdraw").value);
      const withdrawalRate = parseFloat(document.getElementById("withdrawalRate").value);
      
      if (!tankConversions[tk] || isNaN(currentLevel) || isNaN(amountToWithdraw) || isNaN(withdrawalRate)) {
        document.getElementById('finalLevel').textContent = '';
        document.getElementById('timeNeeded').textContent = '';
        document.getElementById('finishTime').textContent = '';
        return;
      }
      
      const tank = tankConversions[tk];
      const currentWeight = currentLevel * tank.factor;
      const finalWeight = currentWeight - amountToWithdraw;
      const finalLevel = finalWeight / tank.factor;
      const timeNeededHours = amountToWithdraw / withdrawalRate;
      
      // ÿ≠ÿ≥ÿßÿ® ŸàŸÇÿ™ ÿßŸÑÿßŸÜÿ™Ÿáÿßÿ°
      const now = new Date();
      const finishTime = new Date(now.getTime() + timeNeededHours * 60 * 60 * 1000);
      
      const hours = Math.floor(timeNeededHours);
      const minutes = Math.round((timeNeededHours - hours) * 60);
      
      const date = finishTime.toLocaleDateString('en-GB');
      const time = finishTime.toLocaleTimeString('en-GB', { hour12: false, hour: '2-digit', minute: '2-digit' });
      
      // ÿ™ÿ≠ÿØŸäÿØ ŸÑŸàŸÜ ÿßŸÑŸÜÿ™Ÿäÿ¨ÿ© ÿ®ŸÜÿßÿ°Ÿã ÿπŸÑŸâ ÿßŸÑÿ¥ŸÅÿ™
      const isCurrentShift = isSameShift(finishTime);
      const color = isCurrentShift ? '#ff4444' : '#44ff44';
      
      try {
        ft = `${date} ${time}`;
      } catch {
        ft = `${date} ${time}`;
      }
      
      document.getElementById('finalLevel').innerHTML = `<span style="color:${color}">Final Level: ${finalLevel.toFixed(2)} m</span>`;
      document.getElementById('timeNeeded').innerHTML = `<span style="color:${color}">Time Needed: ${hours}h ${minutes}min</span>`;
      document.getElementById('finishTime').innerHTML = `<span style="color:${color}">Finish Time: ${ft}</span>`;
      
      // ÿ≠ŸÅÿ∏ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ŸÑŸÑÿßÿ≥ÿ™ÿÆÿØÿßŸÖ ŸÅŸä ÿßŸÑÿ£ÿ≤ÿ±ÿßÿ±
      calcData = {
        tankNumber: tk,
        currentLevel: currentLevel,
        currentWeight: currentWeight,
        amountToWithdraw: amountToWithdraw,
        withdrawalRate: withdrawalRate,
        finalLevel: finalLevel,
        timeNeeded: timeNeededHours,
        finishTime: finishTime,
        finishTimeString: ft
      };
    };

    // ÿØÿßŸÑÿ© ÿ™ÿ≠ÿØŸäÿØ ÿßŸÑÿ¥ŸÅÿ™
    function isSameShift(targetTime) {
      const now = new Date();
      const currentHour = now.getHours();
      const targetHour = targetTime.getHours();
      
      let currentShift, targetShift;
      
      if (currentHour >= 6 && currentHour < 14) currentShift = 'morning';
      else if (currentHour >= 14 && currentHour < 22) currentShift = 'afternoon';
      else currentShift = 'night';
      
      if (targetHour >= 6 && targetHour < 14) targetShift = 'morning';
      else if (targetHour >= 14 && targetHour < 22) targetShift = 'afternoon';
      else targetShift = 'night';
      
      return currentShift === targetShift && now.toDateString() === targetTime.toDateString();
    }

    // ÿØÿßŸÑÿ© ÿ•ÿ∂ÿßŸÅÿ© ÿ™ÿ∞ŸÉŸäÿ±
    window.addReminder = () => {
      if (!calcData) {
        alert('Please complete the calculation first');
        return;
      }
      
      const title = `Tank ${calcData.tankNumber} - Withdrawal Complete`;
      const details = `Tank: ${calcData.tankNumber}\\nWithdrawal: ${calcData.amountToWithdraw} MT\\nFinal Level: ${calcData.finalLevel.toFixed(2)} m`;
      const startDate = calcData.finishTime.toISOString().replace(/[-:]/g, '').split('.')[0] + 'Z';
      const endDate = new Date(calcData.finishTime.getTime() + 30 * 60 * 1000).toISOString().replace(/[-:]/g, '').split('.')[0] + 'Z';
      
      const googleCalendarUrl = `https://calendar.google.com/calendar/render?action=TEMPLATE&text=${encodeURIComponent(title)}&dates=${startDate}/${endDate}&details=${encodeURIComponent(details)}`;
      
      window.open(googleCalendarUrl, '_blank');
    };

    // ÿØÿßŸÑÿ© ÿ•ÿ∂ÿßŸÅÿ© ŸÑŸÑÿ¨ÿØŸàŸÑ ÿßŸÑÿ¥ÿÆÿµŸä
    window.addToPersonalTable = () => {
      if (!calcData) {
        alert('Please complete the calculation first');
        return;
      }
      
      const personalData = JSON.parse(localStorage.getItem('plcr_personal_table') || '[]');
      const newEntry = {
        id: Date.now(),
        tankNumber: calcData.tankNumber,
        currentLevel: calcData.currentLevel,
        amountToWithdraw: calcData.amountToWithdraw,
        finalLevel: calcData.finalLevel,
        finishTime: calcData.finishTimeString,
        timestamp: new Date().toISOString()
      };
      
      personalData.unshift(newEntry);
      personalData.splice(10); // Keep only last 10 entries
      localStorage.setItem('plcr_personal_table', JSON.stringify(personalData));
      
      updatePersonalTable();
      alert('Added to personal table successfully!');
    };

    // ÿØÿßŸÑÿ© ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑÿ¨ÿØŸàŸÑ ÿßŸÑÿ¥ÿÆÿµŸä
    function updatePersonalTable() {
      const personalData = JSON.parse(localStorage.getItem('plcr_personal_table') || '[]');
      const tableContent = document.getElementById('personalTableContent');
      
      if (personalData.length === 0) {
        tableContent.innerHTML = '<p style="text-align:center;color:#999;padding:20px;">No entries yet</p>';
        return;
      }
      
      let html = '';
      personalData.forEach((entry, index) => {
        const isCurrentShift = isSameShift(new Date(entry.timestamp));
        const color = isCurrentShift ? '#ff4444' : '#44ff44';
        const bgColor = isCurrentShift ? 'rgba(255,68,68,0.1)' : 'rgba(68,255,68,0.1)';
        
        html += `
          <div style="
            background: ${bgColor};
            border: 1px solid ${color}40;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            position: relative;
            transition: all 0.3s ease;
          " onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(0,0,0,0.3)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none'">
            
            <!-- ÿ≤ÿ± ÿßŸÑŸÖÿ≥ÿ≠ -->
            <button onclick="removeFromPersonalTable(${index})" style="
              position: absolute;
              top: 10px;
              right: 10px;
              background: rgba(255,0,0,0.8);
              color: white;
              border: none;
              border-radius: 50%;
              width: 25px;
              height: 25px;
              cursor: pointer;
              font-size: 14px;
              font-weight: bold;
              display: flex;
              align-items: center;
              justify-content: center;
              transition: all 0.3s ease;
            " onmouseover="this.style.background='rgba(255,0,0,1)'; this.style.transform='scale(1.1)'" onmouseout="this.style.background='rgba(255,0,0,0.8)'; this.style.transform='scale(1)'">√ó</button>
            
            <!-- ŸÖÿπŸÑŸàŸÖÿßÿ™ ÿßŸÑÿÆÿ≤ÿßŸÜ -->
            <div style="margin-right: 35px;">
              <div style="
                color: ${color};
                font-weight: bold;
                font-size: 16px;
                margin-bottom: 8px;
                display: flex;
                align-items: center;
                gap: 8px;
              ">
                <span style="
                  background: ${color};
                  color: white;
                  padding: 2px 8px;
                  border-radius: 12px;
                  font-size: 12px;
                  font-weight: bold;
                ">üõ¢Ô∏è</span>
                Tank ${entry.tankNumber}
              </div>
              
              <div style="
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 8px;
                font-size: 12px;
                color: #ccc;
                margin-bottom: 8px;
              ">
                <div>
                  <span style="color: #00ffff;">üìä Level:</span><br>
                  <span style="font-weight: bold;">${entry.currentLevel}m ‚Üí ${entry.finalLevel.toFixed(2)}m</span>
                </div>
                <div>
                  <span style="color: #00ffff;">‚öñÔ∏è Withdrawal:</span><br>
                  <span style="font-weight: bold;">${entry.amountToWithdraw} MT</span>
                </div>
              </div>
              
              <div style="
                background: rgba(0,0,0,0.3);
                padding: 8px;
                border-radius: 5px;
                border-left: 3px solid ${color};
              ">
                <span style="color: #00ffff;">‚è∞ Finish:</span>
                <span style="font-weight: bold; color: ${color};">${entry.finishTime}</span>
              </div>
            </div>
          </div>
        `;
      });
      
      tableContent.innerHTML = html;
    }

    // ÿØÿßŸÑÿ© ŸÖÿ≥ÿ≠ ÿÆÿ≤ÿßŸÜ ŸÖŸÜ ÿßŸÑÿ¨ÿØŸàŸÑ ÿßŸÑÿ¥ÿÆÿµŸä
    window.removeFromPersonalTable = (index) => {
      if (confirm('Are you sure you want to remove this tank from the table?')) {
        const personalData = JSON.parse(localStorage.getItem('plcr_personal_table') || '[]');
        personalData.splice(index, 1);
        localStorage.setItem('plcr_personal_table', JSON.stringify(personalData));
        updatePersonalTable();
        
        // ÿ±ÿ≥ÿßŸÑÿ© ÿ™ÿ£ŸÉŸäÿØ
        const msgDiv = document.createElement('div');
        msgDiv.style.cssText = 'position:fixed;top:80px;right:20px;background:rgba(76,175,80,0.9);color:white;padding:10px 15px;border-radius:8px;font-size:12px;z-index:1000;animation:slideIn 0.3s ease';
        msgDiv.textContent = '‚úÖ Tank removed successfully!';
        document.body.appendChild(msgDiv);
        setTimeout(() => msgDiv.remove(), 3000);
      }
    };

    // ÿØÿßŸÑÿ© ÿ•ÿ∏Ÿáÿßÿ± ŸÜÿßŸÅÿ∞ÿ© Add to Live Tanks
    window.showAddToLiveTanksModal = () => {
      if (!calcData) {
        alert('Please complete the calculation first');
        return;
      }
      
      // ŸÅÿ≠ÿµ ÿßŸÑÿµŸÑÿßÿ≠Ÿäÿßÿ™
      if (!currentUser || !hasPermission(currentUser.role, 'add_to_live_tanks')) {
        alert('You do not have permission to add to Live Tanks');
        return;
      }
      
      // ÿ•ŸÜÿ¥ÿßÿ° ÿßŸÑŸÜÿßŸÅÿ∞ÿ© ÿßŸÑŸÖŸÜÿ®ÿ´ŸÇÿ©
      const modal = document.createElement('div');
      modal.id = 'addToLiveTanksModal';
      modal.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.8);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 10000;
        backdrop-filter: blur(5px);
      `;
      
      const products = ["NAPHA", "PCNA", "HSD-EGO", "EGO", "F.OIL", "MOGAS", "VGO", "KKERO", "ARDR", "METHANOL", "OTHER"];
      let productOptions = '';
      products.forEach(product => {
        productOptions += `<option value="${product}">${product}</option>`;
      });
      
      modal.innerHTML = `
        <div style="background: rgba(255,255,255,0.95); padding: 30px; border-radius: 15px; max-width: 500px; width: 90%; color: #003366;">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <h3 style="margin: 0; color: #f44336;">üî¥ Add to Live Tanks</h3>
            <button onclick="closeAddToLiveTanksModal()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #999;">√ó</button>
          </div>
          
          <div style="margin-bottom: 15px;">
            <label style="display: block; margin-bottom: 5px; font-weight: bold;">üè≠ Department:</label>
            <input type="text" id="modalDepartment" value="PLCR" readonly style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; background: #f5f5f5;">
          </div>
          
          <div style="margin-bottom: 15px;">
            <label style="display: block; margin-bottom: 5px; font-weight: bold;">üî¢ Tank Number:</label>
            <input type="text" id="modalTankNumber" value="${calcData.tankNumber}" readonly style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; background: #f5f5f5;">
          </div>
          
          <div style="margin-bottom: 15px;">
            <label style="display: block; margin-bottom: 5px; font-weight: bold;">üõ¢Ô∏è Product:</label>
            <select id="modalProduct" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
              ${productOptions}
            </select>
          </div>
          
          <div id="otherProductDiv" style="display: none; margin-bottom: 15px;">
            <label style="display: block; margin-bottom: 5px; font-weight: bold;">üìù Specify Product:</label>
            <input type="text" id="modalOtherProduct" placeholder="Enter product name" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
          </div>
          
          <div style="margin-bottom: 15px;">
            <label style="display: block; margin-bottom: 5px; font-weight: bold;">üìä Amount to Withdraw:</label>
            <input type="text" id="modalAmount" value="${calcData.amountToWithdraw}" readonly style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; background: #f5f5f5;">
          </div>
          
          <div style="margin-bottom: 15px;">
            <label style="display: block; margin-bottom: 5px; font-weight: bold;">üéØ Target Type:</label>
            <select id="modalTargetType" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
              <option value="Withdrawal">Withdrawal</option>
              <option value="Transfer">Transfer</option>
              <option value="Loading">Loading</option>
            </select>
          </div>
          
          <div style="margin-bottom: 15px;">
            <label style="display: block; margin-bottom: 5px; font-weight: bold;">üìÖ Finish Date:</label>
            <input type="text" id="modalFinishDate" value="${calcData.finishTime.toLocaleDateString('en-GB')}" readonly style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; background: #f5f5f5;">
          </div>
          
          <div style="margin-bottom: 15px;">
            <label style="display: block; margin-bottom: 5px; font-weight: bold;">‚è∞ Finish Time:</label>
            <input type="text" id="modalFinishTime" value="${calcData.finishTime.toLocaleTimeString('en-GB', { hour12: false, hour: '2-digit', minute: '2-digit' })}" readonly style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; background: #f5f5f5;">
          </div>
          
          <div style="margin-bottom: 20px;">
            <label style="display: block; margin-bottom: 5px; font-weight: bold;">üìù Notes (Optional):</label>
            <textarea id="modalNotes" placeholder="Additional information..." style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; height: 80px; resize: vertical;"></textarea>
          </div>
          
          <div style="display: flex; gap: 10px;">
            <button onclick="closeAddToLiveTanksModal()" style="flex: 1; padding: 12px; background: #999; color: white; border: none; border-radius: 5px; cursor: pointer;">‚ùå Cancel</button>
            <button onclick="submitToLiveTanks()" style="flex: 1; padding: 12px; background: #f44336; color: white; border: none; border-radius: 5px; cursor: pointer;">üìã Add to Live Tanks</button>
          </div>
        </div>
      `;
      
      document.body.appendChild(modal);
      
      // ÿ•ÿ∂ÿßŸÅÿ© ŸÖÿ≥ÿ™ŸÖÿπ ŸÑŸÑŸÖŸÜÿ™ÿ¨ OTHER
      document.getElementById('modalProduct').addEventListener('change', function() {
        const otherDiv = document.getElementById('otherProductDiv');
        if (this.value === 'OTHER') {
          otherDiv.style.display = 'block';
        } else {
          otherDiv.style.display = 'none';
        }
      });
    };

    // ÿØÿßŸÑÿ© ÿ•ÿ∫ŸÑÿßŸÇ ÿßŸÑŸÜÿßŸÅÿ∞ÿ© ÿßŸÑŸÖŸÜÿ®ÿ´ŸÇÿ©
    window.closeAddToLiveTanksModal = () => {
      const modal = document.getElementById('addToLiveTanksModal');
      if (modal) {
        modal.remove();
      }
    };

    // ÿØÿßŸÑÿ© ÿ•ÿ±ÿ≥ÿßŸÑ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿ•ŸÑŸâ Live Tanks
    window.submitToLiveTanks = async () => {
      try {
        // ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿ™ÿ≠ŸÖŸäŸÑ Firebase
        if (!window.db || !window.addDoc || !window.collection) {
          alert('Firebase is not loaded yet. Please wait a moment and try again.');
          return;
        }
        
        const product = document.getElementById('modalProduct').value;
        const finalProduct = product === 'OTHER' ? document.getElementById('modalOtherProduct').value : product;
        
        if (!finalProduct) {
          alert('Please specify the product');
          return;
        }
        
        // ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ
        if (!currentUser || !currentUser.username) {
          alert('User information not available. Please refresh the page.');
          return;
        }
        
        // ÿ™ÿ≠ÿ≥ŸäŸÜ ÿ™ÿ≠ŸàŸäŸÑ ÿßŸÑÿ™ÿßÿ±ŸäÿÆ ŸàÿßŸÑŸàŸÇÿ™
        const dateStr = document.getElementById('modalFinishDate').value;
        const timeStr = document.getElementById('modalFinishTime').value;
        
        // ÿ™ÿ≠ŸàŸäŸÑ ÿßŸÑÿ™ÿßÿ±ŸäÿÆ ŸÖŸÜ DD/MM/YYYY ÿ•ŸÑŸâ YYYY-MM-DD
        const dateParts = dateStr.split('/');
        const formattedDate = `${dateParts[2]}-${dateParts[1].padStart(2, '0')}-${dateParts[0].padStart(2, '0')}`;
        
        let finishDateTime;
        try {
          finishDateTime = new Date(`${formattedDate}T${timeStr}:00`);
          if (isNaN(finishDateTime.getTime())) {
            throw new Error('Invalid date');
          }
        } catch (error) {
          alert('Error: Invalid date or time format');
          return;
        }
        
        const tankData = {
          department: 'PLCR',
          tankNumber: calcData.tankNumber,
          product: finalProduct,
          amount: parseFloat(calcData.amountToWithdraw),
          targetType: document.getElementById('modalTargetType').value,
          finishDate: dateStr,
          finishTime: timeStr,
          finishDateTime: finishDateTime,
          notes: document.getElementById('modalNotes').value,
          addedBy: currentUser.username,
          addedAt: new Date(),
          source: 'PLCR_Calculator'
        };
        
        // ÿ•ÿ∏Ÿáÿßÿ± ÿ±ÿ≥ÿßŸÑÿ© ÿ™ÿ≠ŸÖŸäŸÑ
        const submitBtn = document.querySelector('button[onclick="submitToLiveTanks()"]');
        const originalText = submitBtn.textContent;
        submitBtn.textContent = '‚è≥ Adding...';
        submitBtn.disabled = true;
        
        // ÿ•ÿ∂ÿßŸÅÿ© ÿ•ŸÑŸâ Firebase
        await window.addDoc(window.collection(window.db, 'liveTanks'), tankData);
        
        // ÿ±ÿ≥ÿßŸÑÿ© ŸÜÿ¨ÿßÿ≠
        alert('‚úÖ Tank added to Live Tanks successfully!');
        closeAddToLiveTanksModal();
        
        // ÿ•ÿ∂ÿßŸÅÿ© ÿ±ÿ≥ÿßŸÑÿ© ÿ™ÿ£ŸÉŸäÿØ ÿ®ÿµÿ±Ÿäÿ©
        const successMsg = document.createElement('div');
        successMsg.style.cssText = 'position:fixed;top:80px;right:20px;background:rgba(76,175,80,0.9);color:white;padding:15px 20px;border-radius:8px;font-size:14px;z-index:10000;animation:slideIn 0.3s ease;box-shadow:0 4px 12px rgba(0,0,0,0.3)';
        successMsg.innerHTML = '‚úÖ Tank added to Live Tanks successfully!';
        document.body.appendChild(successMsg);
        setTimeout(() => successMsg.remove(), 4000);
        
      } catch (error) {
        console.error('Error adding to Live Tanks:', error);
        alert('‚ùå Error adding to Live Tanks: ' + error.message);
        
        // ÿ•ÿπÿßÿØÿ© ÿ™ŸÅÿπŸäŸÑ ÿßŸÑÿ≤ÿ±
        const submitBtn = document.querySelector('button[onclick="submitToLiveTanks()"]');
        if (submitBtn) {
          submitBtn.textContent = 'üìã Add to Live Tanks';
          submitBtn.disabled = false;
        }
      }
    };

    console.log('%cüîí PLCR CALCULATOR - SMART SECURITY','color:red;font-size:16px;font-weight:bold');
    console.log('%cDeveloper: Fahad - 17877','color:green;font-size:14px');
  </script>
</body>
</html>