<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Tank Tools</title>
<link rel="manifest" href="/manifest.json">
<link rel="icon" href="icon.png" type="image/png">
<meta name="theme-color" content="#003366">
<style>
*{margin:0;padding:0;box-sizing:border-box}body{background:linear-gradient(rgba(0,0,0,0.5),rgba(0,0,0,0.5)),url('background.jpg');background-size:cover;background-position:center;background-attachment:fixed;font-family:Arial,sans-serif;min-height:100vh;display:flex;justify-content:center;align-items:center;color:white}
.container{background:rgba(255,255,255,0.1);backdrop-filter:blur(10px);border-radius:15px;padding:40px;box-shadow:0 8px 32px rgba(0,0,0,0.3);border:1px solid rgba(255,255,255,0.2);width:100%;max-width:450px;text-align:center;position:relative;overflow:hidden}
.container::before{content:'';position:absolute;top:0;left:-100%;width:100%;height:100%;background:linear-gradient(90deg,transparent,rgba(255,255,255,0.1),transparent);transition:0.5s}
.container:hover::before{left:100%}
.logo{font-size:3rem;margin-bottom:10px;background:linear-gradient(45deg,#FFD700,#FFA500);-webkit-background-clip:text;-webkit-text-fill-color:transparent;animation:pulse 2s ease-in-out infinite}
@keyframes pulse{0%,100%{transform:scale(1)}50%{transform:scale(1.05)}}
.subtitle{font-size:1.2rem;margin-bottom:30px;opacity:0.9;font-weight:300}
.tab-container{display:flex;margin-bottom:30px;background:rgba(255,255,255,0.1);border-radius:10px;padding:5px}
.tab{flex:1;padding:12px 20px;border:none;background:transparent;color:white;cursor:pointer;border-radius:8px;transition:all 0.3s ease;font-weight:500}
.tab.active{background:linear-gradient(45deg,#4CAF50,#45a049);box-shadow:0 5px 15px rgba(76,175,80,0.3);transform:translateY(-2px)}
.form-container{display:none}
.form-container.active{display:block;animation:slideIn 0.5s ease}
@keyframes slideIn{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:translateY(0)}}
.form-group{margin-bottom:20px;text-align:left}
label{display:block;margin-bottom:8px;font-weight:500;color:rgba(255,255,255,0.9)}
input{width:100%;padding:15px;border:none;border-radius:10px;background:rgba(255,255,255,0.9);color:#003366;font-size:16px;transition:all 0.3s ease;border:2px solid transparent;box-shadow:0 2px 5px rgba(0,0,0,0.3)}
input::placeholder{color:rgba(0,51,102,0.6)}
input:focus{outline:none;background:rgba(255,255,255,1);border-color:#4CAF50;transform:translateY(-2px);box-shadow:0 5px 15px rgba(0,0,0,0.2)}
.username-container{display:flex;align-items:center;background:rgba(255,255,255,0.9);border-radius:10px;border:2px solid transparent;transition:all 0.3s ease;box-shadow:0 2px 5px rgba(0,0,0,0.3)}
.username-container:focus-within{background:rgba(255,255,255,1);border-color:#4CAF50;transform:translateY(-2px);box-shadow:0 5px 15px rgba(0,0,0,0.2)}
.username-input{background:transparent;border:none;padding:15px;flex:1;box-shadow:none;transform:none;color:#003366}
.username-input:focus{background:transparent;border:none;box-shadow:none;transform:none}
.email-suffix{padding:15px;color:#003366;font-weight:500;background:rgba(0,51,102,0.1);border-radius:0 8px 8px 0}
.validation-message{margin-top:5px;font-size:12px;color:#ff6b6b;opacity:0;transition:opacity 0.3s ease}
.validation-message.show{opacity:1}
.validation-message.success{color:#4CAF50}
.password-strength{margin-top:8px;height:4px;background:rgba(255,255,255,0.2);border-radius:2px;overflow:hidden}
.password-strength-bar{height:100%;width:0%;transition:all 0.3s ease;border-radius:2px}
.strength-weak{background:#ff6b6b;width:25%}
.strength-fair{background:#ffa726;width:50%}
.strength-good{background:#42a5f5;width:75%}
.strength-strong{background:#4CAF50;width:100%}
.btn{width:100%;padding:15px;border:none;border-radius:10px;font-size:18px;font-weight:600;cursor:pointer;transition:all 0.3s ease;margin-top:20px;position:relative;overflow:hidden}
.btn-primary{background:linear-gradient(45deg,#4CAF50,#45a049);color:white}
.btn-secondary{background:linear-gradient(45deg,#2196F3,#1976D2);color:white;margin-top:10px;font-size:14px;padding:10px}
.btn-danger{background:linear-gradient(45deg,#f44336,#d32f2f);color:white;margin-top:10px;font-size:14px;padding:10px}
.btn:hover{transform:translateY(-3px);box-shadow:0 15px 30px rgba(76,175,80,0.4)}
.btn:disabled{background:#ccc;cursor:not-allowed;transform:none}
.btn::before{content:'';position:absolute;top:0;left:-100%;width:100%;height:100%;background:linear-gradient(90deg,transparent,rgba(255,255,255,0.2),transparent);transition:0.5s}
.btn:hover::before{left:100%}
.forgot-password-link{color:#2196F3;text-decoration:none;font-size:14px;display:block;margin-top:15px;transition:all 0.3s ease}
.forgot-password-link:hover{color:#1976D2;text-shadow:0 0 5px rgba(33,150,243,0.5)}
.message{margin-top:15px;padding:12px;border-radius:8px;font-size:14px;opacity:0;transform:translateY(-10px);transition:all 0.3s ease}
.message.show{opacity:1;transform:translateY(0)}
.message.success{background:rgba(76,175,80,0.2);border:1px solid rgba(76,175,80,0.5);color:#4CAF50}
.message.error{background:rgba(255,107,107,0.2);border:1px solid rgba(255,107,107,0.5);color:#ff6b6b}
.message.info{background:rgba(33,150,243,0.2);border:1px solid rgba(33,150,243,0.5);color:#2196F3}
.message.warning{background:rgba(255,193,7,0.2);border:1px solid rgba(255,193,7,0.5);color:#ffc107}
.footer{margin-top:30px;font-size:12px;opacity:0.7;text-align:center}
.loading{display:none;margin-top:10px}
.spinner{border:3px solid rgba(255,255,255,0.3);border-radius:50%;border-top:3px solid white;width:30px;height:30px;animation:spin 1s linear infinite;margin:0 auto}
@keyframes spin{0%{transform:rotate(0deg)}100%{transform:rotate(360deg)}}
.firebase-status{background:rgba(76,175,80,0.2);border:1px solid rgba(76,175,80,0.5);color:#4CAF50;padding:10px;border-radius:8px;margin-bottom:20px;font-size:13px;text-align:center}
.forgot-container{display:none;text-align:center}
.forgot-container.active{display:block;animation:slideIn 0.5s ease}
.forgot-icon{font-size:4rem;margin-bottom:20px;color:#2196F3}
.forgot-title{font-size:1.5rem;margin-bottom:15px;color:#2196F3}
.forgot-text{margin-bottom:20px;opacity:0.8}
.back-btn{background:transparent;border:1px solid rgba(255,255,255,0.3);color:white;padding:10px 20px;border-radius:8px;cursor:pointer;transition:all 0.3s ease;margin-top:10px}
.back-btn:hover{background:rgba(255,255,255,0.1)}
@media (max-width:480px){.container{padding:30px 20px;margin:20px}.logo{font-size:2.5rem}.tab{padding:10px 15px;font-size:14px}}
.debug-panel{background:rgba(0,0,0,0.7);color:#4CAF50;padding:10px;border-radius:8px;margin-top:20px;text-align:left;font-family:monospace;font-size:12px;max-height:200px;overflow-y:auto;display:none}
</style>
</head>
<body>
<div class="container">
<div class="logo">ğŸ› ï¸ Tank Tools</div>
<div class="subtitle">Kuwait National Petroleum Company</div>
<div class="firebase-status">ğŸ”¥ Firebase Authentication Enabled & Secured</div>
<div id="mainContainer">
<div class="tab-container">
<button class="tab active" onclick="switchTab('login')">Login</button>
<button class="tab" onclick="switchTab('register')">Register</button>
</div>
<div id="loginForm" class="form-container active">
<form onsubmit="handleLogin(event)">
<div class="form-group">
<label for="loginUsername">ğŸ‘¤ Username:</label>
<div class="username-container">
<input type="text" id="loginUsername" class="username-input" placeholder="abc123" required pattern="[a-zA-Z]{3}[0-9]{3}" maxlength="6" autocomplete="username">
<div class="email-suffix">@knpc.com</div>
</div>
<div class="validation-message" id="loginUsernameMsg"></div>
</div>
<div class="form-group">
<label for="loginPassword">ğŸ”’ Password:</label>
<input type="password" id="loginPassword" placeholder="Enter your password" required autocomplete="current-password">
</div>
<div class="form-group">
<label><input type="checkbox" id="rememberMe" style="width:auto;margin-right:8px;">Remember me</label>
</div>
<button type="submit" class="btn btn-primary" id="loginBtn">ğŸš€ Login</button>
<a href="#" class="forgot-password-link" onclick="showForgotPassword()">ğŸ”‘ Forgot Password?</a>
<div class="loading" id="loginLoading"><div class="spinner"></div><div>Authenticating...</div></div>
</form>
</div>
<div id="registerForm" class="form-container">
<form onsubmit="handleRegister(event)">
<div class="form-group">
<label for="fullName">ğŸ‘¤ Full Name:</label>
<input type="text" id="fullName" placeholder="Enter your full name" required minlength="3" autocomplete="name">
<div class="validation-message" id="fullNameMsg"></div>
</div>
<div class="form-group">
<label for="username">ğŸ“§ Username (Email):</label>
<div class="username-container">
<input type="text" id="username" class="username-input" placeholder="abc123" required pattern="[a-zA-Z]{3}[0-9]{3}" maxlength="6" autocomplete="username">
<div class="email-suffix">@knpc.com</div>
</div>
<div class="validation-message" id="usernameMsg"></div>
</div>
<div class="form-group">
<label for="password">ğŸ”’ Password:</label>
<input type="password" id="password" placeholder="Create a strong password" required minlength="8" autocomplete="new-password">
<div class="password-strength"><div class="password-strength-bar" id="strengthBar"></div></div>
<div class="validation-message" id="passwordMsg"></div>
</div>
<div class="form-group">
<label for="confirmPassword">ğŸ”’ Confirm Password:</label>
<input type="password" id="confirmPassword" placeholder="Confirm your password" required autocomplete="new-password">
<div class="validation-message" id="confirmPasswordMsg"></div>
</div>
<button type="submit" class="btn btn-primary" id="registerBtn">âœ¨ Create Account</button>
<div class="loading" id="registerLoading"><div class="spinner"></div><div>Creating account...</div></div>
</form>
</div>
</div>
<div id="forgotContainer" class="forgot-container">
<div class="forgot-icon">ğŸ”‘</div>
<div class="forgot-title">Reset Password</div>
<div class="forgot-text">Enter your username to reset your password</div>
<form onsubmit="handleForgotPassword(event)">
<div class="form-group">
<label for="forgotUsername">ğŸ‘¤ Username:</label>
<div class="username-container">
<input type="text" id="forgotUsername" class="username-input" placeholder="abc123" required pattern="[a-zA-Z]{3}[0-9]{3}" maxlength="6" autocomplete="username">
<div class="email-suffix">@knpc.com</div>
</div>
</div>
<button type="submit" class="btn btn-secondary" id="resetBtn">ğŸ“§ Send Reset Email</button>
<button type="button" class="btn btn-danger" onclick="contactAdmin()" style="margin-top:10px;">ğŸ“± Contact Admin</button>
<button type="button" class="back-btn" onclick="backToLogin()">Back to Login</button>
<div class="loading" id="forgotLoading"><div class="spinner"></div><div>Sending email...</div></div>
</form>
</div>
<div id="messageContainer"></div>
<div class="debug-panel" id="debugPanel"></div>
<div class="footer"><strong>ğŸ”¥ Firebase Secured</strong><br>By <strong>Fahad - 17877</strong> | Version 6.0<br><small>Real-time & Protected</small></div>
</div>

<script type="module">
import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
import { getFirestore, doc, getDoc, setDoc, updateDoc, collection, addDoc, serverTimestamp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, sendPasswordResetEmail, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';

// Ø¥Ø¶Ø§ÙØ© Ø£ÙˆØ§Ù…Ø± debug
window.debugLog = function(message, type = 'info') {
    const debugPanel = document.getElementById('debugPanel');
    debugPanel.style.display = 'block';
    
    const timestamp = new Date().toLocaleTimeString();
    const logEntry = document.createElement('div');
    logEntry.style.marginBottom = '5px';
    
    if (type === 'error') {
        logEntry.style.color = '#ff6b6b';
    } else if (type === 'success') {
        logEntry.style.color = '#4CAF50';
    } else if (type === 'warning') {
        logEntry.style.color = '#ffc107';
    }
    
    logEntry.textContent = `[${timestamp}] ${message}`;
    debugPanel.appendChild(logEntry);
    debugPanel.scrollTop = debugPanel.scrollHeight;
    
    console.log(`[DEBUG] ${message}`);
};

const app = initializeApp({
    apiKey: "AIzaSyD7lJcoY33FEC9d6eWy67QIO9SV4lS24pg",
    authDomain: "tank-tools-knpc-c2d95.firebaseapp.com",
    projectId: "tank-tools-knpc-c2d95",
    storageBucket: "tank-tools-knpc-c2d95.firebasestorage.app",
    messagingSenderId: "510062594324",
    appId: "1:510062594324:web:b892fd02007a5ca2f0da01"
});

window.db = getFirestore(app);
window.auth = getAuth(app);
window.doc = doc;
window.getDoc = getDoc;
window.setDoc = setDoc;
window.updateDoc = updateDoc;
window.collection = collection;
window.addDoc = addDoc;
window.serverTimestamp = serverTimestamp;
window.signInWithEmailAndPassword = signInWithEmailAndPassword;
window.createUserWithEmailAndPassword = createUserWithEmailAndPassword;
window.sendPasswordResetEmail = sendPasswordResetEmail;

debugLog('ğŸ”¥ TANK TOOLS - FIREBASE AUTH SYSTEM', 'success');
debugLog('Developer: Fahad - 17877');

// Ø¥Ø¶Ø§ÙØ© Ù…Ø±Ø§Ù‚Ø¨Ø© Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
onAuthStateChanged(auth, (user) => {
    if (user) {
        debugLog(`âœ… User authenticated: ${user.email}`, 'success');
        
        // Ø¥Ø¶Ø§ÙØ© ØªØ¬Ø±Ø¨Ø© Ù‚Ø±Ø§Ø¡Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ù…Ø³Ø§Ø±Ø§Øª Ù…Ø®ØªÙ„ÙØ© Ù„Ù„ØªØ´Ø®ÙŠØµ
        testFirestoreAccess(user);
    } else {
        debugLog('âŒ User signed out', 'warning');
    }
});

// Ø¯Ø§Ù„Ø© Ù„Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„ÙˆØµÙˆÙ„ Ø¥Ù„Ù‰ Ù…Ø³Ø§Ø±Ø§Øª Ù…Ø®ØªÙ„ÙØ© ÙÙŠ Firestore
async function testFirestoreAccess(user) {
    const paths = [
        'users/' + user.email.split('@')[0],
        'pbcrTanks/tank001',
        'plcrTanks/tank001',
        'tanks/pbcr/tank001',
        'tanks/plcr/tank001',
        'pbcr/tanks/tank001',
        'plcr/tanks/tank001'
    ];
    
    debugLog('ğŸ” Testing Firestore access for different paths...', 'info');
    
    for (const path of paths) {
        try {
            debugLog(`ğŸ“‚ Testing path: ${path}`, 'info');
            const docRef = doc(db, path);
            const docSnap = await getDoc(docRef);
            
            if (docSnap.exists()) {
                debugLog(`âœ… Access successful for path: ${path}`, 'success');
            } else {
                debugLog(`âš ï¸ Document does not exist at path: ${path}`, 'warning');
            }
        } catch (error) {
            debugLog(`âŒ Access error for path ${path}: ${error.code} - ${error.message}`, 'error');
            
            // ØªÙØ§ØµÙŠÙ„ Ø¥Ø¶Ø§ÙÙŠØ© Ø¹Ù† Ø§Ù„Ø®Ø·Ø£
            if (error.code === 'permission-denied') {
                debugLog(`ğŸ”’ Permission denied details for ${path}:`, 'error');
                debugLog(`   - User UID: ${user.uid}`, 'error');
                debugLog(`   - User Email: ${user.email}`, 'error');
            }
        }
    }
}
</script>

<script>
const WHATSAPP_ADMIN = "96555222550";

async function handleLogin(event) {
    event.preventDefault();
    const username = document.getElementById('loginUsername').value.trim();
    const password = document.getElementById('loginPassword').value;
    const rememberMe = document.getElementById('rememberMe').checked;
    const email = `${username}@knpc.com`;
    
    if (!username || !password) {
        showMessage('âŒ Please enter username and password', 'error');
        return;
    }
    
    showLoading('login', true);
    debugLog(`ğŸ”‘ Login attempt for: ${username}`, 'info');
    
    try {
        // Ù…Ø­Ø§ÙˆÙ„Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ ÙÙŠ Firebase Auth ÙÙ‚Ø·
        let userCredential;
        try {
            debugLog(`ğŸ”„ Attempting Firebase Auth signIn with: ${email}`, 'info');
            userCredential = await signInWithEmailAndPassword(auth, email, password);
            debugLog('âœ… Firebase Auth signIn successful', 'success');
        } catch (authError) {
            debugLog(`âŒ Firebase Auth error: ${authError.code} - ${authError.message}`, 'error');
            
            // Ø¥Ø°Ø§ ÙØ´Ù„ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ØŒ Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯ ÙÙŠ Firebase Auth Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯ÙŠÙ† ÙÙŠ Firestore
            if (authError.code === 'auth/user-not-found' || authError.code === 'auth/invalid-credential') {
                // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙÙŠ Firestore Ø£ÙˆÙ„Ø§Ù‹
                debugLog(`ğŸ” Checking Firestore path: users/${username}`, 'info');
                const userDocRef = doc(db, 'users', username);
                const userDoc = await getDoc(userDocRef);
                
                if (!userDoc.exists()) {
                    debugLog(`âŒ User not found in Firestore: users/${username}`, 'error');
                    showMessage('âŒ User not found. Please register first.', 'error');
                    return;
                }
                
                // Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯ ÙÙŠ Firebase Auth Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ Firestore
                try {
                    debugLog(`ğŸ”„ Creating new Firebase Auth account for existing Firestore user: ${email}`, 'info');
                    userCredential = await createUserWithEmailAndPassword(auth, email, password);
                    debugLog('âœ… New Firebase Auth account created for existing user', 'success');
                } catch (createError) {
                    debugLog(`âŒ Account creation error: ${createError.code} - ${createError.message}`, 'error');
                    if (createError.code === 'auth/email-already-in-use') {
                        // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø­Ø³Ø§Ø¨ Ù…ÙˆØ¬ÙˆØ¯ Ù„ÙƒÙ† ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ù…Ø®ØªÙ„ÙØ©
                        showMessage('âŒ Account exists with different password. Please use the correct password or reset it.', 'error');
                        return;
                    }
                    throw createError;
                }
            } else {
                throw authError;
            }
        }
        
        const user = userCredential.user;
        debugLog(`ğŸ‘¤ User signed in: ${user.email} (UID: ${user.uid})`, 'success');
        
        // Ø¨Ø¹Ø¯ Ù†Ø¬Ø§Ø­ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ ÙÙŠ Firebase AuthØŒ Ù†ØªØ­Ù‚Ù‚ Ù…Ù† Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙÙŠ Firestore
        debugLog(`ğŸ” Checking user data in Firestore: users/${username}`, 'info');
        const userDocRef = doc(db, 'users', username);
        const userDoc = await getDoc(userDocRef);
        
        let userData;
        if (!userDoc.exists()) {
            debugLog(`âš ï¸ User document not found in Firestore, creating new document: users/${username}`, 'warning');
            // Ø¥Ù†Ø´Ø§Ø¡ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„Ù€ Admin Ø¥Ø°Ø§ Ù„Ù… ØªÙƒÙ† Ù…ÙˆØ¬ÙˆØ¯Ø©
            if (username === 'fam030') {
                userData = {
                    id: 1,
                    username: 'fam030',
                    fullName: 'Fahad Admin',
                    email: 'fam030@knpc.com',
                    role: 'admin',
                    isActive: true,
                    createdAt: serverTimestamp(),
                    lastLogin: serverTimestamp(),
                    firebaseUID: user.uid
                };
                await setDoc(userDocRef, userData);
                debugLog('âœ… Admin user document created in Firestore', 'success');
            } else {
                // Ø¥Ù†Ø´Ø§Ø¡ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø¹Ø§Ø¯ÙŠ Ø¥Ø°Ø§ Ù„Ù… ØªÙƒÙ† Ù…ÙˆØ¬ÙˆØ¯Ø©
                userData = {
                    id: Date.now(),
                    username: username,
                    fullName: username,
                    email: email,
                    role: 'user',
                    isActive: true,
                    createdAt: serverTimestamp(),
                    lastLogin: serverTimestamp(),
                    firebaseUID: user.uid
                };
                await setDoc(userDocRef, userData);
                debugLog('âœ… Regular user document created in Firestore', 'success');
            }
        } else {
            userData = userDoc.data();
            debugLog(`âœ… User document found in Firestore: ${JSON.stringify(userData)}`, 'success');
            
            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø­Ø³Ø§Ø¨
            if (!userData.isActive && username !== 'fam030') {
                debugLog('âš ï¸ User account is not active', 'warning');
                showMessage('â³ Your account is pending admin approval.', 'warning');
                setTimeout(() => {
                    const messageContainer = document.getElementById('messageContainer');
                    messageContainer.innerHTML += `<div class="message info show" style="margin-top: 10px;"><button class="btn btn-secondary" onclick="contactAdminForActivation('${username}', '${userData.fullName || username}')" style="width: 100%;">ğŸ“± Contact Admin for Activation</button></div>`;
                }, 1000);
                return;
            }
            
            // ØªØ­Ø¯ÙŠØ« Ø¢Ø®Ø± ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„
            debugLog(`ğŸ”„ Updating last login timestamp for user: ${username}`, 'info');
            await updateDoc(userDocRef, {
                lastLogin: serverTimestamp(),
                firebaseUID: user.uid // ØªØ­Ø¯ÙŠØ« UID Ø¥Ø°Ø§ ØªØºÙŠØ±
            });
            debugLog('âœ… Last login timestamp updated', 'success');
        }
        
        // Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¬Ù„Ø³Ø©
        debugLog('ğŸ’¾ Saving session data', 'info');
        const sessionUserData = {
            uid: user.uid,
            id: userData.id || Date.now(),
            username: userData.username,
            fullName: userData.fullName,
            email: userData.email,
            role: userData.role || 'user',
            isActive: userData.isActive,
            loginTime: new Date().toISOString()
        };
        
        localStorage.setItem('tanktools_current_user', JSON.stringify(sessionUserData));
        sessionStorage.setItem('tanktools_session', 'active');
        debugLog('âœ… Session data saved', 'success');
        
        if (rememberMe) {
            localStorage.setItem('tanktools_remember', JSON.stringify({
                username: username,
                rememberMe: true
            }));
            debugLog('âœ… Remember me preference saved', 'success');
        }
        
        await addActivity('user_login', username);
        
        showMessage('âœ… Login successful! Redirecting...', 'success');
        debugLog('ğŸš€ Login successful, preparing to redirect', 'success');
        
        setTimeout(() => {
            const redirect = sessionStorage.getItem('tanktools_redirect');
            if (redirect) {
                sessionStorage.removeItem('tanktools_redirect');
                debugLog(`ğŸ”„ Redirecting to: ${redirect}`, 'info');
                window.location.href = redirect;
            } else {
                const defaultUrl = userData.role === 'admin' ? 'dashboard.html' : 'index.html';
                debugLog(`ğŸ”„ Redirecting to default URL: ${defaultUrl}`, 'info');
                window.location.href = defaultUrl;
            }
        }, 1500);
        
    } catch (error) {
        console.error('âŒ Login error:', error);
        debugLog(`âŒ Login error: ${error.code} - ${error.message}`, 'error');
        
        // ØªÙØ§ØµÙŠÙ„ Ø¥Ø¶Ø§ÙÙŠØ© Ø¹Ù† Ø§Ù„Ø®Ø·Ø£
        if (error.code === 'permission-denied') {
            debugLog('ğŸ”’ Permission denied details:', 'error');
            debugLog(`   - Attempted path: ${error.path || 'unknown'}`, 'error');
            debugLog(`   - Username: ${username}`, 'error');
        }
        
        let errorMessage = 'Login failed';
        
        switch (error.code) {
            case 'auth/wrong-password':
            case 'auth/invalid-credential':
                errorMessage = 'Invalid password';
                break;
            case 'auth/user-not-found':
                errorMessage = 'User not found';
                break;
            case 'auth/too-many-requests':
                errorMessage = 'Too many attempts. Try again later';
                break;
            case 'permission-denied':
                errorMessage = 'Access denied. Please contact admin';
                break;
            default:
                errorMessage = error.message;
        }
        
        showMessage(`âŒ ${errorMessage}`, 'error');
    } finally {
        showLoading('login', false);
    }
}

async function handleRegister(event) {
    event.preventDefault();
    const fullName = document.getElementById('fullName').value.trim();
    const username = document.getElementById('username').value.trim();
    const password = document.getElementById('password').value;
    const confirmPassword = document.getElementById('confirmPassword').value;
    const email = `${username}@knpc.com`;
    
    if (!fullName || !username || !password || !confirmPassword) {
        showMessage('âŒ Please fill all fields', 'error');
        return;
    }
    
    if (password !== confirmPassword) {
        showMessage('âŒ Passwords do not match', 'error');
        return;
    }
    
    if (password.length < 8) {
        showMessage('âŒ Password must be at least 8 characters', 'error');
        return;
    }
    
    showLoading('register', true);
    debugLog(`ğŸ”‘ Registration attempt for: ${username}`, 'info');
    
    try {
        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¹Ø¯Ù… ÙˆØ¬ÙˆØ¯ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
        debugLog(`ğŸ” Checking if user exists: users/${username}`, 'info');
        const userDocRef = doc(db, 'users', username);
        const userDoc = await getDoc(userDocRef);
        
        if (userDoc.exists()) {
            debugLog(`âŒ Username already exists: ${username}`, 'error');
            showMessage('âŒ Username already exists', 'error');
            return;
        }
        
        // Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ ÙÙŠ Firebase Auth
        debugLog(`ğŸ”„ Creating Firebase Auth account: ${email}`, 'info');
        const userCredential = await createUserWithEmailAndPassword(auth, email, password);
        debugLog('âœ… Firebase Auth account created', 'success');
        
        // Ø¥Ù†Ø´Ø§Ø¡ Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ Firestore - Ù„Ø§ Ù†Ø®Ø²Ù† ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø¨Ø¹Ø¯ Ø§Ù„Ø¢Ù†
        debugLog(`ğŸ’¾ Creating user document in Firestore: users/${username}`, 'info');
        const userData = {
            id: Date.now(),
            username: username,
            fullName: fullName,
            email: email,
            // Ù„Ø§ Ù†Ø®Ø²Ù† ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ÙÙŠ Firestore Ø¨Ø¹Ø¯ Ø§Ù„Ø¢Ù†
            role: 'user',
            isActive: false,
            createdAt: serverTimestamp(),
            emailVerified: false,
            firebaseUID: userCredential.user.uid
        };
        
        await setDoc(userDocRef, userData);
        debugLog('âœ… User document created in Firestore', 'success');
        
        await addActivity('user_registered', username);
        
        showMessage('âœ… Registration successful! Pending admin approval.', 'success');
        debugLog('âœ… Registration successful, pending admin approval', 'success');
        
        setTimeout(() => {
            const messageContainer = document.getElementById('messageContainer');
            messageContainer.innerHTML += `<div class="message info show" style="margin-top: 10px;"><button class="btn btn-secondary" onclick="contactAdminForActivation('${username}', '${fullName}')" style="width: 100%;">ğŸ“± Contact Admin for Activation</button></div>`;
        }, 1000);
        
        // Ù…Ø³Ø­ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬
        document.getElementById('fullName').value = '';
        document.getElementById('username').value = '';
        document.getElementById('password').value = '';
        document.getElementById('confirmPassword').value = '';
        
        setTimeout(() => {
            switchTabDirect('login');
        }, 3000);
        
    } catch (error) {
        console.error('âŒ Registration error:', error);
        debugLog(`âŒ Registration error: ${error.code} - ${error.message}`, 'error');
        
        let errorMessage = 'Registration failed';
        
        switch (error.code) {
            case 'auth/email-already-in-use':
                errorMessage = 'Email already in use';
                break;
            case 'auth/weak-password':
                errorMessage = 'Password is too weak';
                break;
            default:
                errorMessage = error.message;
        }
        
        showMessage(`âŒ ${errorMessage}`, 'error');
    } finally {
        showLoading('register', false);
    }
}

async function handleForgotPassword(event) {
    event.preventDefault();
    const username = document.getElementById('forgotUsername').value.trim();
    const email = `${username}@knpc.com`;
    
    if (!username) {
        showMessage('âŒ Please enter your username', 'error');
        return;
    }
    
    showLoading('forgot', true);
    debugLog(`ğŸ”‘ Password reset attempt for: ${username}`, 'info');
    
    try {
        await sendPasswordResetEmail(auth, email);
        debugLog('âœ… Password reset email sent', 'success');
        showMessage('âœ… Password reset email sent', 'success');
        
        setTimeout(() => {
            backToLogin();
        }, 3000);
    } catch (error) {
        console.error('âŒ Forgot password error:', error);
        debugLog(`âŒ Forgot password error: ${error.code} - ${error.message}`, 'error');
        
        let errorMessage = 'Failed to send reset email';
        
        switch (error.code) {
            case 'auth/user-not-found':
                errorMessage = 'No account found with this email';
                break;
            default:
                errorMessage = error.message;
        }
        
        showMessage(`âŒ ${errorMessage}`, 'error');
    } finally {
        showLoading('forgot', false);
    }
}

async function addActivity(type, username) {
    try {
        debugLog(`ğŸ“ Logging activity: ${type} for user ${username}`, 'info');
        const activityData = {
            type: type,
            username: username,
            timestamp: serverTimestamp()
        };
        
        const activityRef = collection(db, 'activities');
        await addDoc(activityRef, activityData);
        debugLog('âœ… Activity logged successfully', 'success');
    } catch (error) {
        console.error('Failed to log activity:', error);
        debugLog(`âŒ Failed to log activity: ${error.message}`, 'error');
    }
}

function contactAdmin() {
    const message = `Hello Admin, I need help with my Tank Tools account. Please assist.`;
    const whatsappUrl = `https://wa.me/${WHATSAPP_ADMIN}?text=${encodeURIComponent(message)}`;
    window.open(whatsappUrl, '_blank');
}

function contactAdminForActivation(username, fullName) {
    const message = `Hello Admin, I just registered for Tank Tools with username: ${username} and name: ${fullName}. Please activate my account. Thank you!`;
    const whatsappUrl = `https://wa.me/${WHATSAPP_ADMIN}?text=${encodeURIComponent(message)}`;
    window.open(whatsappUrl, '_blank');
}

function switchTab(tab) {
    const loginForm = document.getElementById('loginForm');
    const registerForm = document.getElementById('registerForm');
    const forgotContainer = document.getElementById('forgotContainer');
    const loginTab = document.querySelector('.tab:nth-child(1)');
    const registerTab = document.querySelector('.tab:nth-child(2)');
    
    if (tab === 'login') {
        loginForm.classList.add('active');
        registerForm.classList.remove('active');
        forgotContainer.classList.remove('active');
        loginTab.classList.add('active');
        registerTab.classList.remove('active');
    } else if (tab === 'register') {
        loginForm.classList.remove('active');
        registerForm.classList.add('active');
        forgotContainer.classList.remove('active');
        loginTab.classList.remove('active');
        registerTab.classList.add('active');
    }
}

function switchTabDirect(tab) {
    switchTab(tab);
}

function showForgotPassword() {
    const mainContainer = document.getElementById('mainContainer');
    const forgotContainer = document.getElementById('forgotContainer');
    
    mainContainer.style.display = 'none';
    forgotContainer.classList.add('active');
}

function backToLogin() {
    const mainContainer = document.getElementById('mainContainer');
    const forgotContainer = document.getElementById('forgotContainer');
    
    mainContainer.style.display = 'block';
    forgotContainer.classList.remove('active');
    switchTab('login');
}

function showMessage(text, type) {
    const messageContainer = document.getElementById('messageContainer');
    messageContainer.innerHTML = `<div class="message ${type} show">${text}</div>`;
    
    setTimeout(() => {
        const message = messageContainer.querySelector('.message');
        if (message) {
            message.classList.remove('show');
            setTimeout(() => {
                messageContainer.innerHTML = '';
            }, 300);
        }
    }, 5000);
}

function showLoading(form, show) {
    const loading = document.getElementById(`${form}Loading`);
    if (loading) {
        loading.style.display = show ? 'block' : 'none';
    }
}

document.addEventListener('DOMContentLoaded', () => {
    debugLog('ğŸ”„ Page loaded, checking session', 'info');
    const session = sessionStorage.getItem('tanktools_session');
    const userData = localStorage.getItem('tanktools_current_user');
    
    if (session === 'active' && userData) {
        const user = JSON.parse(userData);
        debugLog(`âœ… Active session found for user: ${user.username}`, 'success');
        const defaultUrl = user.role === 'admin' ? 'dashboard.html' : 'index.html';
        
        setTimeout(() => {
            debugLog(`ğŸ”„ Redirecting to: ${defaultUrl}`, 'info');
            window.location.href = defaultUrl;
        }, 500);
    } else {
        debugLog('âš ï¸ No active session found', 'warning');
        const remember = localStorage.getItem('tanktools_remember');
        if (remember) {
            const rememberData = JSON.parse(remember);
            if (rememberData.rememberMe) {
                debugLog(`ğŸ”„ Filling remembered username: ${rememberData.username}`, 'info');
                document.getElementById('loginUsername').value = rememberData.username;
                document.getElementById('rememberMe').checked = true;
            }
        }
    }
});

document.getElementById('password')?.addEventListener('input', function() {
    const password = this.value;
    const strengthBar = document.getElementById('strengthBar');
    
    if (password.length === 0) {
        strengthBar.className = 'password-strength-bar';
        strengthBar.style.width = '0%';
        return;
    }
    
    let strength = 0;
    
    if (password.length >= 8) strength += 1;
    if (password.length >= 12) strength += 1;
    if (/[A-Z]/.test(password)) strength += 1;
    if (/[a-z]/.test(password)) strength += 1;
    if (/[0-9]/.test(password)) strength += 1;
    if (/[^A-Za-z0-9]/.test(password)) strength += 1;
    
    strengthBar.className = 'password-strength-bar';
    if (strength <= 2) {
        strengthBar.classList.add('strength-weak');
    } else if (strength <= 4) {
        strengthBar.classList.add('strength-fair');
    } else if (strength <= 6) {
        strengthBar.classList.add('strength-good');
    } else {
        strengthBar.classList.add('strength-strong');
    }
});
</script>
</body>
</html>
