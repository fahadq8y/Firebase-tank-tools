<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Tank Tools</title>
<link rel="manifest" href="/manifest.json">
<link rel="icon" href="icon.png" type="image/png">
<meta name="theme-color" content="#003366">
<style>
*{margin:0;padding:0;box-sizing:border-box}body{background:linear-gradient(rgba(0,0,0,0.5),rgba(0,0,0,0.5)),url('background.jpg');background-size:cover;background-position:center;background-attachment:fixed;font-family:Arial,sans-serif;min-height:100vh;display:flex;justify-content:center;align-items:center;color:white}
.container{background:rgba(255,255,255,0.1);backdrop-filter:blur(10px);border-radius:15px;padding:40px;box-shadow:0 8px 32px rgba(0,0,0,0.3);border:1px solid rgba(255,255,255,0.2);width:100%;max-width:450px;text-align:center;position:relative;overflow:hidden}
.container::before{content:'';position:absolute;top:0;left:-100%;width:100%;height:100%;background:linear-gradient(90deg,transparent,rgba(255,255,255,0.1),transparent);transition:0.5s}
.container:hover::before{left:100%}
.logo{font-size:3rem;margin-bottom:10px;background:linear-gradient(45deg,#FFD700,#FFA500);-webkit-background-clip:text;-webkit-text-fill-color:transparent;animation:pulse 2s ease-in-out infinite}
@keyframes pulse{0%,100%{transform:scale(1)}50%{transform:scale(1.05)}}
.subtitle{font-size:1.2rem;margin-bottom:30px;opacity:0.9;font-weight:300}
.tab-container{display:flex;margin-bottom:30px;background:rgba(255,255,255,0.1);border-radius:10px;padding:5px}
.tab{flex:1;padding:12px 20px;border:none;background:transparent;color:white;cursor:pointer;border-radius:8px;transition:all 0.3s ease;font-weight:500}
.tab.active{background:linear-gradient(45deg,#4CAF50,#45a049);box-shadow:0 5px 15px rgba(76,175,80,0.3);transform:translateY(-2px)}
.form-container{display:none}
.form-container.active{display:block;animation:slideIn 0.5s ease}
@keyframes slideIn{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:translateY(0)}}
.form-group{margin-bottom:20px;text-align:left}
label{display:block;margin-bottom:8px;font-weight:500;color:rgba(255,255,255,0.9)}
input{width:100%;padding:15px;border:none;border-radius:10px;background:rgba(255,255,255,0.9);color:#003366;font-size:16px;transition:all 0.3s ease;border:2px solid transparent;box-shadow:0 2px 5px rgba(0,0,0,0.3)}
input::placeholder{color:rgba(0,51,102,0.6)}
input:focus{outline:none;background:rgba(255,255,255,1);border-color:#4CAF50;transform:translateY(-2px);box-shadow:0 5px 15px rgba(0,0,0,0.2)}
.username-container{display:flex;align-items:center;background:rgba(255,255,255,0.9);border-radius:10px;border:2px solid transparent;transition:all 0.3s ease;box-shadow:0 2px 5px rgba(0,0,0,0.3)}
.username-container:focus-within{background:rgba(255,255,255,1);border-color:#4CAF50;transform:translateY(-2px);box-shadow:0 5px 15px rgba(0,0,0,0.2)}
.username-input{background:transparent;border:none;padding:15px;flex:1;box-shadow:none;transform:none;color:#003366}
.username-input:focus{background:transparent;border:none;box-shadow:none;transform:none}
.email-suffix{padding:15px;color:#003366;font-weight:500;background:rgba(0,51,102,0.1);border-radius:0 8px 8px 0}
.validation-message{margin-top:5px;font-size:12px;color:#ff6b6b;opacity:0;transition:opacity 0.3s ease}
.validation-message.show{opacity:1}
.validation-message.success{color:#4CAF50}
.password-strength{margin-top:8px;height:4px;background:rgba(255,255,255,0.2);border-radius:2px;overflow:hidden}
.password-strength-bar{height:100%;width:0%;transition:all 0.3s ease;border-radius:2px}
.strength-weak{background:#ff6b6b;width:25%}
.strength-fair{background:#ffa726;width:50%}
.strength-good{background:#42a5f5;width:75%}
.strength-strong{background:#4CAF50;width:100%}
.btn{width:100%;padding:15px;border:none;border-radius:10px;font-size:18px;font-weight:600;cursor:pointer;transition:all 0.3s ease;margin-top:20px;position:relative;overflow:hidden}
.btn-primary{background:linear-gradient(45deg,#4CAF50,#45a049);color:white}
.btn-secondary{background:linear-gradient(45deg,#2196F3,#1976D2);color:white;margin-top:10px;font-size:14px;padding:10px}
.btn-danger{background:linear-gradient(45deg,#f44336,#d32f2f);color:white;margin-top:10px;font-size:14px;padding:10px}
.btn:hover{transform:translateY(-3px);box-shadow:0 15px 30px rgba(76,175,80,0.4)}
.btn:disabled{background:#ccc;cursor:not-allowed;transform:none}
.btn::before{content:'';position:absolute;top:0;left:-100%;width:100%;height:100%;background:linear-gradient(90deg,transparent,rgba(255,255,255,0.2),transparent);transition:0.5s}
.btn:hover::before{left:100%}
.forgot-password-link{color:#2196F3;text-decoration:none;font-size:14px;display:block;margin-top:15px;transition:all 0.3s ease}
.forgot-password-link:hover{color:#1976D2;text-shadow:0 0 5px rgba(33,150,243,0.5)}
.message{margin-top:15px;padding:12px;border-radius:8px;font-size:14px;opacity:0;transform:translateY(-10px);transition:all 0.3s ease}
.message.show{opacity:1;transform:translateY(0)}
.message.success{background:rgba(76,175,80,0.2);border:1px solid rgba(76,175,80,0.5);color:#4CAF50}
.message.error{background:rgba(255,107,107,0.2);border:1px solid rgba(255,107,107,0.5);color:#ff6b6b}
.message.info{background:rgba(33,150,243,0.2);border:1px solid rgba(33,150,243,0.5);color:#2196F3}
.message.warning{background:rgba(255,193,7,0.2);border:1px solid rgba(255,193,7,0.5);color:#ffc107}
.footer{margin-top:30px;font-size:12px;opacity:0.7;text-align:center}
.loading{display:none;margin-top:10px}
.spinner{border:3px solid rgba(255,255,255,0.3);border-radius:50%;border-top:3px solid white;width:30px;height:30px;animation:spin 1s linear infinite;margin:0 auto}
@keyframes spin{0%{transform:rotate(0deg)}100%{transform:rotate(360deg)}}
.firebase-status{background:rgba(76,175,80,0.2);border:1px solid rgba(76,175,80,0.5);color:#4CAF50;padding:10px;border-radius:8px;margin-bottom:20px;font-size:13px;text-align:center}
.forgot-container{display:none;text-align:center}
.forgot-container.active{display:block;animation:slideIn 0.5s ease}
.forgot-icon{font-size:4rem;margin-bottom:20px;color:#2196F3}
.forgot-title{font-size:1.5rem;margin-bottom:15px;color:#2196F3}
.forgot-text{margin-bottom:20px;opacity:0.8}
.back-btn{background:transparent;border:1px solid rgba(255,255,255,0.3);color:white;padding:10px 20px;border-radius:8px;cursor:pointer;transition:all 0.3s ease;margin-top:10px}
.back-btn:hover{background:rgba(255,255,255,0.1)}
@media (max-width:480px){.container{padding:30px 20px;margin:20px}.logo{font-size:2.5rem}.tab{padding:10px 15px;font-size:14px}}
</style>
</head>
<body>
<div class="container">
<div class="logo">ğŸ› ï¸ Tank Tools</div>
<div class="subtitle">Kuwait National Petroleum Company</div>
<div class="firebase-status">ğŸ”¥ Firebase Cloud Database - Real-time & Secure with Authentication</div>
<div id="mainContainer">
<div class="tab-container">
<button class="tab active" onclick="switchTab('login')">Login</button>
<button class="tab" onclick="switchTab('register')">Register</button>
</div>
<div id="loginForm" class="form-container active">
<form onsubmit="handleLogin(event)">
<div class="form-group">
<label for="loginUsername">ğŸ‘¤ Username:</label>
<div class="username-container">
<input type="text" id="loginUsername" class="username-input" placeholder="abc123" required pattern="[a-zA-Z]{3}[0-9]{3}" maxlength="6" autocomplete="username">
<div class="email-suffix">@knpc.com</div>
</div>
<div class="validation-message" id="loginUsernameMsg"></div>
</div>
<div class="form-group">
<label for="loginPassword">ğŸ”’ Password:</label>
<input type="password" id="loginPassword" placeholder="Enter your password" required autocomplete="current-password">
</div>
<div class="form-group">
<label><input type="checkbox" id="rememberMe" style="width:auto;margin-right:8px;">Remember me</label>
</div>
<button type="submit" class="btn btn-primary" id="loginBtn">ğŸš€ Login</button>
<a href="#" class="forgot-password-link" onclick="showForgotPassword()">ğŸ”‘ Forgot Password?</a>
<div class="loading" id="loginLoading"><div class="spinner"></div><div>Authenticating with Firebase...</div></div>
</form>
</div>
<div id="registerForm" class="form-container">
<form onsubmit="handleRegister(event)">
<div class="form-group">
<label for="fullName">ğŸ‘¤ Full Name:</label>
<input type="text" id="fullName" placeholder="Enter your full name" required minlength="3" autocomplete="name">
<div class="validation-message" id="fullNameMsg"></div>
</div>
<div class="form-group">
<label for="username">ğŸ“§ Username (Email):</label>
<div class="username-container">
<input type="text" id="username" class="username-input" placeholder="abc123" required pattern="[a-zA-Z]{3}[0-9]{3}" maxlength="6" autocomplete="username">
<div class="email-suffix">@knpc.com</div>
</div>
<div class="validation-message" id="usernameMsg"></div>
</div>
<div class="form-group">
<label for="password">ğŸ”’ Password:</label>
<input type="password" id="password" placeholder="Create a strong password" required minlength="8" autocomplete="new-password">
<div class="password-strength"><div class="password-strength-bar" id="strengthBar"></div></div>
<div class="validation-message" id="passwordMsg"></div>
</div>
<div class="form-group">
<label for="confirmPassword">ğŸ”’ Confirm Password:</label>
<input type="password" id="confirmPassword" placeholder="Confirm your password" required autocomplete="new-password">
<div class="validation-message" id="confirmPasswordMsg"></div>
</div>
<button type="submit" class="btn btn-primary" id="registerBtn">âœ¨ Create Account</button>
<div class="loading" id="registerLoading"><div class="spinner"></div><div>Creating account with Firebase Auth...</div></div>
</form>
</div>
</div>
<div id="forgotContainer" class="forgot-container">
<div class="forgot-icon">ğŸ”‘</div>
<div class="forgot-title">Reset Password</div>
<div class="forgot-text">Enter your username to reset your password</div>
<form onsubmit="handleForgotPassword(event)">
<div class="form-group">
<label for="forgotUsername">ğŸ‘¤ Username:</label>
<div class="username-container">
<input type="text" id="forgotUsername" class="username-input" placeholder="abc123" required pattern="[a-zA-Z]{3}[0-9]{3}" maxlength="6" autocomplete="username">
<div class="email-suffix">@knpc.com</div>
</div>
</div>
<button type="submit" class="btn btn-secondary" id="resetBtn">ğŸ“§ Send Reset Email</button>
<button type="button" class="btn btn-danger" onclick="contactAdmin()" style="margin-top:10px;">ğŸ“± Contact Admin</button>
<button type="button" class="back-btn" onclick="backToLogin()">Back to Login</button>
<div class="loading" id="forgotLoading"><div class="spinner"></div><div>Sending reset email...</div></div>
</form>
</div>
<div id="messageContainer"></div>
<div class="footer"><strong>ğŸ”¥ Firebase Powered with Authentication</strong><br>By <strong>Fahad - 17877</strong> | Version 5.0<br><small>Real-time cloud database with secure auth</small></div>
</div>

<script type="module">
// ØªØ­Ø¯ÙŠØ« Firebase imports Ù„ØªØ´Ù…Ù„ Authentication
import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
import { getFirestore, doc, getDoc, setDoc, updateDoc, collection, addDoc, serverTimestamp, query, where, getDocs } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, sendPasswordResetEmail, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';

const app = initializeApp({
    apiKey: "AIzaSyD7lJcoY33FEC9d6eWy67QIO9SV4lS24pg",
    authDomain: "tank-tools-knpc-c2d95.firebaseapp.com",
    projectId: "tank-tools-knpc-c2d95",
    storageBucket: "tank-tools-knpc-c2d95.firebasestorage.app",
    messagingSenderId: "510062594324",
    appId: "1:510062594324:web:b892fd02007a5ca2f0da01"
});

// ØªÙ‡ÙŠØ¦Ø© Firebase Services
window.db = getFirestore(app);
window.auth = getAuth(app);

// Firebase functions
window.doc = doc;
window.getDoc = getDoc;
window.setDoc = setDoc;
window.updateDoc = updateDoc;
window.collection = collection;
window.addDoc = addDoc;
window.serverTimestamp = serverTimestamp;
window.query = query;
window.where = where;
window.getDocs = getDocs;
window.signInWithEmailAndPassword = signInWithEmailAndPassword;
window.createUserWithEmailAndPassword = createUserWithEmailAndPassword;
window.sendPasswordResetEmail = sendPasswordResetEmail;
window.onAuthStateChanged = onAuthStateChanged;

console.log('ğŸ”¥ Firebase initialized successfully with Authentication!');

// Ù…Ø±Ø§Ù‚Ø¨Ø© Ø­Ø§Ù„Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
onAuthStateChanged(auth, (user) => {
    console.log('ğŸ” DEBUG - onAuthStateChanged triggered');
    console.log('ğŸ” DEBUG - User object:', user ? JSON.stringify({
        uid: user.uid,
        email: user.email,
        emailVerified: user.emailVerified,
        isAnonymous: user.isAnonymous,
        metadata: user.metadata
    }, null, 2) : 'null');
    
    if (user) {
        console.log('âœ… User is signed in:', user.email);
        console.log('ğŸ” DEBUG - User token:', user.uid);
        
        // ØªØ­Ù‚Ù‚ Ù…Ù† ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„ØªÙˆÙƒÙ†
        user.getIdToken().then(token => {
            console.log('ğŸ” DEBUG - Valid token available:', token.substring(0, 10) + '...');
        }).catch(error => {
            console.error('ğŸ” DEBUG - Token error:', error);
        });
    } else {
        console.log('âŒ User is signed out');
    }
});
</script>

<script>
const WHATSAPP_ADMIN = "96555222550";

// Ø¯Ø§Ù„Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù…Ø­Ø¯Ø«Ø© Ù…Ø¹ Firebase Auth
async function handleLogin(event) {
    event.preventDefault();
    const username = document.getElementById('loginUsername').value.trim();
    const password = document.getElementById('loginPassword').value;
    const rememberMe = document.getElementById('rememberMe').checked;
    const email = `${username}@knpc.com`;
    
    console.log('ğŸ” Login attempt for:', username);
    
    if (!username || !password) {
        showMessage('âŒ Please enter username and password', 'error');
        return;
    }
    
    showLoading('login', true);
    
    try {
        // Ù…Ø­Ø§ÙˆÙ„Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹ Ù…Ø¹ Firebase Auth
        let userCredential;
        try {
            console.log('ğŸ” DEBUG - Attempting Firebase Auth signIn with:', email);
            userCredential = await signInWithEmailAndPassword(auth, email, password);
        } catch (authError) {
            console.error('ğŸ” DEBUG - Auth error:', authError.code, authError.message);
            
            // Ø¥Ø°Ø§ ÙØ´Ù„ Firebase AuthØŒ ØªØ­Ù‚Ù‚ Ù…Ù† Admin Ø£Ùˆ Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯
            if (username === 'fam030' && password === 'admin123') {
                // Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Admin Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù…ÙˆØ¬ÙˆØ¯
                try {
                    console.log('ğŸ” DEBUG - Creating admin account in Firebase Auth');
                    userCredential = await createUserWithEmailAndPassword(auth, email, password);
                    console.log('âœ… Admin account created in Firebase Auth');
                } catch (createError) {
                    console.error('ğŸ” DEBUG - Admin creation error:', createError.code, createError.message);
                    
                    if (createError.code === 'auth/email-already-in-use') {
                        // Ø§Ù„Ø­Ø³Ø§Ø¨ Ù…ÙˆØ¬ÙˆØ¯ØŒ Ù…Ø­Ø§ÙˆÙ„Ø© ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰
                        console.log('ğŸ” DEBUG - Admin account exists, trying login again');
                        userCredential = await signInWithEmailAndPassword(auth, email, password);
                    } else {
                        throw createError;
                    }
                }
            } else {
                // Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø§Ù„Ø¹Ø§Ø¯ÙŠÙŠÙ†ØŒ ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯Ù‡Ù… ÙÙŠ Firestore
                const userDocRef = doc(db, 'users', username);
                console.log('ğŸ” DEBUG - Checking Firestore path:', `users/${username}`);
                const userDoc = await getDoc(userDocRef);
                
                if (!userDoc.exists()) {
                    showMessage('âŒ User not found. Please register first.', 'error');
                    return;
                }
                
                const userData = userDoc.data();
                if (userData.password !== password) {
                    showMessage('âŒ Invalid password', 'error');
                    await addActivity('failed_login_attempt', username);
                    return;
                }
                
                // Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ ÙÙŠ Firebase Auth Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…
                try {
                    console.log('ğŸ” DEBUG - Creating user account in Firebase Auth');
                    userCredential = await createUserWithEmailAndPassword(auth, email, password);
                    console.log('âœ… User account created in Firebase Auth');
                } catch (createError) {
                    console.error('ğŸ” DEBUG - User creation error:', createError.code, createError.message);
                    
                    if (createError.code === 'auth/email-already-in-use') {
                        console.log('ğŸ” DEBUG - User account exists, trying login again');
                        userCredential = await signInWithEmailAndPassword(auth, email, password);
                    } else {
                        throw createError;
                    }
                }
            }
        }
        
        const user = userCredential.user;
        console.log('âœ… Firebase Auth successful for:', user.email);
        console.log('ğŸ” DEBUG - User object after login:', JSON.stringify({
            uid: user.uid,
            email: user.email,
            emailVerified: user.emailVerified
        }, null, 2));
        
        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙÙŠ Firestore
        const userDocRef = doc(db, 'users', username);
        console.log('ğŸ” DEBUG - Checking user data in Firestore path:', `users/${username}`);
        const userDoc = await getDoc(userDocRef);
        
        let userData;
        if (!userDoc.exists()) {
            // Ø¥Ù†Ø´Ø§Ø¡ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„Ù€ Admin Ø¥Ø°Ø§ Ù„Ù… ØªÙƒÙ† Ù…ÙˆØ¬ÙˆØ¯Ø©
            if (username === 'fam030') {
                userData = {
                    id: 1,
                    username: 'fam030',
                    fullName: 'Fahad Admin',
                    email: 'fam030@knpc.com',
                    role: 'admin',
                    isActive: true,
                    createdAt: serverTimestamp(),
                    lastLogin: serverTimestamp()
                };
                console.log('ğŸ” DEBUG - Creating admin data in Firestore path:', `users/${username}`);
                await setDoc(userDocRef, userData);
                console.log('âœ… Admin data created in Firestore');
            } else {
                showMessage('âŒ User data not found. Please contact admin.', 'error');
                return;
            }
        } else {
            userData = userDoc.data();
            console.log('ğŸ” DEBUG - User data found:', JSON.stringify(userData, null, 2));
            
            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø­Ø³Ø§Ø¨ Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø§Ù„Ø¹Ø§Ø¯ÙŠÙŠÙ†
            if (!userData.isActive && username !== 'fam030') {
                showMessage('â³ Your account is pending admin approval. Please wait for activation.', 'warning');
                setTimeout(() => {
                    const messageContainer = document.getElementById('messageContainer');
                    messageContainer.innerHTML += `<div class="message info show" style="margin-top: 10px;"><div style="margin-bottom: 10px;">ğŸ“ Need help? Contact admin:</div><button class="btn btn-secondary" onclick="contactAdminForActivation('${username}', '${userData.fullName || username}')" style="width: 100%; margin-top: 0;">ğŸ“± Contact Admin for Activation</button></div>`;
                }, 1000);
                return;
            }
            
            // ØªØ­Ø¯ÙŠØ« ÙˆÙ‚Øª Ø¢Ø®Ø± Ø¯Ø®ÙˆÙ„
            console.log('ğŸ” DEBUG - Updating lastLogin in Firestore path:', `users/${username}`);
            await updateDoc(userDocRef, {
                lastLogin: serverTimestamp()
            });
        }
        
        // Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¬Ù„Ø³Ø©
        const sessionUserData = {
            uid: user.uid,
            id: userData.id || Date.now(),
            username: userData.username,
            fullName: userData.fullName,
            email: userData.email,
            role: userData.role || 'user',
            isActive: userData.isActive,
            loginTime: new Date().toISOString()
        };
        
        console.log('ğŸ” DEBUG - Saving session data:', JSON.stringify(sessionUserData, null, 2));
        localStorage.setItem('tanktools_current_user', JSON.stringify(sessionUserData));
        sessionStorage.setItem('tanktools_session', 'active');
        
        if (rememberMe) {
            localStorage.setItem('tanktools_remember', JSON.stringify({
                username: username,
                rememberMe: true
            }));
        }
        
        await addActivity('user_login', username);
        console.log('âœ… Login successful for:', username);
        
        showMessage('âœ… Login successful! Redirecting...', 'success');
        
        setTimeout(() => {
            const redirect = sessionStorage.getItem('tanktools_redirect');
            if (redirect) {
                sessionStorage.removeItem('tanktools_redirect');
                window.location.href = redirect;
            } else {
                const defaultUrl = userData.role === 'admin' ? 'dashboard.html' : 'index.html';
                window.location.href = defaultUrl;
            }
        }, 1500);
        
    } catch (error) {
        console.error('âŒ Login error:', error);
        console.error('ğŸ” DEBUG - Detailed error:', JSON.stringify({
            code: error.code,
            message: error.message,
            stack: error.stack
        }, null, 2));
        
        let errorMessage = 'Login failed';
        
        switch (error.code) {
            case 'auth/user-not-found':
                errorMessage = 'User not found. Please register first.';
                break;
            case 'auth/wrong-password':
                errorMessage = 'Invalid password.';
                break;
            case 'auth/invalid-email':
                errorMessage = 'Invalid email format.';
                break;
            case 'auth/too-many-requests':
                errorMessage = 'Too many failed attempts. Please try again later.';
                break;
            default:
                errorMessage = error.message;
        }
        
        showMessage(`âŒ ${errorMessage}`, 'error');
    } finally {
        showLoading('login', false);
    }
}

// Ø¯Ø§Ù„Ø© Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù…Ø­Ø¯Ø«Ø© Ù…Ø¹ Firebase Auth
async function handleRegister(event) {
    event.preventDefault();
    const fullName = document.getElementById('fullName').value.trim();
    const username = document.getElementById('username').value.trim();
    const password = document.getElementById('password').value;
    const confirmPassword = document.getElementById('confirmPassword').value;
    const email = `${username}@knpc.com`;
    
    console.log('ğŸ“ Registration attempt for:', username);
    
    if (!fullName || !username || !password || !confirmPassword) {
        showMessage('âŒ Please fill all fields', 'error');
        return;
    }
    
    if (password !== confirmPassword) {
        showMessage('âŒ Passwords do not match', 'error');
        return;
    }
    
    if (password.length < 8) {
        showMessage('âŒ Password must be at least 8 characters', 'error');
        return;
    }
    
    showLoading('register', true);
    
    try {
        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙÙŠ Firestore Ø£ÙˆÙ„Ø§Ù‹
        const userDocRef = doc(db, 'users', username);
        console.log('ğŸ” DEBUG - Checking if user exists in Firestore path:', `users/${username}`);
        const userDoc = await getDoc(userDocRef);
        
        if (userDoc.exists()) {
            showMessage('âŒ Username already exists. Please choose another.', 'error');
            return;
        }
        
        // Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ ÙÙŠ Firebase Auth
        console.log('ğŸ” DEBUG - Creating account in Firebase Auth for:', email);
        const userCredential = await createUserWithEmailAndPassword(auth, email, password);
        const user = userCredential.user;
        
        console.log('âœ… Firebase Auth account created:', user.email);
        
        // Ø¥Ù†Ø´Ø§Ø¡ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙÙŠ Firestore
        const userData = {
            id: Date.now(),
            username: username,
            fullName: fullName,
            email: email,
            password: password, // ÙŠÙ…ÙƒÙ† Ø¥Ø²Ø§Ù„ØªÙ‡ Ù„Ø§Ø­Ù‚Ø§Ù‹ Ù„Ø£Ù† Firebase Auth ÙŠØ¯ÙŠØ± ÙƒÙ„Ù…Ø§Øª Ø§Ù„Ù…Ø±ÙˆØ±
            role: 'user',
            isActive: false, // ÙŠØ­ØªØ§Ø¬ Ù…ÙˆØ§ÙÙ‚Ø© Ø§Ù„Ø£Ø¯Ù…Ù†
            createdAt: serverTimestamp(),
            emailVerified: false,
            firebaseUID: user.uid
        };
        
        console.log('ğŸ” DEBUG - Creating user data in Firestore path:', `users/${username}`);
        await setDoc(userDocRef, userData);
        await addActivity('user_registered', username);
        
        console.log('âœ… User registered successfully in Firestore');
        
        showMessage('âœ… Registration successful! Your account is pending admin approval. You will be able to login once approved.', 'success');
        
        setTimeout(() => {
            const messageContainer = document.getElementById('messageContainer');
            messageContainer.innerHTML += `<div class="message info show" style="margin-top: 10px;"><div style="margin-bottom: 10px;">ğŸ“ Need faster approval? Contact admin directly:</div><button class="btn btn-secondary" onclick="contactAdminForActivation('${username}', '${fullName}')" style="width: 100%; margin-top: 0;">ğŸ“± Contact Admin for Activation</button></div>`;
        }, 1000);
        
        // Ù…Ø³Ø­ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬
        document.getElementById('fullName').value = '';
        document.getElementById('username').value = '';
        document.getElementById('password').value = '';
        document.getElementById('confirmPassword').value = '';
        
        setTimeout(() => {
            switchTabDirect('login');
            showMessage('â„¹ï¸ Please wait for admin approval before attempting to login.', 'info');
        }, 3000);
        
    } catch (error) {
        console.error('âŒ Registration error:', error);
        console.error('ğŸ” DEBUG - Detailed registration error:', JSON.stringify({
            code: error.code,
            message: error.message,
            stack: error.stack
        }, null, 2));
        
        let errorMessage = 'Registration failed';
        
        switch (error.code) {
            case 'auth/email-already-in-use':
                errorMessage = 'Email already in use. Please choose another username.';
                break;
            case 'auth/weak-password':
                errorMessage = 'Password is too weak. Please choose a stronger password.';
                break;
            case 'auth/invalid-email':
                errorMessage = 'Invalid email format.';
                break;
            default:
                errorMessage = error.message;
        }
        
        showMessage(`âŒ ${errorMessage}`, 'error');
    } finally {
        showLoading('register', false);
    }
}

// Ø¯Ø§Ù„Ø© Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ù…Ø­Ø¯Ø«Ø©
async function handleForgotPassword(event) {
    event.preventDefault();
    const username = document.getElementById('forgotUsername').value.trim();
    const email = `${username}@knpc.com`;
    
    if (!username) {
        showMessage('âŒ Please enter your username', 'error');
        return;
    }
    
    showLoading('forgot', true);
    
    try {
        console.log('ğŸ” DEBUG - Sending password reset email to:', email);
        await sendPasswordResetEmail(auth, email);
        showMessage('âœ… Password reset email sent. Check your inbox.', 'success');
        
        setTimeout(() => {
            backToLogin();
        }, 3000);
    } catch (error) {
        console.error('âŒ Forgot password error:', error);
        console.error('ğŸ” DEBUG - Detailed reset error:', JSON.stringify({
            code: error.code,
            message: error.message
        }, null, 2));
        
        let errorMessage = 'Failed to send reset email';
        
        switch (error.code) {
            case 'auth/user-not-found':
                errorMessage = 'No account found with this email.';
                break;
            case 'auth/invalid-email':
                errorMessage = 'Invalid email format.';
                break;
            default:
                errorMessage = error.message;
        }
        
        showMessage(`âŒ ${errorMessage}`, 'error');
    } finally {
        showLoading('forgot', false);
    }
}

// Ø¯Ø§Ù„Ø© Ø¥Ø¶Ø§ÙØ© Ù†Ø´Ø§Ø· ÙÙŠ Firestore
async function addActivity(type, username) {
    try {
        const activityData = {
            type: type,
            username: username,
            timestamp: serverTimestamp(),
            userAgent: navigator.userAgent,
            ipAddress: 'client-side'
        };
        
        console.log('ğŸ” DEBUG - Adding activity to Firestore path: activities');
        const activityRef = collection(db, 'activities');
        await addDoc(activityRef, activityData);
        console.log('âœ… Activity logged:', type);
    } catch (error) {
        console.error('âŒ Failed to log activity:', error);
    }
}

// Ø¯Ø§Ù„Ø© Ø§Ù„ØªÙˆØ§ØµÙ„ Ù…Ø¹ Ø§Ù„Ø£Ø¯Ù…Ù†
function contactAdmin() {
    const message = `Hello Admin, I need help with my Tank Tools account. Please assist.`;
    const whatsappUrl = `https://wa.me/${WHATSAPP_ADMIN}?text=${encodeURIComponent(message)}`;
    window.open(whatsappUrl, '_blank');
}

// Ø¯Ø§Ù„Ø© Ø§Ù„ØªÙˆØ§ØµÙ„ Ù…Ø¹ Ø§Ù„Ø£Ø¯Ù…Ù† Ù„ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø­Ø³Ø§Ø¨
function contactAdminForActivation(username, fullName) {
    const message = `Hello Admin, I just registered for Tank Tools with username: ${username} and name: ${fullName}. Please activate my account. Thank you!`;
    const whatsappUrl = `https://wa.me/${WHATSAPP_ADMIN}?text=${encodeURIComponent(message)}`;
    window.open(whatsappUrl, '_blank');
}

// Ø¯Ø§Ù„Ø© ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„ØªØ¨ÙˆÙŠØ¨Ø§Øª
function switchTab(tab) {
    const loginForm = document.getElementById('loginForm');
    const registerForm = document.getElementById('registerForm');
    const forgotContainer = document.getElementById('forgotContainer');
    const loginTab = document.querySelector('.tab:nth-child(1)');
    const registerTab = document.querySelector('.tab:nth-child(2)');
    
    if (tab === 'login') {
        loginForm.classList.add('active');
        registerForm.classList.remove('active');
        forgotContainer.classList.remove('active');
        loginTab.classList.add('active');
        registerTab.classList.remove('active');
    } else if (tab === 'register') {
        loginForm.classList.remove('active');
        registerForm.classList.add('active');
        forgotContainer.classList.remove('active');
        loginTab.classList.remove('active');
        registerTab.classList.add('active');
    }
}

// Ø¯Ø§Ù„Ø© ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„ØªØ¨ÙˆÙŠØ¨Ø§Øª Ø§Ù„Ù…Ø¨Ø§Ø´Ø±Ø©
function switchTabDirect(tab) {
    switchTab(tab);
}

// Ø¯Ø§Ù„Ø© Ø¥Ø¸Ù‡Ø§Ø± Ù†Ù…ÙˆØ°Ø¬ Ù†Ø³ÙŠØª ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±
function showForgotPassword() {
    const mainContainer = document.getElementById('mainContainer');
    const forgotContainer = document.getElementById('forgotContainer');
    
    mainContainer.style.display = 'none';
    forgotContainer.classList.add('active');
}

// Ø¯Ø§Ù„Ø© Ø§Ù„Ø¹ÙˆØ¯Ø© Ø¥Ù„Ù‰ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
function backToLogin() {
    const mainContainer = document.getElementById('mainContainer');
    const forgotContainer = document.getElementById('forgotContainer');
    
    mainContainer.style.display = 'block';
    forgotContainer.classList.remove('active');
    switchTab('login');
}

// Ø¯Ø§Ù„Ø© Ø¥Ø¸Ù‡Ø§Ø± Ø±Ø³Ø§Ù„Ø©
function showMessage(text, type) {
    const messageContainer = document.getElementById('messageContainer');
    messageContainer.innerHTML = `<div class="message ${type} show">${text}</div>`;
    
    setTimeout(() => {
        const message = messageContainer.querySelector('.message');
        if (message) {
            message.classList.remove('show');
            setTimeout(() => {
                messageContainer.innerHTML = '';
            }, 300);
        }
    }, 5000);
}

// Ø¯Ø§Ù„Ø© Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„ØªØ­Ù…ÙŠÙ„
function showLoading(form, show) {
    const loading = document.getElementById(`${form}Loading`);
    if (loading) {
        loading.style.display = show ? 'block' : 'none';
    }
}

// Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø¬Ù„Ø³Ø© Ù†Ø´Ø·Ø© Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
document.addEventListener('DOMContentLoaded', () => {
    console.log('ğŸ” DEBUG - Page loaded, checking session');
    
    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø¬Ù„Ø³Ø© ÙÙŠ localStorage
    const session = sessionStorage.getItem('tanktools_session');
    const userData = localStorage.getItem('tanktools_current_user');
    
    console.log('ğŸ” DEBUG - Session status:', session);
    console.log('ğŸ” DEBUG - User data exists:', !!userData);
    
    if (session === 'active' && userData) {
        console.log('ğŸ” DEBUG - Active session found, redirecting');
        const user = JSON.parse(userData);
        const defaultUrl = user.role === 'admin' ? 'dashboard.html' : 'index.html';
        
        // ØªØ£Ø®ÙŠØ± Ù‚Ù„ÙŠÙ„ Ù„Ù„Ø³Ù…Ø§Ø­ Ø¨ØªØ­Ù…ÙŠÙ„ Firebase Auth
        setTimeout(() => {
            window.location.href = defaultUrl;
        }, 500);
    } else {
        console.log('ğŸ” DEBUG - No active session found');
        
        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† "ØªØ°ÙƒØ±Ù†ÙŠ"
        const remember = localStorage.getItem('tanktools_remember');
        if (remember) {
            const rememberData = JSON.parse(remember);
            if (rememberData.rememberMe) {
                document.getElementById('loginUsername').value = rememberData.username;
                document.getElementById('rememberMe').checked = true;
            }
        }
    }
});

// ØªØ­Ù‚Ù‚ Ù…Ù† Ù‚ÙˆØ© ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±
document.getElementById('password')?.addEventListener('input', function() {
    const password = this.value;
    const strengthBar = document.getElementById('strengthBar');
    
    if (password.length === 0) {
        strengthBar.className = 'password-strength-bar';
        strengthBar.style.width = '0%';
        return;
    }
    
    let strength = 0;
    
    // Ø·ÙˆÙ„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±
    if (password.length >= 8) strength += 1;
    if (password.length >= 12) strength += 1;
    
    // ØªØ¹Ù‚ÙŠØ¯ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±
    if (/[A-Z]/.test(password)) strength += 1;
    if (/[a-z]/.test(password)) strength += 1;
    if (/[0-9]/.test(password)) strength += 1;
    if (/[^A-Za-z0-9]/.test(password)) strength += 1;
    
    // ØªØ¹ÙŠÙŠÙ† Ø§Ù„ÙØ¦Ø© Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ù‚ÙˆØ©
    strengthBar.className = 'password-strength-bar';
    if (strength <= 2) {
        strengthBar.classList.add('strength-weak');
    } else if (strength <= 4) {
        strengthBar.classList.add('strength-fair');
    } else if (strength <= 6) {
        strengthBar.classList.add('strength-good');
    } else {
        strengthBar.classList.add('strength-strong');
    }
});
</script>
</body>
</html>
