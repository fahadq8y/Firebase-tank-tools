<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Tank Tools</title>
<link rel="manifest" href="/manifest.json">
<link rel="icon" href="icon.png" type="image/png">
<meta name="theme-color" content="#003366">
<style>
*{margin:0;padding:0;box-sizing:border-box}body{background:linear-gradient(rgba(0,0,0,0.5),rgba(0,0,0,0.5)),url('background.jpg');background-size:cover;background-position:center;background-attachment:fixed;font-family:Arial,sans-serif;min-height:100vh;display:flex;justify-content:center;align-items:center;color:white}
.container{background:rgba(255,255,255,0.1);backdrop-filter:blur(10px);border-radius:15px;padding:40px;box-shadow:0 8px 32px rgba(0,0,0,0.3);border:1px solid rgba(255,255,255,0.2);width:100%;max-width:450px;text-align:center;position:relative;overflow:hidden}
.container::before{content:'';position:absolute;top:0;left:-100%;width:100%;height:100%;background:linear-gradient(90deg,transparent,rgba(255,255,255,0.1),transparent);transition:0.5s}
.container:hover::before{left:100%}
.logo{font-size:3rem;margin-bottom:10px;background:linear-gradient(45deg,#FFD700,#FFA500);-webkit-background-clip:text;-webkit-text-fill-color:transparent;animation:pulse 2s ease-in-out infinite}
@keyframes pulse{0%,100%{transform:scale(1)}50%{transform:scale(1.05)}}
.subtitle{font-size:1.2rem;margin-bottom:30px;opacity:0.9;font-weight:300}
.tab-container{display:flex;margin-bottom:30px;background:rgba(255,255,255,0.1);border-radius:10px;padding:5px}
.tab{flex:1;padding:12px 20px;border:none;background:transparent;color:white;cursor:pointer;border-radius:8px;transition:all 0.3s ease;font-weight:500}
.tab.active{background:linear-gradient(45deg,#4CAF50,#45a049);box-shadow:0 5px 15px rgba(76,175,80,0.3);transform:translateY(-2px)}
.form-container{display:none}
.form-container.active{display:block;animation:slideIn 0.5s ease}
@keyframes slideIn{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:translateY(0)}}
.form-group{margin-bottom:20px;text-align:left}
label{display:block;margin-bottom:8px;font-weight:500;color:rgba(255,255,255,0.9)}
input{width:100%;padding:15px;border:none;border-radius:10px;background:rgba(255,255,255,0.9);color:#003366;font-size:16px;transition:all 0.3s ease;border:2px solid transparent;box-shadow:0 2px 5px rgba(0,0,0,0.3)}
input::placeholder{color:rgba(0,51,102,0.6)}
input:focus{outline:none;background:rgba(255,255,255,1);border-color:#4CAF50;transform:translateY(-2px);box-shadow:0 5px 15px rgba(0,0,0,0.2)}
.username-container{display:flex;align-items:center;background:rgba(255,255,255,0.9);border-radius:10px;border:2px solid transparent;transition:all 0.3s ease;box-shadow:0 2px 5px rgba(0,0,0,0.3)}
.username-container:focus-within{background:rgba(255,255,255,1);border-color:#4CAF50;transform:translateY(-2px);box-shadow:0 5px 15px rgba(0,0,0,0.2)}
.username-input{background:transparent;border:none;padding:15px;flex:1;box-shadow:none;transform:none;color:#003366}
.username-input:focus{background:transparent;border:none;box-shadow:none;transform:none}
.email-suffix{padding:15px;color:#003366;font-weight:500;background:rgba(0,51,102,0.1);border-radius:0 8px 8px 0}
.validation-message{margin-top:5px;font-size:12px;color:#ff6b6b;opacity:0;transition:opacity 0.3s ease}
.validation-message.show{opacity:1}
.validation-message.success{color:#4CAF50}
.password-strength{margin-top:8px;height:4px;background:rgba(255,255,255,0.2);border-radius:2px;overflow:hidden}
.password-strength-bar{height:100%;width:0%;transition:all 0.3s ease;border-radius:2px}
.strength-weak{background:#ff6b6b;width:25%}
.strength-fair{background:#ffa726;width:50%}
.strength-good{background:#42a5f5;width:75%}
.strength-strong{background:#4CAF50;width:100%}
.btn{width:100%;padding:15px;border:none;border-radius:10px;font-size:18px;font-weight:600;cursor:pointer;transition:all 0.3s ease;margin-top:20px;position:relative;overflow:hidden}
.btn-primary{background:linear-gradient(45deg,#4CAF50,#45a049);color:white}
.btn-secondary{background:linear-gradient(45deg,#2196F3,#1976D2);color:white;margin-top:10px;font-size:14px;padding:10px}
.btn-danger{background:linear-gradient(45deg,#f44336,#d32f2f);color:white;margin-top:10px;font-size:14px;padding:10px}
.btn:hover{transform:translateY(-3px);box-shadow:0 15px 30px rgba(76,175,80,0.4)}
.btn:disabled{background:#ccc;cursor:not-allowed;transform:none}
.btn::before{content:'';position:absolute;top:0;left:-100%;width:100%;height:100%;background:linear-gradient(90deg,transparent,rgba(255,255,255,0.2),transparent);transition:0.5s}
.btn:hover::before{left:100%}
.forgot-password-link{color:#2196F3;text-decoration:none;font-size:14px;display:block;margin-top:15px;transition:all 0.3s ease}
.forgot-password-link:hover{color:#1976D2;text-shadow:0 0 5px rgba(33,150,243,0.5)}
.message{margin-top:15px;padding:12px;border-radius:8px;font-size:14px;opacity:0;transform:translateY(-10px);transition:all 0.3s ease}
.message.show{opacity:1;transform:translateY(0)}
.message.success{background:rgba(76,175,80,0.2);border:1px solid rgba(76,175,80,0.5);color:#4CAF50}
.message.error{background:rgba(255,107,107,0.2);border:1px solid rgba(255,107,107,0.5);color:#ff6b6b}
.message.info{background:rgba(33,150,243,0.2);border:1px solid rgba(33,150,243,0.5);color:#2196F3}
.message.warning{background:rgba(255,193,7,0.2);border:1px solid rgba(255,193,7,0.5);color:#ffc107}
.footer{margin-top:30px;font-size:12px;opacity:0.7;text-align:center}
.loading{display:none;margin-top:10px}
.spinner{border:3px solid rgba(255,255,255,0.3);border-radius:50%;border-top:3px solid white;width:30px;height:30px;animation:spin 1s linear infinite;margin:0 auto}
@keyframes spin{0%{transform:rotate(0deg)}100%{transform:rotate(360deg)}}
.firebase-status{background:rgba(76,175,80,0.2);border:1px solid rgba(76,175,80,0.5);color:#4CAF50;padding:10px;border-radius:8px;margin-bottom:20px;font-size:13px;text-align:center}
.forgot-container{display:none;text-align:center}
.forgot-container.active{display:block;animation:slideIn 0.5s ease}
.forgot-icon{font-size:4rem;margin-bottom:20px;color:#2196F3}
.forgot-title{font-size:1.5rem;margin-bottom:15px;color:#2196F3}
.forgot-text{margin-bottom:20px;opacity:0.8}
.back-btn{background:transparent;border:1px solid rgba(255,255,255,0.3);color:white;padding:10px 20px;border-radius:8px;cursor:pointer;transition:all 0.3s ease;margin-top:10px}
.back-btn:hover{background:rgba(255,255,255,0.1)}
@media (max-width:480px){.container{padding:30px 20px;margin:20px}.logo{font-size:2.5rem}.tab{padding:10px 15px;font-size:14px}}
</style>
</head>
<body>
<div class="container">
<div class="logo">üõ†Ô∏è Tank Tools</div>
<div class="subtitle">Kuwait National Petroleum Company</div>
<div class="firebase-status">üî• Firebase Authentication Enabled & Secured</div>
<div id="mainContainer">
<div class="tab-container">
<button class="tab active" onclick="switchTab('login')">Login</button>
<button class="tab" onclick="switchTab('register')">Register</button>
</div>
<div id="loginForm" class="form-container active">
<form onsubmit="handleLogin(event)">
<div class="form-group">
<label for="loginUsername">üë§ Username:</label>
<div class="username-container">
<input type="text" id="loginUsername" class="username-input" placeholder="abc123" required pattern="[a-zA-Z]{3}[0-9]{3}" maxlength="6" autocomplete="username">
<div class="email-suffix">@knpc.com</div>
</div>
<div class="validation-message" id="loginUsernameMsg"></div>
</div>
<div class="form-group">
<label for="loginPassword">üîí Password:</label>
<input type="password" id="loginPassword" placeholder="Enter your password" required autocomplete="current-password">
</div>
<div class="form-group">
<label><input type="checkbox" id="rememberMe" style="width:auto;margin-right:8px;">Remember me</label>
</div>
<button type="submit" class="btn btn-primary" id="loginBtn">üöÄ Login</button>
<a href="#" class="forgot-password-link" onclick="showForgotPassword()">üîë Forgot Password?</a>
<div class="loading" id="loginLoading"><div class="spinner"></div><div>Authenticating...</div></div>
</form>
</div>
<div id="registerForm" class="form-container">
<form onsubmit="handleRegister(event)">
<div class="form-group">
<label for="fullName">üë§ Full Name:</label>
<input type="text" id="fullName" placeholder="Enter your full name" required minlength="3" autocomplete="name">
<div class="validation-message" id="fullNameMsg"></div>
</div>
<div class="form-group">
<label for="username">üìß Username (Email):</label>
<div class="username-container">
<input type="text" id="username" class="username-input" placeholder="abc123" required pattern="[a-zA-Z]{3}[0-9]{3}" maxlength="6" autocomplete="username">
<div class="email-suffix">@knpc.com</div>
</div>
<div class="validation-message" id="usernameMsg"></div>
</div>
<div class="form-group">
<label for="password">üîí Password:</label>
<input type="password" id="password" placeholder="Create a strong password" required minlength="8" autocomplete="new-password">
<div class="password-strength"><div class="password-strength-bar" id="strengthBar"></div></div>
<div class="validation-message" id="passwordMsg"></div>
</div>
<div class="form-group">
<label for="confirmPassword">üîí Confirm Password:</label>
<input type="password" id="confirmPassword" placeholder="Confirm your password" required autocomplete="new-password">
<div class="validation-message" id="confirmPasswordMsg"></div>
</div>
<button type="submit" class="btn btn-primary" id="registerBtn">‚ú® Create Account</button>
<div class="loading" id="registerLoading"><div class="spinner"></div><div>Creating account...</div></div>
</form>
</div>
</div>
<div id="forgotContainer" class="forgot-container">
<div class="forgot-icon">üîë</div>
<div class="forgot-title">Reset Password</div>
<div class="forgot-text">Enter your username to reset your password</div>
<form onsubmit="handleForgotPassword(event)">
<div class="form-group">
<label for="forgotUsername">üë§ Username:</label>
<div class="username-container">
<input type="text" id="forgotUsername" class="username-input" placeholder="abc123" required pattern="[a-zA-Z]{3}[0-9]{3}" maxlength="6" autocomplete="username">
<div class="email-suffix">@knpc.com</div>
</div>
</div>
<button type="submit" class="btn btn-secondary" id="resetBtn">üìß Send Reset Email</button>
<button type="button" class="btn btn-danger" onclick="contactAdmin()" style="margin-top:10px;">üì± Contact Admin</button>
<button type="button" class="back-btn" onclick="backToLogin()">Back to Login</button>
<div class="loading" id="forgotLoading"><div class="spinner"></div><div>Sending email...</div></div>
</form>
</div>
<div id="messageContainer"></div>
<div class="footer"><strong>üî• Firebase Secured</strong><br>By <strong>Fahad - 17877</strong> | Version 6.0<br><small>Real-time & Protected</small></div>
</div>

<script type="module">
import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
import { getFirestore, doc, getDoc, setDoc, updateDoc, collection, addDoc, serverTimestamp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, sendPasswordResetEmail, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';

const app = initializeApp({
    apiKey: "AIzaSyD7lJcoY33FEC9d6eWy67QIO9SV4lS24pg",
    authDomain: "tank-tools-knpc-c2d95.firebaseapp.com",
    projectId: "tank-tools-knpc-c2d95",
    storageBucket: "tank-tools-knpc-c2d95.firebasestorage.app",
    messagingSenderId: "510062594324",
    appId: "1:510062594324:web:b892fd02007a5ca2f0da01"
});

window.db = getFirestore(app);
window.auth = getAuth(app);
window.doc = doc;
window.getDoc = getDoc;
window.setDoc = setDoc;
window.updateDoc = updateDoc;
window.collection = collection;
window.addDoc = addDoc;
window.serverTimestamp = serverTimestamp;
window.signInWithEmailAndPassword = signInWithEmailAndPassword;
window.createUserWithEmailAndPassword = createUserWithEmailAndPassword;
window.sendPasswordResetEmail = sendPasswordResetEmail;

console.log('üî• Firebase initialized successfully with Authentication!');

onAuthStateChanged(auth, (user) => {
    if (user) {
        console.log('‚úÖ User authenticated:', user.email);
    } else {
        console.log('‚ùå User signed out');
    }
});
</script>

<script>
const WHATSAPP_ADMIN = "96555222550";

async function handleLogin(event) {
    event.preventDefault();
    const username = document.getElementById('loginUsername').value.trim();
    const password = document.getElementById('loginPassword').value;
    const rememberMe = document.getElementById('rememberMe').checked;
    const email = `${username}@knpc.com`;
    
    if (!username || !password) {
        showMessage('‚ùå Please enter username and password', 'error');
        return;
    }
    
    showLoading('login', true);
    
    try {
        // ÿ£ŸàŸÑÿßŸã: ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ŸÅŸä Firestore
        const userDocRef = doc(db, 'users', username);
        const userDoc = await getDoc(userDocRef);
        
        if (!userDoc.exists()) {
            showMessage('‚ùå User not found. Please register first.', 'error');
            return;
        }
        
        const userData = userDoc.data();
        console.log('User data found:', userData);
        
        // ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ŸÉŸÑŸÖÿ© ÿßŸÑŸÖÿ±Ÿàÿ± ŸÅŸä Firestore
        if (userData.password !== password) {
            showMessage('‚ùå Invalid password', 'error');
            await addActivity('failed_login_attempt', username);
            return;
        }
        
        // ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿ™ŸÅÿπŸäŸÑ ÿßŸÑÿ≠ÿ≥ÿßÿ®
        if (!userData.isActive && username !== 'fam030') {
            showMessage('‚è≥ Your account is pending admin approval.', 'warning');
            setTimeout(() => {
                const messageContainer = document.getElementById('messageContainer');
                messageContainer.innerHTML += `<div class="message info show" style="margin-top: 10px;"><button class="btn btn-secondary" onclick="contactAdminForActivation('${username}', '${userData.fullName}')" style="width: 100%;">üì± Contact Admin for Activation</button></div>`;
            }, 1000);
            return;
        }
        
        // ŸÖÿ≠ÿßŸàŸÑÿ© ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ ŸÅŸä Firebase Auth
        let userCredential;
        try {
            userCredential = await signInWithEmailAndPassword(auth, email, password);
        } catch (authError) {
            // ÿ•ÿ∞ÿß ŸÅÿ¥ŸÑ ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑÿå ÿ•ŸÜÿ¥ÿßÿ° ÿ≠ÿ≥ÿßÿ® ÿ¨ÿØŸäÿØ ŸÅŸä Firebase Auth
            if (authError.code === 'auth/user-not-found' || authError.code === 'auth/invalid-credential') {
                try {
                    userCredential = await createUserWithEmailAndPassword(auth, email, password);
                    console.log('‚úÖ New Firebase Auth account created for existing user');
                } catch (createError) {
                    if (createError.code === 'auth/email-already-in-use') {
                        // ÿ•ÿ∞ÿß ŸÉÿßŸÜ ÿßŸÑÿ≠ÿ≥ÿßÿ® ŸÖŸàÿ¨ŸàÿØ ŸÑŸÉŸÜ ŸÉŸÑŸÖÿ© ÿßŸÑŸÖÿ±Ÿàÿ± ŸÖÿÆÿ™ŸÑŸÅÿ©
                        showMessage('‚ùå Account exists with different password. Please reset password.', 'error');
                        return;
                    }
                    throw createError;
                }
            } else {
                throw authError;
            }
        }
        
        // ÿ™ÿ≠ÿØŸäÿ´ ÿ¢ÿÆÿ± ÿ™ÿ≥ÿ¨ŸäŸÑ ÿØÿÆŸàŸÑ
        await updateDoc(userDocRef, {
            lastLogin: serverTimestamp()
        });
        
        // ÿ≠ŸÅÿ∏ ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑÿ¨ŸÑÿ≥ÿ©
        const sessionUserData = {
            uid: userCredential.user.uid,
            id: userData.id || Date.now(),
            username: userData.username,
            fullName: userData.fullName,
            email: userData.email,
            role: userData.role || 'user',
            isActive: userData.isActive,
            loginTime: new Date().toISOString()
        };
        
        localStorage.setItem('tanktools_current_user', JSON.stringify(sessionUserData));
        sessionStorage.setItem('tanktools_session', 'active');
        
        if (rememberMe) {
            localStorage.setItem('tanktools_remember', JSON.stringify({
                username: username,
                rememberMe: true
            }));
        }
        
        await addActivity('user_login', username);
        
        showMessage('‚úÖ Login successful! Redirecting...', 'success');
        
        setTimeout(() => {
            const redirect = sessionStorage.getItem('tanktools_redirect');
            if (redirect) {
                sessionStorage.removeItem('tanktools_redirect');
                window.location.href = redirect;
            } else {
                const defaultUrl = userData.role === 'admin' ? 'dashboard.html' : 'index.html';
                window.location.href = defaultUrl;
            }
        }, 1500);
        
    } catch (error) {
        console.error('‚ùå Login error:', error);
        let errorMessage = 'Login failed';
        
        switch (error.code) {
            case 'auth/wrong-password':
            case 'auth/invalid-credential':
                errorMessage = 'Invalid password';
                break;
            case 'auth/user-not-found':
                errorMessage = 'User not found';
                break;
            case 'auth/too-many-requests':
                errorMessage = 'Too many attempts. Try again later';
                break;
            case 'permission-denied':
                errorMessage = 'Access denied. Please contact admin';
                break;
            default:
                errorMessage = error.message;
        }
        
        showMessage(`‚ùå ${errorMessage}`, 'error');
    } finally {
        showLoading('login', false);
    }
}

async function handleRegister(event) {
    event.preventDefault();
    const fullName = document.getElementById('fullName').value.trim();
    const username = document.getElementById('username').value.trim();
    const password = document.getElementById('password').value;
    const confirmPassword = document.getElementById('confirmPassword').value;
    const email = `${username}@knpc.com`;
    
    if (!fullName || !username || !password || !confirmPassword) {
        showMessage('‚ùå Please fill all fields', 'error');
        return;
    }
    
    if (password !== confirmPassword) {
        showMessage('‚ùå Passwords do not match', 'error');
        return;
    }
    
    if (password.length < 8) {
        showMessage('‚ùå Password must be at least 8 characters', 'error');
        return;
    }
    
    showLoading('register', true);
    
    try {
        // ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿπÿØŸÖ Ÿàÿ¨ŸàÿØ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ
        const userDocRef = doc(db, 'users', username);
        const userDoc = await getDoc(userDocRef);
        
        if (userDoc.exists()) {
            showMessage('‚ùå Username already exists', 'error');
            return;
        }
        
        // ÿ•ŸÜÿ¥ÿßÿ° ÿ≠ÿ≥ÿßÿ® ŸÅŸä Firebase Auth
        const userCredential = await createUserWithEmailAndPassword(auth, email, password);
        
        // ÿ•ŸÜÿ¥ÿßÿ° ÿ®ŸäÿßŸÜÿßÿ™ ŸÅŸä Firestore
        const userData = {
            id: Date.now(),
            username: username,
            fullName: fullName,
            email: email,
            password: password,
            role: 'user',
            isActive: false,
            createdAt: serverTimestamp(),
            emailVerified: false,
            firebaseUID: userCredential.user.uid
        };
        
        await setDoc(userDocRef, userData);
        await addActivity('user_registered', username);
        
        showMessage('‚úÖ Registration successful! Pending admin approval.', 'success');
        
        setTimeout(() => {
            const messageContainer = document.getElementById('messageContainer');
            messageContainer.innerHTML += `<div class="message info show" style="margin-top: 10px;"><button class="btn btn-secondary" onclick="contactAdminForActivation('${username}', '${fullName}')" style="width: 100%;">üì± Contact Admin for Activation</button></div>`;
        }, 1000);
        
        // ŸÖÿ≥ÿ≠ ÿßŸÑŸÜŸÖŸàÿ∞ÿ¨
        document.getElementById('fullName').value = '';
        document.getElementById('username').value = '';
        document.getElementById('password').value = '';
        document.getElementById('confirmPassword').value = '';
        
        setTimeout(() => {
            switchTabDirect('login');
        }, 3000);
        
    } catch (error) {
        console.error('Registration error:', error);
        let errorMessage = 'Registration failed';
        
        switch (error.code) {
            case 'auth/email-already-in-use':
                errorMessage = 'Email already in use';
                break;
            case 'auth/weak-password':
                errorMessage = 'Password too weak';
                break;
            default:
                errorMessage = error.message;
        }
        
        showMessage(`‚ùå ${errorMessage}`, 'error');
    } finally {
        showLoading('register', false);
    }
}

async function handleForgotPassword(event) {
    event.preventDefault();
    const username = document.getElementById('forgotUsername').value.trim();
    const email = `${username}@knpc.com`;
    
    if (!username) {
        showMessage('‚ùå Please enter your username', 'error');
        return;
    }
    
    showLoading('forgot', true);
    
    try {
        await sendPasswordResetEmail(auth, email);
        showMessage('‚úÖ Reset email sent! Check your inbox.', 'success');
        setTimeout(() => backToLogin(), 3000);
    } catch (error) {
        console.error('Reset error:', error);
        let errorMessage = 'Failed to send reset email';
        
        if (error.code === 'auth/user-not-found') {
            errorMessage = 'No account found with this email';
        }
        
        showMessage(`‚ùå ${errorMessage}`, 'error');
    } finally {
        showLoading('forgot', false);
    }
}

async function addActivity(action, username) {
    try {
        await addDoc(collection(db, 'activities'), {
            action: action,
            username: username,
            timestamp: serverTimestamp(),
            ip: 'client-side'
        });
    } catch (error) {
        console.error('Failed to log activity:', error);
    }
}

function contactAdmin() {
    const message = "Hello Admin, I need help with Tank Tools password reset.";
    const whatsappUrl = `https://wa.me/${WHATSAPP_ADMIN}?text=${encodeURIComponent(message)}`;
    window.open(whatsappUrl, '_blank');
}

function contactAdminForActivation(username, fullName) {
    const message = `Hello Admin, please activate my Tank Tools account: ${username} (${fullName})`;
    const whatsappUrl = `https://wa.me/${WHATSAPP_ADMIN}?text=${encodeURIComponent(message)}`;
    window.open(whatsappUrl, '_blank');
}

function switchTab(tab) {
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.form-container').forEach(f => f.classList.remove('active'));
    event.target.classList.add('active');
    document.getElementById(tab + 'Form').classList.add('active');
    clearMessages();
}

function switchTabDirect(tab) {
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.form-container').forEach(f => f.classList.remove('active'));
    document.querySelector(`[onclick="switchTab('${tab}')"]`).classList.add('active');
    document.getElementById(tab + 'Form').classList.add('active');
    clearMessages();
}

function showForgotPassword() {
    document.getElementById('mainContainer').style.display = 'none';
    document.getElementById('forgotContainer').classList.add('active');
    clearMessages();
}

function backToLogin() {
    document.getElementById('forgotContainer').classList.remove('active');
    document.getElementById('mainContainer').style.display = 'block';
    clearMessages();
}

function showLoading(form, show) {
    const btn = document.getElementById(form + 'Btn');
    const loading = document.getElementById(form + 'Loading');
    if (show) {
        btn.style.display = 'none';
        loading.style.display = 'block';
    } else {
        btn.style.display = 'block';
        loading.style.display = 'none';
    }
}

function showMessage(message, type) {
    const container = document.getElementById('messageContainer');
    container.innerHTML = `<div class="message ${type}">${message}</div>`;
    setTimeout(() => container.querySelector('.message').classList.add('show'), 100);
    setTimeout(() => container.innerHTML = '', 7000);
}

function clearMessages() {
    document.getElementById('messageContainer').innerHTML = '';
}

function checkExistingSession() {
    const session = sessionStorage.getItem('tanktools_session');
    const userData = localStorage.getItem('tanktools_current_user');
    
    if (session === 'active' && userData) {
        try {
            const user = JSON.parse(userData);
            if (user && user.username && user.role) {
                showMessage('‚úÖ Active session found, redirecting...', 'success');
                setTimeout(() => {
                    const redirect = sessionStorage.getItem('tanktools_redirect');
                    if (redirect) {
                        sessionStorage.removeItem('tanktools_redirect');
                        window.location.href = redirect;
                    } else {
                        const defaultUrl = user.role === 'admin' ? 'dashboard.html' : 'index.html';
                        window.location.href = defaultUrl;
                    }
                }, 1000);
                return;
            }
        } catch (error) {
            sessionStorage.removeItem('tanktools_session');
            localStorage.removeItem('tanktools_current_user');
        }
    }
}

function loadSavedCredentials() {
    const saved = localStorage.getItem('tanktools_remember');
    if (saved) {
        try {
            const data = JSON.parse(saved);
            if (data.rememberMe) {
                document.getElementById('loginUsername').value = data.username;
                document.getElementById('rememberMe').checked = true;
            }
        } catch (error) {
            console.log('Error loading saved credentials');
        }
    }
}

// Password strength checker
document.getElementById('password').addEventListener('input', function() {
    const password = this.value;
    const strengthBar = document.getElementById('strengthBar');
    const strengthMsg = document.getElementById('passwordMsg');
    
    let strength = 0;
    if (password.length >= 8) strength++;
    if (/[A-Z]/.test(password)) strength++;
    if (/[0-9]/.test(password)) strength++;
    if (/[^A-Za-z0-9]/.test(password)) strength++;
    
    const classes = ['strength-weak', 'strength-fair', 'strength-good', 'strength-strong'];
    const messages = ['Weak', 'Fair', 'Good', 'Strong'];
    
    strengthBar.className = 'password-strength-bar ' + (classes[strength - 1] || '');
    
    if (password.length > 0) {
        strengthMsg.textContent = messages[strength - 1] || 'Very Weak';
        strengthMsg.classList.add('show');
        strengthMsg.style.color = strength >= 3 ? '#4CAF50' : '#ff6b6b';
    } else {
        strengthMsg.classList.remove('show');
    }
});

// ÿ™ÿµÿØŸäÿ± ÿßŸÑÿØŸàÿßŸÑ
window.handleLogin = handleLogin;
window.handleRegister = handleRegister;
window.switchTab = switchTab;
window.showForgotPassword = showForgotPassword;
window.backToLogin = backToLogin;
window.contactAdmin = contactAdmin;
window.contactAdminForActivation = contactAdminForActivation;
window.handleForgotPassword = handleForgotPassword;

// ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿµŸÅÿ≠ÿ©
window.addEventListener('load', () => {
    loadSavedCredentials();
    setTimeout(checkExistingSession, 1000);
});

console.log('%cüî• TANK TOOLS - FIREBASE AUTH SYSTEM', 'color:orange;font-size:20px;font-weight:bold');
console.log('%cDeveloper: Fahad - 17877', 'color:green;font-size:16px');
</script>
</body>
</html>