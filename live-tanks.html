<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Live Tanks - KNPC Operations</title>
  <link href="icon.png" rel="icon" type="image/png"/>
  <link rel="manifest" href="/manifest.json">
  <meta name="theme-color" content="#003366">
  <script src="permissions.js"></script>
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{background:linear-gradient(rgba(0,0,0,0.5),rgba(0,0,0,0.5)),url('background.jpg');background-size:cover;background-position:center;background-attachment:fixed;color:white;font-family:Arial,sans-serif;padding:20px;min-height:100vh}
    .nav-bar{display:flex;justify-content:space-between;align-items:center;padding:10px 20px;background:rgba(0,0,0,0.5);border-radius:10px;margin-bottom:20px;flex-wrap:wrap}
    .nav-logo{font-size:24px;font-weight:bold;color:white}
    .nav-links{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .nav-link{color:white;text-decoration:none;padding:8px 16px;border-radius:8px;transition:all 0.3s ease;background:rgba(255,255,255,0.1);font-weight:500;border:1px solid rgba(255,255,255,0.2)}
    .nav-link:hover{background:rgba(255,255,255,0.2);transform:translateY(-1px)}
    .nav-link.active{background:rgba(255,255,255,0.3);font-weight:bold;border:1px solid rgba(255,255,255,0.4)}
    .nav-admin{background:linear-gradient(45deg,#FFD700,#FFA500);color:#003366;font-weight:bold;border-radius:8px;padding:8px 16px;text-decoration:none;transition:all 0.3s ease;border:1px solid #FFA500;font-size:inherit}
    .nav-admin:hover{transform:translateY(-1px);box-shadow:0 4px 12px rgba(255,215,0,0.3)}
    .nav-user{display:flex;align-items:center;gap:10px;background:rgba(255,255,255,0.1);padding:5px 15px;border-radius:20px;backdrop-filter:blur(10px)}
    .user-avatar{width:30px;height:30px;border-radius:50%;background:linear-gradient(45deg,#4CAF50,#45a049);display:flex;align-items:center;justify-content:center;font-weight:bold;font-size:14px}
    .logout-btn{background:rgba(255,0,0,0.2);border:1px solid rgba(255,0,0,0.5);color:white;padding:5px 10px;border-radius:5px;cursor:pointer;font-size:12px;transition:all 0.3s ease}
    .font-controls{display:flex;gap:5px;margin-right:10px}
    .font-btn{background:rgba(255,255,255,0.2);border:1px solid rgba(255,255,255,0.3);color:white;padding:5px 10px;border-radius:5px;cursor:pointer;font-size:14px;font-weight:bold;transition:all 0.3s ease;min-width:30px}
    .font-btn:hover{background:rgba(255,255,255,0.3);transform:translateY(-1px)}
    .page-header{text-align:center;margin-bottom:30px}
    .page-title{font-size:2.5rem;margin-bottom:10px;background:linear-gradient(45deg,#ff4444,#ff6666);-webkit-background-clip:text;-webkit-text-fill-color:transparent;animation:pulse 2s ease-in-out infinite}
    @keyframes pulse{0%,100%{transform:scale(1)}50%{transform:scale(1.05)}}
    .page-subtitle{font-size:1.2rem;opacity:0.8}
    .container{max-width:100%;margin:0 auto}
    .section{background:rgba(255,255,255,0.1);backdrop-filter:blur(10px);border-radius:15px;padding:25px;margin-bottom:25px;border:1px solid rgba(255,255,255,0.2)}
    .section-title{font-size:1.4rem;font-weight:bold;display:flex;align-items:center;gap:10px;margin-bottom:20px;margin-top:30px;padding-bottom:15px;border-bottom:2px solid rgba(255,255,255,0.2)}
    .department-badge{padding:5px 15px;border-radius:20px;font-size:0.9rem;font-weight:bold}
    .badge-pbcr{background:linear-gradient(45deg,#4CAF50,#45a049);color:white}
    .badge-washery{background:linear-gradient(45deg,#2196F3,#1976D2);color:white}
    .badge-plcr{background:linear-gradient(45deg,#ff9800,#f57c00);color:white}
    .add-tank-btn{background:linear-gradient(45deg,#FFD700,#FFA500);color:#003366;border:none;padding:10px 20px;border-radius:8px;cursor:pointer;font-weight:bold;transition:all 0.3s ease;display:flex;align-items:center;gap:8px;margin-bottom:20px}
    .add-tank-btn:hover{transform:translateY(-2px);box-shadow:0 8px 20px rgba(255,215,0,0.3)}
    .add-tank-btn:disabled{background:#666;color:#999;cursor:not-allowed;transform:none}
    .table-container{width:100%;max-width:100%;overflow-x:auto;margin:10px auto;background:rgba(0,0,0,0.2);border-radius:10px;padding:5px}
    .tanks-table{margin:auto;background:rgba(255,255,255,0.9);color:#003366;border-collapse:separate;border-spacing:0;border-radius:8px;overflow:hidden;font-size:12px;box-shadow:0 2px 8px rgba(0,0,0,0.3);margin-bottom:20px;width:100%;min-width:300px;table-layout:fixed}
    .tanks-table th,.tanks-table td{padding:8px 6px;border-bottom:1px solid #003366;text-align:center;overflow:hidden;white-space:nowrap;text-overflow:ellipsis}
    .tanks-table th{background:#003366;color:white;font-weight:bold;font-size:12px}
    .tanks-table th:nth-child(1),.tanks-table td:nth-child(1){width:15%}
    .tanks-table th:nth-child(2),.tanks-table td:nth-child(2){width:20%}
    .tanks-table th:nth-child(3),.tanks-table td:nth-child(3){width:18%}
    .tanks-table th:nth-child(4),.tanks-table td:nth-child(4){width:18%}
    .tanks-table th:nth-child(5),.tanks-table td:nth-child(5){width:20%}
    .tanks-table th:nth-child(6),.tanks-table td:nth-child(6){width:9%}
    .tank-row-critical{background:#ffebee!important;color:#c62828!important;font-weight:bold!important}
    .tank-row-warning{background:#ffffff!important;color:#d32f2f!important;font-weight:bold!important}
    .tank-row-normal{background:#ffffff!important;color:#2e7d32!important}
    .tank-number{font-weight:bold;font-size:15px}
    .tank-row-critical .tank-number{color:#c62828!important}
    .tank-row-warning .tank-number{color:#d32f2f!important}
    .tank-row-normal .tank-number{color:#2e7d32!important}
    .product-badge{padding:4px 8px;border-radius:8px;font-size:12px;font-weight:bold;text-transform:uppercase;white-space:nowrap}
    .product-lsfo{background:#e91e63;color:white}
    .product-ego-10{background:#9c27b0;color:white}
    .product-ego-500{background:#673ab7;color:white}
    .product-rhn{background:#3f51b5;color:white}
    .product-pcna{background:#2196f3;color:white}
    .product-nmogas{background:#03a9f4;color:white}
    .product-olmogas{background:#00bcd4;color:white}
    .product-atk{background:#009688;color:white}
    .product-ardr{background:#4caf50;color:white}
    .product-ic5{background:#8bc34a;color:white}
    .product-isom{background:#cddc39;color:#333}
    .product-slop{background:#ff9800;color:white}
    .product-mogas-98{background:#f44336;color:white}
    .product-mogas-95{background:#e91e63;color:white}
    .product-mogas-91{background:#9c27b0;color:white}
    .product-go{background:#3f51b5;color:white}
    .product-kero{background:#2196f3;color:white}
    .product-napha{background:#ff5722;color:white}
    .product-hsd-ego{background:#795548;color:white}
    .product-ego{background:#607d8b;color:white}
    .product-f-oil{background:#424242;color:white}
    .product-vgo{background:#8e24aa;color:white}
    .product-kkero{background:#1976d2;color:white}
    .product-methanol{background:#00796b;color:white}
    .product-other{background:#9e9e9e;color:white}
    .status-badge{display:inline-block;padding:4px 8px;border-radius:8px;font-size:11px;font-weight:bold;text-transform:uppercase}
    .badge-active{background:#4CAF50;color:white}
    .badge-completed{background:#ff9800;color:white}
    .badge-cancelled{background:#f44336;color:white}
    .action-buttons{display:flex;gap:2px;justify-content:center}
    .action-btn{padding:6px 8px;border:none;border-radius:4px;cursor:pointer;font-size:11px;font-weight:500;transition:all 0.3s ease;color:white}
    .btn-edit{background:#4CAF50}
    .btn-delete{background:#f44336}
    .btn-view{background:#2196F3}
    .btn-reminder{background:#ff9800}
    .action-btn:hover{transform:scale(1.05)}
    .empty-state{text-align:center;padding:40px;color:#666}
    .empty-icon{font-size:3rem;margin-bottom:15px;opacity:0.5}
    .modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.8);z-index:1000;backdrop-filter:blur(5px)}
    .modal.show{display:flex;justify-content:center;align-items:center}
    .modal-content{background:rgba(255,255,255,0.95);padding:30px;border-radius:15px;max-width:500px;width:90%;color:#003366;max-height:90vh;overflow-y:auto}
    .modal-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;padding-bottom:15px;border-bottom:2px solid #ddd}
    .modal-title{font-size:1.3rem;font-weight:bold;color:#003366}
    .close-btn{background:none;border:none;font-size:28px;cursor:pointer;color:#666;font-weight:bold}
    .close-btn:hover{color:#f44336}
    .form-group{margin-bottom:20px}
    .form-label{display:block;margin-bottom:8px;font-weight:600;color:#003366}
    .form-input,.form-select{width:100%;padding:12px;border:2px solid #ddd;border-radius:8px;font-size:14px;transition:border-color 0.3s ease}
    .form-input:focus,.form-select:focus{outline:none;border-color:#4CAF50}
    .form-textarea{width:100%;padding:12px;border:2px solid #ddd;border-radius:8px;font-size:14px;min-height:80px;resize:vertical}
    .btn{padding:12px 24px;border:none;border-radius:8px;cursor:pointer;font-weight:600;transition:all 0.3s ease;font-size:14px;display:inline-flex;align-items:center;gap:8px}
    .btn-primary{background:linear-gradient(45deg,#4CAF50,#45a049);color:white}
    .btn-secondary{background:linear-gradient(45deg,#6c757d,#5a6268);color:white}
    .btn-danger{background:linear-gradient(45deg,#f44336,#d32f2f);color:white}
    .btn-warning{background:linear-gradient(45deg,#ff9800,#f57c00);color:white}
    .btn:hover{transform:translateY(-2px);box-shadow:0 8px 20px rgba(0,0,0,0.2)}
    .tank-details-modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.8);z-index:1000;backdrop-filter:blur(5px)}
    .tank-details-modal.show{display:flex;justify-content:center;align-items:center}
    .tank-details-content{background:rgba(255,255,255,0.95);padding:25px;border-radius:15px;max-width:450px;width:90%;color:#003366;max-height:90vh;overflow-y:auto}
    .tank-details-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;padding-bottom:15px;border-bottom:2px solid #ddd}
    .tank-details-title{font-size:1.4rem;font-weight:bold;color:#003366}
    .tank-detail-section{margin-bottom:20px}
    .tank-detail-single{padding:15px;background:rgba(240,248,255,0.8);border-radius:10px;border-left:4px solid #2196F3}
    .tank-detail-dual{display:flex;gap:15px}
    .tank-detail-item{flex:1;padding:15px;background:rgba(240,248,255,0.8);border-radius:10px;border-left:4px solid #2196F3}
    .tank-detail-label{font-size:0.9rem;font-weight:600;color:#666;margin-bottom:8px;display:block}
    .tank-detail-value{font-size:1rem;color:#003366;font-weight:500;word-break:break-word}
    .tank-actions{display:flex;gap:10px;justify-content:center;margin-top:20px;padding-top:15px;border-top:2px solid #eee}
    .history-timeline{max-height:500px;overflow-y:auto;padding:10px}
    .history-item{background:rgba(248,249,250,0.9);border-radius:10px;padding:15px;margin-bottom:15px;border-left:4px solid #28a745}
    .history-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px}
    .history-date{font-size:0.9rem;color:#666;font-weight:500}
    .history-user{font-size:0.9rem;color:#007bff;font-weight:600}
    .history-action{font-size:1rem;font-weight:600;color:#28a745;margin-bottom:10px}
    .history-changes{background:rgba(255,255,255,0.8);border-radius:8px;padding:10px;margin-bottom:10px}
    .changes-grid{display:grid;gap:8px}
    .change-item{display:flex;justify-content:space-between;align-items:center;padding:5px 0;border-bottom:1px solid #eee}
    .change-field{font-weight:600;color:#666;min-width:120px}
    .change-values{display:flex;align-items:center;gap:10px}
    .old-value{color:#dc3545;text-decoration:line-through;opacity:0.7}
    .arrow{color:#6c757d;font-weight:bold}
    .new-value{color:#28a745;font-weight:600}
    .history-notes{background:rgba(255,248,220,0.8);border-radius:6px;padding:8px;font-style:italic;color:#856404}
    .modal-buttons{display:flex;gap:15px;justify-content:flex-end;margin-top:25px}
    .message{padding:15px 20px;border-radius:10px;margin-bottom:20px;font-weight:500;border-left:5px solid}
    .message.success{background:rgba(76,175,80,0.2);border-color:#4CAF50;color:#4CAF50}
    .message.error{background:rgba(244,67,54,0.2);border-color:#f44336;color:#f44336}
    .message.info{background:rgba(33,150,243,0.2);border-color:#2196F3;color:#2196F3}
    .message.warning{background:rgba(255,193,7,0.2);border-color:#ffc107;color:#ffc107}
    .loading{text-align:center;padding:40px;font-size:18px}
    .loading-spinner{display:inline-block;width:40px;height:40px;border:4px solid rgba(255,255,255,0.3);border-radius:50%;border-top:4px solid #FFD700;animation:spin 1s linear infinite;margin-bottom:10px}
    @keyframes spin{0%{transform:rotate(0deg)}100%{transform:rotate(360deg)}}
    .access-denied{position:fixed;top:0;left:0;width:100%;height:100%;background:linear-gradient(rgba(0,0,0,0.8),rgba(0,0,0,0.8)),url('background.jpg');background-size:cover;background-position:center;display:flex;justify-content:center;align-items:center;z-index:9999}
    .access-denied-content{text-align:center;background:rgba(255,255,255,0.1);padding:40px;border-radius:20px;backdrop-filter:blur(10px);border:1px solid rgba(255,255,255,0.2)}
    .access-denied-icon{font-size:5rem;color:#f44336;margin-bottom:20px}
    .access-denied-title{font-size:2rem;color:#f44336;margin-bottom:15px}
    .access-denied-text{font-size:1.2rem;margin-bottom:20px;opacity:0.8}
    .login-btn{padding:12px 25px;background:linear-gradient(45deg,#4CAF50,#45a049);color:white;border:none;border-radius:10px;cursor:pointer;font-size:16px;transition:all 0.3s ease;margin:5px}
    .refresh-indicator{position:fixed;top:80px;right:20px;background:rgba(76,175,80,0.9);color:white;padding:10px 15px;border-radius:8px;font-size:12px;z-index:1000;animation:slideIn 0.3s ease}
    @keyframes slideIn{from{transform:translateX(100%)}to{transform:translateX(0)}}
    .tank-count{font-size:0.9rem;opacity:0.8;margin-left:10px}
    .urgency-indicator{position:absolute;right:10px;top:50%;transform:translateY(-50%);font-size:1.2rem;animation:blink 1s infinite}
    .section-header{transition:all 0.3s ease;position:relative;overflow:hidden}
    .section-header:hover{transform:translateY(-2px);box-shadow:0 6px 20px rgba(0,0,0,0.15)!important}
    .section-header:before{content:'';position:absolute;top:0;left:-100%;width:100%;height:100%;background:linear-gradient(90deg,transparent,rgba(255,255,255,0.1),transparent);transition:left 0.5s ease}
    .section-header:hover:before{left:100%}
    .add-tank-btn:hover{transform:translateY(-3px)!important;box-shadow:0 6px 20px rgba(255,215,0,0.4)!important}
    @keyframes blink{0%,50%{opacity:1}51%,100%{opacity:0.3}}
    @media (max-width:768px){
      .nav-bar{flex-direction:column;gap:15px;padding:15px}
      .nav-links{order:1;justify-content:center;width:100%}
      .nav-user{order:2;width:100%;justify-content:space-between}
      .page-title{font-size:2rem}
      .tanks-table{font-size:11px}
      .tanks-table th,.tanks-table td{padding:8px 4px}
      .action-buttons{flex-direction:column;gap:3px}
      .modal-buttons{flex-direction:column}
      .btn{width:100%}
      .tanks-table{overflow-x:auto;display:block;white-space:nowrap;font-size:10px}
      .tanks-table thead,.tanks-table tbody,.tanks-table tr{display:table;width:100%;table-layout:fixed}
      .tanks-table th,.tanks-table td{padding:4px 2px}
    }
  </style>
</head>

<body>
  <!-- Access Denied Screen -->
  <div id="accessDenied" class="access-denied" style="display:none">
    <div class="access-denied-content">
      <div class="access-denied-icon">üîí</div>
      <div class="access-denied-title">Access Denied</div>
      <div class="access-denied-text">You don't have permission to access Live Tanks.<br>Please contact your administrator.</div>
      <button class="login-btn" onclick="goToLogin()">Go to Login</button>
    </div>
  </div>

  <!-- Main Content -->
  <div id="mainContent">
    <!-- Navigation -->
    <div class="nav-bar">
      <div class="nav-logo">Tank Tools</div>
      <div class="nav-links">
        <a class="nav-link" href="index.html">PBCR/WASHERY</a>
        <a class="nav-link" href="plcr.html">PLCR</a>
        <a class="nav-link active" href="live-tanks.html">Live Tanks</a>
        <a class="nav-link" href="reports.html">Reports</a>
        <a class="nav-admin" href="admin.html" id="adminLink" style="display:none">Admin</a>
      </div>
      <div class="nav-user">
        <div class="font-controls">
          <button class="font-btn" onclick="changeFontSize(-1)">A-</button>
          <button class="font-btn" onclick="changeFontSize(1)">A+</button>
        </div>
        <div class="user-avatar" id="userAvatar">U</div>
        <span id="userName">User</span>
        <button class="logout-btn" onclick="logout()">Logout</button>
      </div>
    </div>

    <!-- Page Header -->
    <div class="page-header">
      <h1 class="page-title">üî¥ Live Tanks</h1>
      <p class="page-subtitle">Real-time Tank Monitoring & Management</p>
    </div>

    <!-- Loading Screen -->
    <div id="loadingScreen" class="loading">
      <div class="loading-spinner"></div>
      <div>Loading Live Tanks...</div>
    </div>

    <!-- Main Container -->
    <div class="container" id="mainContainer" style="display:none">
      
      <!-- PBCR/WASHERY Section -->
      <div class="section" id="pbcrSection">
        <div class="section-title section-header">
          <span class="department-badge badge-pbcr">PBCR/WASHERY</span>
          <span class="tank-count" id="pbcrCount">(0 tanks)</span>
          <button class="add-tank-btn" onclick="showAddTankModal('PBCR')" id="addPbcrBtn">
            ‚ûï Add Tank
          </button>
        </div>
        <div class="table-container">
          <table class="tanks-table" id="pbcrTable">
            <thead>
              <tr>
                <th>Tank #</th>
                <th>Product</th>
                <th>Current Level</th>
                <th>Target Level</th>
                <th>Rate</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="pbcrTableBody">
              <!-- Dynamic content -->
            </tbody>
          </table>
        </div>
      </div>

      <!-- PLCR Section -->
      <div class="section" id="plcrSection">
        <div class="section-title section-header">
          <span class="department-badge badge-plcr">PLCR</span>
          <span class="tank-count" id="plcrCount">(0 tanks)</span>
          <button class="add-tank-btn" onclick="showAddTankModal('PLCR')" id="addPlcrBtn">
            ‚ûï Add Tank
          </button>
        </div>
        <div class="table-container">
          <table class="tanks-table" id="plcrTable">
            <thead>
              <tr>
                <th>Tank #</th>
                <th>Product</th>
                <th>Current Level</th>
                <th>Target Level</th>
                <th>Rate</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="plcrTableBody">
              <!-- Dynamic content -->
            </tbody>
          </table>
        </div>
      </div>

    </div>
  </div>

  <!-- Add Tank Modal -->
  <div id="addTankModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title">Add New Tank</h2>
        <button class="close-btn" onclick="closeAddTankModal()">&times;</button>
      </div>
      <form id="addTankForm">
        <div class="form-group">
          <label class="form-label">Department:</label>
          <select id="addDepartment" class="form-select" onchange="updateProductOptions()" required>
            <option value="">Select Department</option>
            <option value="PBCR">PBCR/WASHERY</option>
            <option value="PLCR">PLCR</option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">Tank Number:</label>
          <input type="text" id="addTankNumber" class="form-input" placeholder="e.g., T-101" required>
        </div>
        <div class="form-group">
          <label class="form-label">Product:</label>
          <select id="addProduct" class="form-select" onchange="checkOtherProduct()" required>
            <option value="">Select Product</option>
          </select>
        </div>
        <div class="form-group" id="addOtherProductGroup" style="display:none">
          <label class="form-label">Other Product (specify):</label>
          <input type="text" id="addOtherProduct" class="form-input" placeholder="Enter product name">
        </div>
        <div class="form-group">
          <label class="form-label">Current Level:</label>
          <input type="number" id="addCurrentLevel" class="form-input" step="0.01" required>
        </div>
        <div class="form-group">
          <label class="form-label">Target Level:</label>
          <input type="number" id="addTargetLevel" class="form-input" step="0.01" required>
        </div>
        <div class="form-group">
          <label class="form-label">Rate Unit:</label>
          <select id="addRateUnit" class="form-select" required>
            <option value="">Select Rate Unit</option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">Notes (optional):</label>
          <textarea id="addNotes" class="form-textarea" placeholder="Additional notes..."></textarea>
        </div>
        <div class="modal-buttons">
          <button type="button" class="btn btn-secondary" onclick="closeAddTankModal()">Cancel</button>
          <button type="submit" class="btn btn-primary">Add Tank</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Edit Tank Modal -->
  <div id="editTankModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title">Edit Tank</h2>
        <button class="close-btn" onclick="closeEditModal()">&times;</button>
      </div>
      <form id="editTankForm">
        <div class="form-group">
          <label class="form-label">Tank Number:</label>
          <input type="text" id="editTankNumber" class="form-input" readonly>
        </div>
        <div class="form-group">
          <label class="form-label">Product:</label>
          <input type="text" id="editProduct" class="form-input" readonly>
        </div>
        <div class="form-group">
          <label class="form-label">Previous Level:</label>
          <input type="number" id="editPreviousLevel" class="form-input" readonly>
        </div>
        <div class="form-group">
          <label class="form-label">Current Level:</label>
          <input type="number" id="editCurrentLevel" class="form-input" step="0.01" required>
        </div>
        <div class="form-group">
          <label class="form-label">Target Level:</label>
          <input type="number" id="editTargetLevel" class="form-input" step="0.01" required>
        </div>
        <div class="form-group">
          <label class="form-label">Rate Unit:</label>
          <input type="text" id="editRateUnit" class="form-input" readonly>
        </div>
        <div class="form-group">
          <label class="form-label">Notes (optional):</label>
          <textarea id="editNotes" class="form-textarea" placeholder="Additional notes..."></textarea>
        </div>
        <div class="modal-buttons">
          <button type="button" class="btn btn-secondary" onclick="closeEditModal()">Cancel</button>
          <button type="submit" class="btn btn-primary">Update Tank</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Tank Details Modal -->
  <div id="tankDetailsModal" class="tank-details-modal">
    <div class="tank-details-content">
      <div class="tank-details-header">
        <h2 class="tank-details-title" id="tankDetailsTitle">Tank Details</h2>
        <button class="close-btn" onclick="closeTankDetails()">&times;</button>
      </div>
      
      <div class="tank-detail-section">
        <div class="tank-detail-dual">
          <div class="tank-detail-item">
            <span class="tank-detail-label">Tank Number</span>
            <div class="tank-detail-value" id="detailTankNumber">-</div>
          </div>
          <div class="tank-detail-item">
            <span class="tank-detail-label">Department</span>
            <div class="tank-detail-value" id="detailDepartment">-</div>
          </div>
        </div>
      </div>

      <div class="tank-detail-section">
        <div class="tank-detail-single">
          <span class="tank-detail-label">Product</span>
          <div class="tank-detail-value" id="detailProduct">-</div>
        </div>
      </div>

      <div class="tank-detail-section">
        <div class="tank-detail-dual">
          <div class="tank-detail-item">
            <span class="tank-detail-label">Current Level</span>
            <div class="tank-detail-value" id="detailCurrentLevel">-</div>
          </div>
          <div class="tank-detail-item">
            <span class="tank-detail-label">Target Level</span>
            <div class="tank-detail-value" id="detailTargetLevel">-</div>
          </div>
        </div>
      </div>

      <div class="tank-detail-section">
        <div class="tank-detail-dual">
          <div class="tank-detail-item">
            <span class="tank-detail-label">Rate</span>
            <div class="tank-detail-value" id="detailRate">-</div>
          </div>
          <div class="tank-detail-item">
            <span class="tank-detail-label">Status</span>
            <div class="tank-detail-value" id="detailStatus">-</div>
          </div>
        </div>
      </div>

      <div class="tank-detail-section">
        <div class="tank-detail-single">
          <span class="tank-detail-label">Notes</span>
          <div class="tank-detail-value" id="detailNotes">-</div>
        </div>
      </div>

      <div class="tank-detail-section">
        <div class="tank-detail-dual">
          <div class="tank-detail-item">
            <span class="tank-detail-label">Last Updated</span>
            <div class="tank-detail-value" id="detailLastUpdated">-</div>
          </div>
          <div class="tank-detail-item">
            <span class="tank-detail-label">Updated By</span>
            <div class="tank-detail-value" id="detailUpdatedBy">-</div>
          </div>
        </div>
      </div>

      <div class="tank-actions">
        <button class="btn btn-primary" onclick="editTank(currentTankDetails.id)" id="detailEditBtn">
          ‚úèÔ∏è Edit Tank
        </button>
        <button class="btn btn-warning" onclick="addReminder(currentTankDetails)" id="detailReminderBtn">
          üìÖ Add Reminder
        </button>
        <button class="btn btn-secondary" onclick="showTankHistory(currentTankDetails.id)" id="detailHistoryBtn">
          üìä View History
        </button>
        <button class="btn btn-danger" onclick="deleteTank(currentTankDetails.id)" id="detailDeleteBtn" style="display:none">
          üóëÔ∏è Delete Tank
        </button>
      </div>
    </div>
  </div>

  <!-- History Modal -->
  <div id="historyModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title">Tank History</h2>
        <button class="close-btn" onclick="closeHistoryModal()">&times;</button>
      </div>
      <div class="history-timeline" id="historyTimeline">
        <!-- Dynamic content -->
      </div>
      <div class="modal-buttons">
        <button type="button" class="btn btn-secondary" onclick="closeHistoryModal()">Close</button>
      </div>
    </div>
  </div>

  <script>
    // Global variables
    let liveTanks = [];
    let currentUser = null;
    let userPermissions = {};
    let currentEditingTank = null;
    let currentTankDetails = null;
    let refreshInterval = null;

    // Product configurations by department
    const productsByDepartment = {
      'PBCR': ['LSFO', 'EGO 10PPM', 'EGO 500PPM', 'RHN', 'PCNA', 'NMOGAS', 'OLMOGAS', 'ATK', 'ARDR', 'IC5', 'ISOM', 'SLOP', 'OTHER'],
      'PLCR': ['NAPHA', 'PCNA', 'HSD-EGO', 'EGO', 'F.OIL', 'MOGAS', 'VGO', 'KKERO', 'ARDR', 'METHANOL', 'OTHER']
    };

    const rateUnitsByDepartment = {
      'PBCR': ['bbl/hr', 'meter/hr'],
      'PLCR': ['MT/hr']
    };

    // Initialize page
    document.addEventListener('DOMContentLoaded', function() {
      initializePage();
    });

    async function initializePage() {
      try {
        // Check permissions first
        await setupPermissions();
        
        // Load live tanks data
        await loadLiveTanks();
        
        // Setup auto-refresh
        setupAutoRefresh();
        
        // Hide loading screen
        document.getElementById('loadingScreen').style.display = 'none';
        document.getElementById('mainContainer').style.display = 'block';
        
      } catch (error) {
        console.error('Error initializing page:', error);
        showMessage('Error loading page. Please refresh.', 'error');
      }
    }

    async function setupPermissions() {
      try {
        // Check if user is logged in
        const storedUser = localStorage.getItem('currentUser');
        const storedPermissions = localStorage.getItem('userPermissions');
        
        if (storedUser && storedPermissions) {
          currentUser = JSON.parse(storedUser);
          userPermissions = JSON.parse(storedPermissions);
          console.log('Live Tanks permissions setup completed');
          updateUIBasedOnPermissions();
        } else {
          // Redirect to login if no user found
          console.log('No user found, redirecting to login');
          window.location.href = 'login.html';
          return;
        }
      } catch (error) {
        console.error('Error setting up permissions:', error);
        // Redirect to login on error
        window.location.href = 'login.html';
      }
    }

    function updateUIBasedOnPermissions() {
      // Update user info
      if (currentUser) {
        document.getElementById('userName').textContent = currentUser.name;
        document.getElementById('userAvatar').textContent = currentUser.avatar;
      }

      // Show/hide admin link
      if (userPermissions.isAdmin) {
        document.getElementById('adminLink').style.display = 'inline-block';
      }

      // Show/hide add buttons
      const addButtons = document.querySelectorAll('.add-tank-btn');
      addButtons.forEach(btn => {
        btn.style.display = userPermissions.canAdd ? 'flex' : 'none';
      });
    }

    async function loadLiveTanks() {
      try {
        // Load from localStorage for now
        const stored = localStorage.getItem('liveTanks');
        liveTanks = stored ? JSON.parse(stored) : [];
        
        // Render tanks
        renderTanks();
        
      } catch (error) {
        console.error('Error loading live tanks:', error);
        showMessage('Error loading tanks data.', 'error');
      }
    }

    function renderTanks() {
      const pbcrTableBody = document.getElementById('pbcrTableBody');
      const plcrTableBody = document.getElementById('plcrTableBody');
      
      // Clear existing content
      pbcrTableBody.innerHTML = '';
      plcrTableBody.innerHTML = '';
      
      let pbcrCount = 0;
      let plcrCount = 0;
      
      liveTanks.forEach(tank => {
        const row = createTankRow(tank);
        
        if (tank.department === 'PBCR') {
          pbcrTableBody.appendChild(row);
          pbcrCount++;
        } else if (tank.department === 'PLCR') {
          plcrTableBody.appendChild(row);
          plcrCount++;
        }
      });
      
      // Update counts
      document.getElementById('pbcrCount').textContent = `(${pbcrCount} tanks)`;
      document.getElementById('plcrCount').textContent = `(${plcrCount} tanks)`;
      
      // Show empty state if no tanks
      if (pbcrCount === 0) {
        pbcrTableBody.innerHTML = '<tr><td colspan="6" class="empty-state"><div class="empty-icon">üè≠</div><div>No PBCR tanks found</div></td></tr>';
      }
      if (plcrCount === 0) {
        plcrTableBody.innerHTML = '<tr><td colspan="6" class="empty-state"><div class="empty-icon">üè≠</div><div>No PLCR tanks found</div></td></tr>';
      }
    }

    function createTankRow(tank) {
      const row = document.createElement('tr');
      
      // Determine row class based on urgency
      const urgency = calculateUrgency(tank);
      row.className = `tank-row-${urgency}`;
      
      // Calculate time to target
      const timeToTarget = calculateTimeToTarget(tank);
      
      row.innerHTML = `
        <td>
          <span class="tank-number">${tank.tankNumber}</span>
          ${urgency === 'critical' ? '<span class="urgency-indicator">‚ö†Ô∏è</span>' : ''}
        </td>
        <td>
          <span class="product-badge product-${tank.product.toLowerCase().replace(/[^a-z0-9]/g, '-')}">${tank.product}</span>
        </td>
        <td>${tank.currentLevel} ${tank.levelUnit || 'mtr'}</td>
        <td>${tank.targetLevel} ${tank.levelUnit || 'mtr'}</td>
        <td>${tank.actualRate || 0} ${tank.rateUnit}</td>
        <td>
          <div class="action-buttons">
            <button class="action-btn btn-view" onclick="showTankDetails('${tank.id}')" title="View Details">‚ùó</button>
            ${userPermissions.canEdit ? `<button class="action-btn btn-edit" onclick="editTank('${tank.id}')" title="Edit">‚úèÔ∏è</button>` : ''}
            ${userPermissions.canDelete ? `<button class="action-btn btn-delete" onclick="deleteTank('${tank.id}')" title="Delete">üóëÔ∏è</button>` : ''}
          </div>
        </td>
      `;
      
      return row;
    }

    function calculateUrgency(tank) {
      const current = parseFloat(tank.currentLevel);
      const target = parseFloat(tank.targetLevel);
      const rate = parseFloat(tank.actualRate) || 0;
      
      if (rate === 0) return 'normal';
      
      const timeToTarget = Math.abs(target - current) / Math.abs(rate);
      
      if (timeToTarget <= 2) return 'critical';
      if (timeToTarget <= 6) return 'warning';
      return 'normal';
    }

    function calculateTimeToTarget(tank) {
      const current = parseFloat(tank.currentLevel);
      const target = parseFloat(tank.targetLevel);
      const rate = parseFloat(tank.actualRate) || 0;
      
      if (rate === 0) return 'N/A';
      
      const timeHours = Math.abs(target - current) / Math.abs(rate);
      
      if (timeHours < 1) {
        return `${Math.round(timeHours * 60)} min`;
      } else if (timeHours < 24) {
        return `${timeHours.toFixed(1)} hrs`;
      } else {
        return `${(timeHours / 24).toFixed(1)} days`;
      }
    }

    function showAddTankModal(department) {
      document.getElementById('addDepartment').value = department;
      updateProductOptions();
      document.getElementById('addTankModal').classList.add('show');
    }

    function closeAddTankModal() {
      document.getElementById('addTankModal').classList.remove('show');
      document.getElementById('addTankForm').reset();
      document.getElementById('addOtherProductGroup').style.display = 'none';
    }

    function updateProductOptions() {
      const department = document.getElementById('addDepartment').value;
      const productSelect = document.getElementById('addProduct');
      const rateUnitSelect = document.getElementById('addRateUnit');
      
      // Clear existing options
      productSelect.innerHTML = '<option value="">Select Product</option>';
      rateUnitSelect.innerHTML = '<option value="">Select Rate Unit</option>';
      
      if (department && productsByDepartment[department]) {
        productsByDepartment[department].forEach(product => {
          const option = document.createElement('option');
          option.value = product;
          option.textContent = product;
          productSelect.appendChild(option);
        });
      }
      
      if (department && rateUnitsByDepartment[department]) {
        rateUnitsByDepartment[department].forEach(unit => {
          const option = document.createElement('option');
          option.value = unit;
          option.textContent = unit;
          rateUnitSelect.appendChild(option);
        });
      }
    }

    function checkOtherProduct() {
      const productSelect = document.getElementById('addProduct');
      const otherGroup = document.getElementById('addOtherProductGroup');
      
      if (productSelect.value === 'OTHER') {
        otherGroup.style.display = 'block';
        document.getElementById('addOtherProduct').required = true;
      } else {
        otherGroup.style.display = 'none';
        document.getElementById('addOtherProduct').required = false;
      }
    }

    // Add tank form submission
    document.getElementById('addTankForm').addEventListener('submit', function(e) {
      e.preventDefault();
      
      const formData = new FormData(e.target);
      const department = document.getElementById('addDepartment').value;
      const tankNumber = document.getElementById('addTankNumber').value;
      const product = document.getElementById('addProduct').value === 'OTHER' ? 
                     document.getElementById('addOtherProduct').value : 
                     document.getElementById('addProduct').value;
      const currentLevel = parseFloat(document.getElementById('addCurrentLevel').value);
      const targetLevel = parseFloat(document.getElementById('addTargetLevel').value);
      const rateUnit = document.getElementById('addRateUnit').value;
      const notes = document.getElementById('addNotes').value;
      
      // Check if tank number already exists
      if (liveTanks.some(tank => tank.tankNumber === tankNumber && tank.department === department)) {
        showMessage('Tank number already exists in this department.', 'error');
        return;
      }
      
      const newTank = {
        id: generateId(),
        department: department,
        tankNumber: tankNumber,
        product: product,
        currentLevel: currentLevel,
        targetLevel: targetLevel,
        rateUnit: rateUnit,
        levelUnit: department === 'PLCR' ? 'mtr' : 'mtr',
        actualRate: 0,
        status: 'active',
        notes: notes,
        createdAt: new Date().toISOString(),
        createdBy: currentUser.name,
        lastUpdated: new Date().toISOString(),
        updatedBy: currentUser.name,
        lastLevelUpdate: new Date().toISOString(),
        history: [{
          action: 'Tank Created',
          timestamp: new Date().toISOString(),
          user: currentUser.name,
          changes: {
            'Tank Number': { old: '', new: tankNumber },
            'Product': { old: '', new: product },
            'Current Level': { old: '', new: `${currentLevel} mtr` },
            'Target Level': { old: '', new: `${targetLevel} mtr` },
            'Rate Unit': { old: '', new: rateUnit }
          },
          notes: notes
        }]
      };
      
      liveTanks.push(newTank);
      saveLiveTanks();
      renderTanks();
      closeAddTankModal();
      showMessage('Tank added successfully!', 'success');
    });

    function showTankDetails(tankId) {
      const tank = liveTanks.find(t => t.id === tankId);
      if (!tank) return;
      
      currentTankDetails = tank;
      
      // Populate modal with tank details
      document.getElementById('tankDetailsTitle').textContent = `Tank ${tank.tankNumber} Details`;
      document.getElementById('detailTankNumber').textContent = tank.tankNumber;
      document.getElementById('detailDepartment').textContent = tank.department;
      document.getElementById('detailProduct').textContent = tank.product;
      document.getElementById('detailCurrentLevel').textContent = `${tank.currentLevel} ${tank.levelUnit || 'mtr'}`;
      document.getElementById('detailTargetLevel').textContent = `${tank.targetLevel} ${tank.levelUnit || 'mtr'}`;
      document.getElementById('detailRate').textContent = `${tank.actualRate || 0} ${tank.rateUnit}`;
      document.getElementById('detailStatus').innerHTML = `<span class="status-badge badge-${tank.status}">${tank.status}</span>`;
      document.getElementById('detailNotes').textContent = tank.notes || 'No notes';
      document.getElementById('detailLastUpdated').textContent = new Date(tank.lastUpdated).toLocaleString();
      document.getElementById('detailUpdatedBy').textContent = tank.updatedBy;
      
      // Show/hide action buttons based on permissions
      document.getElementById('detailEditBtn').style.display = userPermissions.canEdit ? 'inline-flex' : 'none';
      document.getElementById('detailDeleteBtn').style.display = userPermissions.canDelete ? 'inline-flex' : 'none';
      
      // Show modal
      document.getElementById('tankDetailsModal').classList.add('show');
    }

    function closeTankDetails() {
      document.getElementById('tankDetailsModal').classList.remove('show');
      currentTankDetails = null;
    }

    function editTank(tankId) {
      const tank = liveTanks.find(t => t.id === tankId);
      if (!tank) return;
      
      currentEditingTank = tank;
      
      // Close details modal if open
      closeTankDetails();
      
      // Populate edit form
      document.getElementById('editTankNumber').value = tank.tankNumber;
      document.getElementById('editProduct').value = tank.product;
      document.getElementById('editPreviousLevel').value = tank.currentLevel;
      document.getElementById('editCurrentLevel').value = tank.currentLevel;
      document.getElementById('editTargetLevel').value = tank.targetLevel;
      document.getElementById('editRateUnit').value = tank.rateUnit;
      document.getElementById('editNotes').value = tank.notes || '';
      
      // Show modal
      document.getElementById('editTankModal').classList.add('show');
    }

    function closeEditModal() {
      document.getElementById('editTankModal').classList.remove('show');
      currentEditingTank = null;
    }

    // Edit tank form submission
    document.getElementById('editTankForm').addEventListener('submit', function(e) {
      e.preventDefault();
      
      if (!currentEditingTank) return;
      
      const previousLevel = parseFloat(document.getElementById('editPreviousLevel').value);
      const newCurrentLevel = parseFloat(document.getElementById('editCurrentLevel').value);
      const newTargetLevel = parseFloat(document.getElementById('editTargetLevel').value);
      const newNotes = document.getElementById('editNotes').value;
      
      // Calculate actual rate
      const actualRate = calculateActualRate(currentEditingTank, newCurrentLevel);
      
      // Track changes
      const changes = {};
      if (newCurrentLevel !== currentEditingTank.currentLevel) {
        changes['Current Level'] = {
          old: `${currentEditingTank.currentLevel} ${currentEditingTank.levelUnit || 'mtr'}`,
          new: `${newCurrentLevel} ${currentEditingTank.levelUnit || 'mtr'}`
        };
      }
      if (newTargetLevel !== currentEditingTank.targetLevel) {
        changes['Target Level'] = {
          old: `${currentEditingTank.targetLevel} ${currentEditingTank.levelUnit || 'mtr'}`,
          new: `${newTargetLevel} ${currentEditingTank.levelUnit || 'mtr'}`
        };
      }
      if (actualRate !== currentEditingTank.actualRate) {
        changes['Rate'] = {
          old: `${currentEditingTank.actualRate || 0} ${currentEditingTank.rateUnit}`,
          new: `${actualRate} ${currentEditingTank.rateUnit}`
        };
      }
      
      // Update tank
      currentEditingTank.currentLevel = newCurrentLevel;
      currentEditingTank.targetLevel = newTargetLevel;
      currentEditingTank.actualRate = actualRate;
      currentEditingTank.notes = newNotes;
      currentEditingTank.lastUpdated = new Date().toISOString();
      currentEditingTank.updatedBy = currentUser.name;
      currentEditingTank.lastLevelUpdate = new Date().toISOString();
      
      // Add to history if there are changes
      if (Object.keys(changes).length > 0) {
        currentEditingTank.history = currentEditingTank.history || [];
        currentEditingTank.history.unshift({
          action: 'Tank Updated',
          timestamp: new Date().toISOString(),
          user: currentUser.name,
          changes: changes,
          notes: newNotes
        });
      }
      
      saveLiveTanks();
      renderTanks();
      closeEditModal();
      showMessage('Tank updated successfully!', 'success');
    });

    function calculateActualRate(tank, newLevel) {
      const currentTime = new Date();
      const lastUpdate = new Date(tank.lastLevelUpdate || tank.lastUpdated);
      const timeDiffHours = (currentTime - lastUpdate) / (1000 * 60 * 60);
      
      if (timeDiffHours === 0) return tank.actualRate || 0;
      
      const levelDiff = newLevel - tank.currentLevel;
      
      console.log('Rate calculation:', {
        department: tank.department,
        rateUnit: tank.rateUnit,
        levelDiff: levelDiff,
        timeDiffHours: timeDiffHours,
        currentLevel: tank.currentLevel,
        newLevel: newLevel
      });
      
      let actualRate = 0;
      
      // FIXED: Check for meter/hr or mtr/hr in PBCR/WASHERY
      if ((tank.department === 'PBCR' || tank.department === 'WASHERY') && (tank.rateUnit === 'meter/hr' || tank.rateUnit === 'mtr/hr' || tank.rateUnit === 'mtr')) {
        // For meter/hr, calculate directly in meters
        actualRate = levelDiff / timeDiffHours;
        console.log('Calculated rate (meter/hr):', actualRate);
      } else if ((tank.department === 'PBCR' || tank.department === 'WASHERY') && tank.rateUnit === 'bbl/hr') {
        // For bbl/hr, convert meters to barrels
        const volumeM3 = levelDiff * 1000; // Assuming tank area of 1000 m¬≤
        const volumeBbl = volumeM3 * 6.28981; // Convert m¬≥ to barrels
        actualRate = volumeBbl / timeDiffHours;
        console.log('Calculated rate (bbl/hr):', actualRate);
      } else if (tank.department === 'PLCR' && tank.rateUnit === 'MT/hr') {
        // For PLCR MT/hr, convert volume to mass
        const volumeM3 = levelDiff * 1000; // Assuming tank area of 1000 m¬≤
        const massMT = volumeM3 * 0.85; // Assuming density of 0.85 MT/m¬≥
        actualRate = massMT / timeDiffHours;
        console.log('Calculated rate (MT/hr):', actualRate);
      }
      
      return Math.round(actualRate * 100) / 100; // Round to 2 decimal places
    }

    function addReminder(tank) {
      const subject = `Tank ${tank.tankNumber} - ${tank.product} Reminder`;
      const details = `Department: ${tank.department}
Tank Number: ${tank.tankNumber}
Product: ${tank.product}
Current Level: ${tank.currentLevel} ${tank.levelUnit || 'mtr'}
Target Level: ${tank.targetLevel} ${tank.levelUnit || 'mtr'}
Rate: ${tank.actualRate || 0} ${tank.rateUnit}
Notes: ${tank.notes || 'No notes'}`;
      
      const startDate = new Date();
      startDate.setHours(startDate.getHours() + 1); // Set reminder for 1 hour from now
      
      const endDate = new Date(startDate);
      endDate.setHours(endDate.getHours() + 1);
      
      const googleCalendarUrl = `https://calendar.google.com/calendar/render?action=TEMPLATE&text=${encodeURIComponent(subject)}&dates=${startDate.toISOString().replace(/[-:]/g, '').split('.')[0]}Z/${endDate.toISOString().replace(/[-:]/g, '').split('.')[0]}Z&details=${encodeURIComponent(details)}`;
      
      window.open(googleCalendarUrl, '_blank');
    }

    function showTankHistory(tankId) {
      const tank = liveTanks.find(t => t.id === tankId);
      if (!tank || !tank.history) return;
      
      const timeline = document.getElementById('historyTimeline');
      timeline.innerHTML = '';
      
      tank.history.forEach(entry => {
        const historyItem = document.createElement('div');
        historyItem.className = 'history-item';
        
        let changesHtml = '';
        if (entry.changes && Object.keys(entry.changes).length > 0) {
          changesHtml = '<div class="history-changes"><div class="changes-grid">';
          Object.entries(entry.changes).forEach(([field, change]) => {
            changesHtml += `
              <div class="change-item">
                <span class="change-field">${field}:</span>
                <div class="change-values">
                  <span class="old-value">${change.old}</span>
                  <span class="arrow">‚Üí</span>
                  <span class="new-value">${change.new}</span>
                </div>
              </div>
            `;
          });
          changesHtml += '</div></div>';
        }
        
        const notesHtml = entry.notes ? `<div class="history-notes">${entry.notes}</div>` : '';
        
        historyItem.innerHTML = `
          <div class="history-header">
            <span class="history-date">${new Date(entry.timestamp).toLocaleString()}</span>
            <span class="history-user">${entry.user}</span>
          </div>
          <div class="history-action">${entry.action}</div>
          ${changesHtml}
          ${notesHtml}
        `;
        
        timeline.appendChild(historyItem);
      });
      
      document.getElementById('historyModal').classList.add('show');
    }

    function closeHistoryModal() {
      document.getElementById('historyModal').classList.remove('show');
    }

    function deleteTank(tankId) {
      if (!confirm('Are you sure you want to delete this tank?')) return;
      
      const tankIndex = liveTanks.findIndex(t => t.id === tankId);
      if (tankIndex === -1) return;
      
      const tank = liveTanks[tankIndex];
      liveTanks.splice(tankIndex, 1);
      
      saveLiveTanks();
      renderTanks();
      closeTankDetails();
      showMessage(`Tank ${tank.tankNumber} deleted successfully!`, 'success');
    }

    function saveLiveTanks() {
      localStorage.setItem('liveTanks', JSON.stringify(liveTanks));
    }

    function generateId() {
      return Date.now().toString(36) + Math.random().toString(36).substr(2);
    }

    function setupAutoRefresh() {
      // Refresh every 30 seconds
      refreshInterval = setInterval(() => {
        loadLiveTanks();
        showRefreshIndicator();
      }, 30000);
    }

    function showRefreshIndicator() {
      const indicator = document.createElement('div');
      indicator.className = 'refresh-indicator';
      indicator.textContent = 'Data refreshed';
      document.body.appendChild(indicator);
      
      setTimeout(() => {
        document.body.removeChild(indicator);
      }, 2000);
    }

    function showMessage(text, type = 'info') {
      const message = document.createElement('div');
      message.className = `message ${type}`;
      message.textContent = text;
      
      const container = document.getElementById('mainContainer');
      container.insertBefore(message, container.firstChild);
      
      setTimeout(() => {
        if (message.parentNode) {
          message.parentNode.removeChild(message);
        }
      }, 5000);
    }

    // Font size controls
    function changeFontSize(delta) {
      const currentSize = parseFloat(getComputedStyle(document.body).fontSize);
      const newSize = Math.max(12, Math.min(20, currentSize + delta));
      document.body.style.fontSize = newSize + 'px';
      localStorage.setItem('fontSize', newSize);
    }

    // Load saved font size
    const savedFontSize = localStorage.getItem('fontSize');
    if (savedFontSize) {
      document.body.style.fontSize = savedFontSize + 'px';
    }

    // Navigation functions
    function goToLogin() {
      window.location.href = 'login.html';
    }

    function logout() {
      localStorage.removeItem('currentUser');
      localStorage.removeItem('userPermissions');
      window.location.href = 'login.html';
    }

    // Global functions for modal access
    window.showTankDetails = showTankDetails;
    window.editTank = editTank;
    window.deleteTank = deleteTank;
    window.addReminder = addReminder;
    window.showTankHistory = showTankHistory;
    window.closeTankDetails = closeTankDetails;
    window.closeEditModal = closeEditModal;
    window.closeHistoryModal = closeHistoryModal;
    window.showAddTankModal = showAddTankModal;
    window.closeAddTankModal = closeAddTankModal;
    window.updateProductOptions = updateProductOptions;
    window.checkOtherProduct = checkOtherProduct;
    window.changeFontSize = changeFontSize;
    window.goToLogin = goToLogin;
    window.logout = logout;

    // Service Worker Registration
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', function() {
        navigator.serviceWorker.register('/sw.js')
          .then(function(registration) {
            console.log('ServiceWorker registration successful');
          })
          .catch(function(err) {
            console.log('ServiceWorker registration failed: ', err);
          });
      });
    }
  </script>
</body>
</html>



  <!-- Tank Details Modal -->
  <div id="tankDetailsModal" class="tank-details-modal">
    <div class="tank-details-content">
      <div class="tank-details-header">
        <h3 class="tank-details-title" id="tankDetailsTitle">üè≠ Tank Details</h3>
        <button class="close-btn" onclick="closeTankDetails()">&times;</button>
      </div>
      <div id="tankDetailsBody">
        <!-- Tank details will be populated here -->
      </div>
    </div>
  </div>

  <!-- Add Tank Modal -->
  <div id="addTankModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title" id="addModalTitle">‚ûï Add New Tank</h3>
        <button class="close-btn" onclick="closeAddModal()">&times;</button>
      </div>
      <form id="addTankForm">
        <!-- ÿßŸÑÿ≥ÿ∑ÿ± ÿßŸÑÿ£ŸàŸÑ: ÿßŸÑŸÇÿ≥ŸÖ -->
        <div class="form-group">
          <label class="form-label">üè≠ Department:</label>
          <select class="form-select" id="addDepartment" onchange="updateProductOptions()" required>
            <option value="">Select Department</option>
            <option value="PBCR">PBCR</option>
            <option value="WASHERY">WASHERY</option>
            <option value="PLCR">PLCR</option>
          </select>
        </div>
        
        <!-- ÿßŸÑÿ≥ÿ∑ÿ± ÿßŸÑÿ´ÿßŸÜŸä: ÿ±ŸÇŸÖ ÿßŸÑÿ™ÿßŸÜŸÉ + ÿßŸÑŸÖŸÜÿ™ÿ¨ -->
        <div class="form-row" style="display:flex;gap:10px">
          <div class="form-group" style="flex:1">
            <label class="form-label">üè∑Ô∏è Tank Number:</label>
            <input type="number" class="form-input" id="addTankNumber" placeholder="e.g. 225" onchange="updateAddRateUnit()" required>
          </div>
          <div class="form-group" style="flex:1">
            <label class="form-label">üõ¢Ô∏è Product Type:</label>
            <select class="form-select" id="addProduct" required>
              <option value="">Select Product</option>
            </select>
          </div>
        </div>
        
        <!-- ÿßŸÑÿ≥ÿ∑ÿ± ÿßŸÑÿ´ÿßŸÑÿ´: Current Level + meter -->
        <div class="form-row" style="display:flex;gap:10px">
          <div class="form-group" style="flex:1">
            <label class="form-label">üìè Current Level:</label>
            <input type="number" step="any" class="form-input" id="addCurrentLevel" placeholder="Enter current level" onchange="calculateAddTime()" required>
          </div>
          <div class="form-group" style="flex:1">
            <label class="form-label">üìè Unit:</label>
            <input type="text" class="form-input" value="meter" readonly style="background:#f5f5f5;color:#666">
          </div>
        </div>
        
        <!-- ÿßŸÑÿ≥ÿ∑ÿ± ÿßŸÑÿ±ÿßÿ®ÿπ: Target Value + Target Type -->
        <div class="form-row" style="display:flex;gap:10px">
          <div class="form-group" style="flex:1">
            <label class="form-label">üìä Target Value:</label>
            <input type="number" step="any" class="form-input" id="addTargetValue" placeholder="Enter target value" onchange="calculateAddTime()" required>
          </div>
          <div class="form-group" style="flex:1">
            <label class="form-label">üéØ Target Type:</label>
            <select class="form-select" id="addTargetType" onchange="calculateAddTime()" required>
              <option value="">Select Target Type</option>
              <option value="pumpable">Pumpable</option>
              <option value="ullage">Ullage</option>
              <option value="level">Level</option>
            </select>
          </div>
        </div>
        
        <!-- ÿßŸÑÿ≥ÿ∑ÿ± ÿßŸÑÿÆÿßŸÖÿ≥: Flow Rate + Rate Unit -->
        <div class="form-row" style="display:flex;gap:10px">
          <div class="form-group" style="flex:1">
            <label class="form-label">‚ö° Flow Rate:</label>
            <input type="number" step="any" class="form-input" id="addRate" placeholder="Rate" onchange="calculateAddTime()" required>
          </div>
          <div class="form-group" style="flex:1">
            <label class="form-label">üìè Rate Unit:</label>
            <input type="text" class="form-input" id="addRateUnit" readonly style="background:#f5f5f5" value="bbl/hr">
          </div>
        </div>
        
        <!-- ÿßŸÑÿ≥ÿ∑ÿ± ÿßŸÑÿ≥ÿßÿØÿ≥: ÿßŸÑÿ™ÿßÿ±ŸäÿÆ + ÿßŸÑŸàŸÇÿ™ -->
        <div class="form-row" style="display:flex;gap:10px">
          <div class="form-group" style="flex:1">
            <label class="form-label">üìÖ Finish Date:</label>
            <input type="date" class="form-input" id="addFinishDate" required>
          </div>
          <div class="form-group" style="flex:1">
            <label class="form-label">‚è∞ Finish Time:</label>
            <input type="time" class="form-input" id="addFinishTime" required>
          </div>
        </div>
        
        <!-- ÿßŸÑÿ≥ÿ∑ÿ± ÿßŸÑÿ≥ÿßÿ®ÿπ: Notes -->
        <div class="form-group">
          <label class="form-label">üìù Notes (Optional):</label>
          <textarea class="form-textarea" id="addNotes" placeholder="Additional information..."></textarea>
        </div>
        
        <div class="modal-buttons">
          <button type="button" class="btn btn-secondary" onclick="closeAddModal()">‚ùå Cancel</button>
          <button type="submit" class="btn btn-primary">üíæ Save Tank</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Edit Tank Modal -->
  <div id="editTankModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title">‚úèÔ∏è Edit Tank</h3>
        <button class="close-btn" onclick="closeEditModal()">&times;</button>
      </div>
      <form id="editTankForm">
        <div class="form-group">
          <label class="form-label">üè∑Ô∏è Tank Number:</label>
          <input type="text" class="form-input" id="editTankNumber" readonly style="background:#f5f5f5">
        </div>
        
        <div class="form-group">
          <label class="form-label">üõ¢Ô∏è Product:</label>
          <input type="text" class="form-input" id="editProduct" readonly style="background:#f5f5f5">
        </div>
        
        <div class="form-group">
          <label class="form-label">üìè Previous Level:</label>
          <input type="number" class="form-input" id="editPreviousLevel" readonly style="background:#f5f5f5">
        </div>
        
        <div class="form-group">
          <label class="form-label">üìè Current Level:</label>
          <input type="number" step="any" class="form-input" id="editCurrentLevel" onchange="calculateEditTime()" required>
        </div>
        
        <div class="form-group">
          <label class="form-label">üìä Target Value:</label>
          <input type="number" step="any" class="form-input" id="editTargetValue" onchange="calculateEditTime()" required>
        </div>
        
        <div class="form-group">
          <label class="form-label">üéØ Target Type:</label>
          <select class="form-select" id="editTargetType" onchange="calculateEditTime()" required>
            <option value="pumpable">Pumpable</option>
            <option value="ullage">Ullage</option>
            <option value="level">Level</option>
          </select>
        </div>
        
        <div class="form-group">
          <label class="form-label">‚ö° Flow Rate:</label>
          <input type="number" step="any" class="form-input" id="editRate" onchange="calculateEditTime()" required>
        </div>
        
        <div class="form-group">
          <label class="form-label">üìè Rate Unit:</label>
          <input type="text" class="form-input" id="editRateUnit" readonly style="background:#f5f5f5">
        </div>
        
        <div class="form-row" style="display:flex;gap:10px">
          <div class="form-group" style="flex:1">
            <label class="form-label">üìÖ Finish Date:</label>
            <input type="date" class="form-input" id="editFinishDate" required>
          </div>
          <div class="form-group" style="flex:1">
            <label class="form-label">‚è∞ Finish Time:</label>
            <input type="time" class="form-input" id="editFinishTime" required>
          </div>
        </div>
        
        <div class="form-group">
          <label class="form-label">üìù Notes:</label>
          <textarea class="form-textarea" id="editNotes" placeholder="Additional information..."></textarea>
        </div>
        
        <div class="modal-buttons">
          <button type="button" class="btn btn-secondary" onclick="closeEditModal()">‚ùå Cancel</button>
          <button type="submit" class="btn btn-primary">üíæ Update Tank</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    // Global variables
    let liveTanks = [];
    let currentUser = null;
    let userPermissions = {};
    let currentEditingTank = null;
    let currentTankDetails = null;
    let refreshInterval = null;

    // Product configurations by department
    const productsByDepartment = {
      'PBCR': ['LSFO', 'EGO 10PPM', 'EGO 500PPM', 'RHN', 'PCNA', 'NMOGAS', 'OLMOGAS', 'ATK', 'ARDR', 'IC5', 'ISOM', 'SLOP', 'OTHER'],
      'WASHERY': ['LSFO', 'EGO 10PPM', 'EGO 500PPM', 'RHN', 'PCNA', 'NMOGAS', 'OLMOGAS', 'ATK', 'ARDR', 'IC5', 'ISOM', 'SLOP', 'OTHER'],
      'PLCR': ['NAPHA', 'PCNA', 'HSD-EGO', 'EGO', 'F.OIL', 'MOGAS', 'VGO', 'KKERO', 'ARDR', 'METHANOL', 'OTHER']
    };

    const rateUnitsByDepartment = {
      'PBCR': ['bbl/hr', 'meter/hr'],
      'WASHERY': ['bbl/hr', 'meter/hr'],
      'PLCR': ['MT/hr']
    };

    // Initialize page
    document.addEventListener('DOMContentLoaded', function() {
      initializePage();
    });

    async function initializePage() {
      try {
        // Check permissions first
        await setupPermissions();
        
        // Load live tanks data
        await loadLiveTanks();
        
        // Setup auto-refresh
        setupAutoRefresh();
        
      } catch (error) {
        console.error('Error initializing page:', error);
        showMessage('Error loading page. Please refresh.', 'error');
      }
    }

    async function setupPermissions() {
      try {
        // Check if user is logged in
        const storedUser = localStorage.getItem('currentUser');
        const storedPermissions = localStorage.getItem('userPermissions');
        
        if (storedUser && storedPermissions) {
          currentUser = JSON.parse(storedUser);
          userPermissions = JSON.parse(storedPermissions);
          console.log('Live Tanks permissions setup completed');
          updateUIBasedOnPermissions();
        } else {
          // Redirect to login if no user found
          console.log('No user found, redirecting to login');
          window.location.href = 'login.html';
          return;
        }
      } catch (error) {
        console.error('Error setting up permissions:', error);
        // Redirect to login on error
        window.location.href = 'login.html';
      }
    }

    function updateUIBasedOnPermissions() {
      // Update user info
      if (currentUser) {
        document.getElementById('userName').textContent = currentUser.name;
        document.getElementById('userAvatar').textContent = currentUser.avatar;
      }

      // Show/hide admin link
      if (userPermissions.isAdmin) {
        document.getElementById('adminLink').style.display = 'inline-block';
      }

      // Show/hide add buttons
      const addButtons = document.querySelectorAll('.add-tank-btn');
      addButtons.forEach(btn => {
        btn.style.display = userPermissions.canAdd ? 'flex' : 'none';
      });
    }

    async function loadLiveTanks() {
      try {
        // Load from localStorage for now
        const stored = localStorage.getItem('liveTanks');
        liveTanks = stored ? JSON.parse(stored) : [];
        
        // Render tanks
        renderTanks();
        
      } catch (error) {
        console.error('Error loading live tanks:', error);
        showMessage('Error loading tanks data.', 'error');
      }
    }

    function renderTanks() {
      const pbcrContainer = document.getElementById('pbcrContainer');
      const washeryContainer = document.getElementById('washeryContainer');
      const plcrContainer = document.getElementById('plcrContainer');
      
      // Clear existing content
      pbcrContainer.innerHTML = '';
      washeryContainer.innerHTML = '';
      plcrContainer.innerHTML = '';
      
      let pbcrCount = 0;
      let washeryCount = 0;
      let plcrCount = 0;
      
      liveTanks.forEach(tank => {
        const tankCard = createTankCard(tank);
        
        if (tank.department === 'PBCR') {
          pbcrContainer.appendChild(tankCard);
          pbcrCount++;
        } else if (tank.department === 'WASHERY') {
          washeryContainer.appendChild(tankCard);
          washeryCount++;
        } else if (tank.department === 'PLCR') {
          plcrContainer.appendChild(tankCard);
          plcrCount++;
        }
      });
      
      // Update counts
      document.getElementById('pbcrCount').textContent = `(${pbcrCount} tanks)`;
      document.getElementById('washeryCount').textContent = `(${washeryCount} tanks)`;
      document.getElementById('plcrCount').textContent = `(${plcrCount} tanks)`;
      
      // Show empty state if no tanks
      if (pbcrCount === 0) {
        pbcrContainer.innerHTML = '<div class="empty-state"><div class="empty-icon">üè≠</div><div>No PBCR tanks found</div></div>';
      }
      if (washeryCount === 0) {
        washeryContainer.innerHTML = '<div class="empty-state"><div class="empty-icon">üåä</div><div>No WASHERY tanks found</div></div>';
      }
      if (plcrCount === 0) {
        plcrContainer.innerHTML = '<div class="empty-state"><div class="empty-icon">‚öôÔ∏è</div><div>No PLCR tanks found</div></div>';
      }
    }

    function createTankCard(tank) {
      const card = document.createElement('div');
      card.className = 'tank-card';
      
      // Determine urgency
      const urgency = calculateUrgency(tank);
      card.classList.add(`urgency-${urgency}`);
      
      // Calculate time to target
      const timeToTarget = calculateTimeToTarget(tank);
      
      card.innerHTML = `
        <div class="tank-header">
          <div class="tank-number">Tank ${tank.tankNumber}</div>
          <div class="tank-status ${tank.status}">${tank.status}</div>
        </div>
        <div class="tank-info">
          <div class="info-item">
            <span class="info-label">Product:</span>
            <span class="info-value product-${tank.product.toLowerCase().replace(/[^a-z0-9]/g, '-')}">${tank.product}</span>
          </div>
          <div class="info-item">
            <span class="info-label">Current Level:</span>
            <span class="info-value">${tank.currentLevel} meter</span>
          </div>
          <div class="info-item">
            <span class="info-label">Target:</span>
            <span class="info-value">${tank.targetValue} ${tank.targetType}</span>
          </div>
          <div class="info-item">
            <span class="info-label">Rate:</span>
            <span class="info-value">${tank.actualRate || 0} ${tank.rateUnit}</span>
          </div>
          <div class="info-item">
            <span class="info-label">Time to Target:</span>
            <span class="info-value time-${urgency}">${timeToTarget}</span>
          </div>
          <div class="info-item">
            <span class="info-label">Finish Time:</span>
            <span class="info-value">${new Date(tank.finishDateTime).toLocaleString()}</span>
          </div>
        </div>
        <div class="tank-actions">
          <button class="action-btn btn-view" onclick="showTankDetails('${tank.id}')" title="View Details">‚ùó</button>
          ${userPermissions.canEdit ? `<button class="action-btn btn-edit" onclick="editTank('${tank.id}')" title="Edit">‚úèÔ∏è</button>` : ''}
          ${userPermissions.canDelete ? `<button class="action-btn btn-delete" onclick="deleteTank('${tank.id}')" title="Delete">üóëÔ∏è</button>` : ''}
        </div>
      `;
      
      return card;
    }

    function calculateUrgency(tank) {
      const finishTime = new Date(tank.finishDateTime);
      const now = new Date();
      const hoursRemaining = (finishTime - now) / (1000 * 60 * 60);
      
      if (hoursRemaining <= 2) return 'critical';
      if (hoursRemaining <= 6) return 'warning';
      return 'normal';
    }

    function calculateTimeToTarget(tank) {
      const finishTime = new Date(tank.finishDateTime);
      const now = new Date();
      const msRemaining = finishTime - now;
      
      if (msRemaining <= 0) return 'Overdue';
      
      const hoursRemaining = msRemaining / (1000 * 60 * 60);
      
      if (hoursRemaining < 1) {
        return `${Math.round(hoursRemaining * 60)} min`;
      } else if (hoursRemaining < 24) {
        return `${hoursRemaining.toFixed(1)} hrs`;
      } else {
        return `${(hoursRemaining / 24).toFixed(1)} days`;
      }
    }

    function openAddModal(department) {
      document.getElementById('addDepartment').value = department;
      updateProductOptions();
      document.getElementById('addTankModal').classList.add('show');
    }

    function closeAddModal() {
      document.getElementById('addTankModal').classList.remove('show');
      document.getElementById('addTankForm').reset();
    }

    function updateProductOptions() {
      const department = document.getElementById('addDepartment').value;
      const productSelect = document.getElementById('addProduct');
      
      // Clear existing options
      productSelect.innerHTML = '<option value="">Select Product</option>';
      
      if (department && productsByDepartment[department]) {
        productsByDepartment[department].forEach(product => {
          const option = document.createElement('option');
          option.value = product;
          option.textContent = product;
          productSelect.appendChild(option);
        });
      }
    }

    function checkOtherProduct() {
      const productSelect = document.getElementById('addProduct');
      const otherGroup = document.getElementById('addOtherProductGroup');
      
      if (productSelect.value === 'OTHER') {
        otherGroup.style.display = 'block';
        document.getElementById('addOtherProduct').required = true;
      } else {
        otherGroup.style.display = 'none';
        document.getElementById('addOtherProduct').required = false;
      }
    }

    function updateAddRateUnit() {
      const department = document.getElementById('addDepartment').value;
      const tankNumber = document.getElementById('addTankNumber').value;
      const rateUnitInput = document.getElementById('addRateUnit');
      
      if (department === 'PLCR') {
        rateUnitInput.value = 'MT/hr';
      } else {
        rateUnitInput.value = 'bbl/hr';
      }
    }

    function calculateAddTime() {
      const currentLevel = parseFloat(document.getElementById('addCurrentLevel').value);
      const targetValue = parseFloat(document.getElementById('addTargetValue').value);
      const targetType = document.getElementById('addTargetType').value;
      const rate = parseFloat(document.getElementById('addRate').value);
      
      if (!currentLevel || !targetValue || !targetType || !rate) return;
      
      let targetLevel = targetValue;
      if (targetType === 'ullage') {
        targetLevel = 20 - targetValue; // Assuming max capacity is 20m
      } else if (targetType === 'pumpable') {
        targetLevel = targetValue + 0.5; // Add 0.5m for pumpable level
      }
      
      const levelDiff = Math.abs(targetLevel - currentLevel);
      const timeHours = levelDiff / (rate / 159); // Convert bbl/hr to m/hr (rough conversion)
      
      const finishTime = new Date();
      finishTime.setHours(finishTime.getHours() + timeHours);
      
      document.getElementById('addFinishDate').value = finishTime.toISOString().split('T')[0];
      document.getElementById('addFinishTime').value = finishTime.toTimeString().split(' ')[0].substring(0, 5);
    }

    function calculateEditTime() {
      const currentLevel = parseFloat(document.getElementById('editCurrentLevel').value);
      const targetValue = parseFloat(document.getElementById('editTargetValue').value);
      const targetType = document.getElementById('editTargetType').value;
      const rate = parseFloat(document.getElementById('editRate').value);
      
      if (!currentLevel || !targetValue || !targetType || !rate) return;
      
      let targetLevel = targetValue;
      if (targetType === 'ullage') {
        targetLevel = 20 - targetValue; // Assuming max capacity is 20m
      } else if (targetType === 'pumpable') {
        targetLevel = targetValue + 0.5; // Add 0.5m for pumpable level
      }
      
      const levelDiff = Math.abs(targetLevel - currentLevel);
      const timeHours = levelDiff / (rate / 159); // Convert bbl/hr to m/hr (rough conversion)
      
      const finishTime = new Date();
      finishTime.setHours(finishTime.getHours() + timeHours);
      
      document.getElementById('editFinishDate').value = finishTime.toISOString().split('T')[0];
      document.getElementById('editFinishTime').value = finishTime.toTimeString().split(' ')[0].substring(0, 5);
    }

    // Add tank form submission
    document.getElementById('addTankForm').addEventListener('submit', function(e) {
      e.preventDefault();
      
      const department = document.getElementById('addDepartment').value;
      const tankNumber = document.getElementById('addTankNumber').value;
      const product = document.getElementById('addProduct').value === 'OTHER' ? 
                     document.getElementById('addOtherProduct').value : 
                     document.getElementById('addProduct').value;
      const currentLevel = parseFloat(document.getElementById('addCurrentLevel').value);
      const targetValue = parseFloat(document.getElementById('addTargetValue').value);
      const targetType = document.getElementById('addTargetType').value;
      const rate = parseFloat(document.getElementById('addRate').value);
      const rateUnit = document.getElementById('addRateUnit').value;
      const finishDate = document.getElementById('addFinishDate').value;
      const finishTime = document.getElementById('addFinishTime').value;
      const notes = document.getElementById('addNotes').value;
      
      // Check if tank number already exists
      if (liveTanks.some(tank => tank.tankNumber === tankNumber && tank.department === department)) {
        showMessage('Tank number already exists in this department.', 'error');
        return;
      }
      
      const finishDateTime = new Date(`${finishDate}T${finishTime}`);
      
      const newTank = {
        id: generateId(),
        department: department,
        tankNumber: tankNumber,
        product: product,
        currentLevel: currentLevel,
        targetValue: targetValue,
        targetType: targetType,
        rate: rate,
        rateUnit: rateUnit,
        actualRate: 0,
        status: 'active',
        notes: notes,
        finishDateTime: finishDateTime.toISOString(),
        createdAt: new Date().toISOString(),
        createdBy: currentUser.name,
        lastUpdated: new Date().toISOString(),
        updatedBy: currentUser.name,
        lastLevelUpdate: new Date().toISOString(),
        history: [{
          action: 'Tank Created',
          timestamp: new Date().toISOString(),
          user: currentUser.name,
          changes: {
            'Tank Number': { old: '', new: tankNumber },
            'Product': { old: '', new: product },
            'Current Level': { old: '', new: `${currentLevel} meter` },
            'Target': { old: '', new: `${targetValue} ${targetType}` },
            'Rate': { old: '', new: `${rate} ${rateUnit}` }
          },
          notes: notes
        }]
      };
      
      liveTanks.push(newTank);
      saveLiveTanks();
      renderTanks();
      closeAddModal();
      showMessage('Tank added successfully!', 'success');
    });

    function showTankDetails(tankId) {
      const tank = liveTanks.find(t => t.id === tankId);
      if (!tank) return;
      
      currentTankDetails = tank;
      
      // Populate modal with tank details
      document.getElementById('tankDetailsTitle').textContent = `Tank ${tank.tankNumber} Details`;
      
      const detailsBody = document.getElementById('tankDetailsBody');
      detailsBody.innerHTML = `
        <div class="tank-detail-section">
          <div class="tank-detail-dual">
            <div class="tank-detail-item">
              <span class="tank-detail-label">Tank Number</span>
              <div class="tank-detail-value">${tank.tankNumber}</div>
            </div>
            <div class="tank-detail-item">
              <span class="tank-detail-label">Department</span>
              <div class="tank-detail-value">${tank.department}</div>
            </div>
          </div>
        </div>

        <div class="tank-detail-section">
          <div class="tank-detail-single">
            <span class="tank-detail-label">Product</span>
            <div class="tank-detail-value">${tank.product}</div>
          </div>
        </div>

        <div class="tank-detail-section">
          <div class="tank-detail-dual">
            <div class="tank-detail-item">
              <span class="tank-detail-label">Current Level</span>
              <div class="tank-detail-value">${tank.currentLevel} meter</div>
            </div>
            <div class="tank-detail-item">
              <span class="tank-detail-label">Target</span>
              <div class="tank-detail-value">${tank.targetValue} ${tank.targetType}</div>
            </div>
          </div>
        </div>

        <div class="tank-detail-section">
          <div class="tank-detail-dual">
            <div class="tank-detail-item">
              <span class="tank-detail-label">Rate</span>
              <div class="tank-detail-value">${tank.actualRate || 0} ${tank.rateUnit}</div>
            </div>
            <div class="tank-detail-item">
              <span class="tank-detail-label">Status</span>
              <div class="tank-detail-value"><span class="status-badge badge-${tank.status}">${tank.status}</span></div>
            </div>
          </div>
        </div>

        <div class="tank-detail-section">
          <div class="tank-detail-single">
            <span class="tank-detail-label">Finish Time</span>
            <div class="tank-detail-value">${new Date(tank.finishDateTime).toLocaleString()}</div>
          </div>
        </div>

        <div class="tank-detail-section">
          <div class="tank-detail-single">
            <span class="tank-detail-label">Notes</span>
            <div class="tank-detail-value">${tank.notes || 'No notes'}</div>
          </div>
        </div>

        <div class="tank-detail-section">
          <div class="tank-detail-dual">
            <div class="tank-detail-item">
              <span class="tank-detail-label">Last Updated</span>
              <div class="tank-detail-value">${new Date(tank.lastUpdated).toLocaleString()}</div>
            </div>
            <div class="tank-detail-item">
              <span class="tank-detail-label">Updated By</span>
              <div class="tank-detail-value">${tank.updatedBy}</div>
            </div>
          </div>
        </div>

        <div class="tank-actions">
          ${userPermissions.canEdit ? `<button class="btn btn-primary" onclick="editTank('${tank.id}')">‚úèÔ∏è Edit Tank</button>` : ''}
          <button class="btn btn-warning" onclick="addReminder('${tank.id}')">üìÖ Add Reminder</button>
          <button class="btn btn-secondary" onclick="showTankHistory('${tank.id}')">üìä View History</button>
          ${userPermissions.canDelete ? `<button class="btn btn-danger" onclick="deleteTank('${tank.id}')">üóëÔ∏è Delete Tank</button>` : ''}
        </div>
      `;
      
      // Show modal
      document.getElementById('tankDetailsModal').classList.add('show');
    }

    function closeTankDetails() {
      document.getElementById('tankDetailsModal').classList.remove('show');
      currentTankDetails = null;
    }

    function editTank(tankId) {
      const tank = liveTanks.find(t => t.id === tankId);
      if (!tank) return;
      
      currentEditingTank = tank;
      
      // Close details modal if open
      closeTankDetails();
      
      // Populate edit form
      document.getElementById('editTankNumber').value = tank.tankNumber;
      document.getElementById('editProduct').value = tank.product;
      document.getElementById('editPreviousLevel').value = tank.currentLevel;
      document.getElementById('editCurrentLevel').value = tank.currentLevel;
      document.getElementById('editTargetValue').value = tank.targetValue;
      document.getElementById('editTargetType').value = tank.targetType;
      document.getElementById('editRate').value = tank.rate;
      document.getElementById('editRateUnit').value = tank.rateUnit;
      
      const finishTime = new Date(tank.finishDateTime);
      document.getElementById('editFinishDate').value = finishTime.toISOString().split('T')[0];
      document.getElementById('editFinishTime').value = finishTime.toTimeString().split(' ')[0].substring(0, 5);
      
      document.getElementById('editNotes').value = tank.notes || '';
      
      // Show modal
      document.getElementById('editTankModal').classList.add('show');
    }

    function closeEditModal() {
      document.getElementById('editTankModal').classList.remove('show');
      currentEditingTank = null;
    }

    // Edit tank form submission
    document.getElementById('editTankForm').addEventListener('submit', function(e) {
      e.preventDefault();
      
      if (!currentEditingTank) return;
      
      const previousLevel = parseFloat(document.getElementById('editPreviousLevel').value);
      const newCurrentLevel = parseFloat(document.getElementById('editCurrentLevel').value);
      const newTargetValue = parseFloat(document.getElementById('editTargetValue').value);
      const newTargetType = document.getElementById('editTargetType').value;
      const newRate = parseFloat(document.getElementById('editRate').value);
      const newFinishDate = document.getElementById('editFinishDate').value;
      const newFinishTime = document.getElementById('editFinishTime').value;
      const newNotes = document.getElementById('editNotes').value;
      
      // Calculate actual rate
      const actualRate = calculateActualRate(currentEditingTank, newCurrentLevel);
      
      // Track changes
      const changes = {};
      if (newCurrentLevel !== currentEditingTank.currentLevel) {
        changes['Current Level'] = {
          old: `${currentEditingTank.currentLevel} meter`,
          new: `${newCurrentLevel} meter`
        };
      }
      if (newTargetValue !== currentEditingTank.targetValue || newTargetType !== currentEditingTank.targetType) {
        changes['Target'] = {
          old: `${currentEditingTank.targetValue} ${currentEditingTank.targetType}`,
          new: `${newTargetValue} ${newTargetType}`
        };
      }
      if (newRate !== currentEditingTank.rate) {
        changes['Rate'] = {
          old: `${currentEditingTank.rate} ${currentEditingTank.rateUnit}`,
          new: `${newRate} ${currentEditingTank.rateUnit}`
        };
      }
      if (actualRate !== currentEditingTank.actualRate) {
        changes['Actual Rate'] = {
          old: `${currentEditingTank.actualRate || 0} ${currentEditingTank.rateUnit}`,
          new: `${actualRate} ${currentEditingTank.rateUnit}`
        };
      }
      
      const newFinishDateTime = new Date(`${newFinishDate}T${newFinishTime}`);
      
      // Update tank
      currentEditingTank.currentLevel = newCurrentLevel;
      currentEditingTank.targetValue = newTargetValue;
      currentEditingTank.targetType = newTargetType;
      currentEditingTank.rate = newRate;
      currentEditingTank.actualRate = actualRate;
      currentEditingTank.finishDateTime = newFinishDateTime.toISOString();
      currentEditingTank.notes = newNotes;
      currentEditingTank.lastUpdated = new Date().toISOString();
      currentEditingTank.updatedBy = currentUser.name;
      currentEditingTank.lastLevelUpdate = new Date().toISOString();
      
      // Add to history if there are changes
      if (Object.keys(changes).length > 0) {
        currentEditingTank.history = currentEditingTank.history || [];
        currentEditingTank.history.unshift({
          action: 'Tank Updated',
          timestamp: new Date().toISOString(),
          user: currentUser.name,
          changes: changes,
          notes: newNotes
        });
      }
      
      saveLiveTanks();
      renderTanks();
      closeEditModal();
      showMessage('Tank updated successfully!', 'success');
    });

    function calculateActualRate(tank, newLevel) {
      const currentTime = new Date();
      const lastUpdate = new Date(tank.lastLevelUpdate || tank.lastUpdated);
      const timeDiffHours = (currentTime - lastUpdate) / (1000 * 60 * 60);
      
      if (timeDiffHours === 0) return tank.actualRate || 0;
      
      const levelDiff = newLevel - tank.currentLevel;
      
      console.log('Rate calculation:', {
        department: tank.department,
        rateUnit: tank.rateUnit,
        levelDiff: levelDiff,
        timeDiffHours: timeDiffHours,
        currentLevel: tank.currentLevel,
        newLevel: newLevel
      });
      
      let actualRate = 0;
      
      if ((tank.department === 'PBCR' || tank.department === 'WASHERY') && (tank.rateUnit === 'meter/hr' || tank.rateUnit === 'mtr/hr')) {
        // FIXED: For meter/hr, calculate directly in meters
        actualRate = levelDiff / timeDiffHours;
        console.log('Calculated rate (meter/hr):', actualRate);
      } else if ((tank.department === 'PBCR' || tank.department === 'WASHERY') && tank.rateUnit === 'bbl/hr') {
        // For bbl/hr, convert meters to barrels
        const volumeM3 = levelDiff * 1000; // Assuming tank area of 1000 m¬≤
        const volumeBbl = volumeM3 * 6.28981; // Convert m¬≥ to barrels
        actualRate = volumeBbl / timeDiffHours;
        console.log('Calculated rate (bbl/hr):', actualRate);
      } else if (tank.department === 'PLCR' && tank.rateUnit === 'MT/hr') {
        // For PLCR MT/hr, convert volume to mass
        const volumeM3 = levelDiff * 1000; // Assuming tank area of 1000 m¬≤
        const massMT = volumeM3 * 0.85; // Assuming density of 0.85 MT/m¬≥
        actualRate = massMT / timeDiffHours;
        console.log('Calculated rate (MT/hr):', actualRate);
      }
      
      return Math.round(actualRate * 100) / 100; // Round to 2 decimal places
    }

    function addReminder(tankId) {
      const tank = liveTanks.find(t => t.id === tankId);
      if (!tank) return;
      
      const subject = `Tank ${tank.tankNumber} - ${tank.product} Reminder`;
      const details = `Department: ${tank.department}
Tank Number: ${tank.tankNumber}
Product: ${tank.product}
Current Level: ${tank.currentLevel} meter
Target: ${tank.targetValue} ${tank.targetType}
Rate: ${tank.actualRate || 0} ${tank.rateUnit}
Finish Time: ${new Date(tank.finishDateTime).toLocaleString()}
Notes: ${tank.notes || 'No notes'}`;
      
      const startDate = new Date(tank.finishDateTime);
      const endDate = new Date(startDate);
      endDate.setHours(endDate.getHours() + 1);
      
      const googleCalendarUrl = `https://calendar.google.com/calendar/render?action=TEMPLATE&text=${encodeURIComponent(subject)}&dates=${startDate.toISOString().replace(/[-:]/g, '').split('.')[0]}Z/${endDate.toISOString().replace(/[-:]/g, '').split('.')[0]}Z&details=${encodeURIComponent(details)}`;
      
      window.open(googleCalendarUrl, '_blank');
    }

    function showTankHistory(tankId) {
      const tank = liveTanks.find(t => t.id === tankId);
      if (!tank || !tank.history) return;
      
      // Create history modal content
      let historyHtml = '<div class="history-timeline">';
      
      tank.history.forEach(entry => {
        let changesHtml = '';
        if (entry.changes && Object.keys(entry.changes).length > 0) {
          changesHtml = '<div class="history-changes"><div class="changes-grid">';
          Object.entries(entry.changes).forEach(([field, change]) => {
            changesHtml += `
              <div class="change-item">
                <span class="change-field">${field}:</span>
                <div class="change-values">
                  <span class="old-value">${change.old}</span>
                  <span class="arrow">‚Üí</span>
                  <span class="new-value">${change.new}</span>
                </div>
              </div>
            `;
          });
          changesHtml += '</div></div>';
        }
        
        const notesHtml = entry.notes ? `<div class="history-notes">${entry.notes}</div>` : '';
        
        historyHtml += `
          <div class="history-item">
            <div class="history-header">
              <span class="history-date">${new Date(entry.timestamp).toLocaleString()}</span>
              <span class="history-user">${entry.user}</span>
            </div>
            <div class="history-action">${entry.action}</div>
            ${changesHtml}
            ${notesHtml}
          </div>
        `;
      });
      
      historyHtml += '</div>';
      
      // Show in a simple alert for now (can be enhanced with a proper modal)
      const historyWindow = window.open('', '_blank', 'width=600,height=400');
      historyWindow.document.write(`
        <html>
          <head><title>Tank ${tank.tankNumber} History</title></head>
          <body style="font-family: Arial, sans-serif; padding: 20px;">
            <h2>Tank ${tank.tankNumber} History</h2>
            ${historyHtml}
          </body>
        </html>
      `);
    }

    function deleteTank(tankId) {
      if (!confirm('Are you sure you want to delete this tank?')) return;
      
      const tankIndex = liveTanks.findIndex(t => t.id === tankId);
      if (tankIndex === -1) return;
      
      const tank = liveTanks[tankIndex];
      liveTanks.splice(tankIndex, 1);
      
      saveLiveTanks();
      renderTanks();
      closeTankDetails();
      showMessage(`Tank ${tank.tankNumber} deleted successfully!`, 'success');
    }

    function saveLiveTanks() {
      localStorage.setItem('liveTanks', JSON.stringify(liveTanks));
    }

    function generateId() {
      return Date.now().toString(36) + Math.random().toString(36).substr(2);
    }

    function setupAutoRefresh() {
      // Refresh every 30 seconds
      refreshInterval = setInterval(() => {
        loadLiveTanks();
        showRefreshIndicator();
      }, 30000);
    }

    function showRefreshIndicator() {
      const indicator = document.createElement('div');
      indicator.className = 'refresh-indicator';
      indicator.textContent = 'Data refreshed';
      document.body.appendChild(indicator);
      
      setTimeout(() => {
        document.body.removeChild(indicator);
      }, 2000);
    }

    function showMessage(text, type = 'info') {
      const message = document.createElement('div');
      message.className = `message ${type}`;
      message.textContent = text;
      
      const container = document.getElementById('messageContainer');
      container.appendChild(message);
      
      setTimeout(() => {
        if (message.parentNode) {
          message.parentNode.removeChild(message);
        }
      }, 5000);
    }

    // Font size controls
    function increaseFontSize() {
      const currentSize = parseFloat(getComputedStyle(document.body).fontSize);
      const newSize = Math.min(20, currentSize + 1);
      document.body.style.fontSize = newSize + 'px';
      localStorage.setItem('fontSize', newSize);
    }

    function decreaseFontSize() {
      const currentSize = parseFloat(getComputedStyle(document.body).fontSize);
      const newSize = Math.max(12, currentSize - 1);
      document.body.style.fontSize = newSize + 'px';
      localStorage.setItem('fontSize', newSize);
    }

    // Load saved font size
    const savedFontSize = localStorage.getItem('fontSize');
    if (savedFontSize) {
      document.body.style.fontSize = savedFontSize + 'px';
    }

    // Navigation functions
    function goToLogin() {
      window.location.href = 'login.html';
    }

    function logout() {
      localStorage.removeItem('currentUser');
      localStorage.removeItem('userPermissions');
      window.location.href = 'login.html';
    }

    // Global functions for modal access
    window.showTankDetails = showTankDetails;
    window.editTank = editTank;
    window.deleteTank = deleteTank;
    window.addReminder = addReminder;
    window.showTankHistory = showTankHistory;
    window.closeTankDetails = closeTankDetails;
    window.closeEditModal = closeEditModal;
    window.openAddModal = openAddModal;
    window.closeAddModal = closeAddModal;
    window.updateProductOptions = updateProductOptions;
    window.checkOtherProduct = checkOtherProduct;
    window.updateAddRateUnit = updateAddRateUnit;
    window.calculateAddTime = calculateAddTime;
    window.calculateEditTime = calculateEditTime;
    window.increaseFontSize = increaseFontSize;
    window.decreaseFontSize = decreaseFontSize;
    window.goToLogin = goToLogin;
    window.logout = logout;

    // Service Worker Registration
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', function() {
        navigator.serviceWorker.register('/sw.js')
          .then(function(registration) {
            console.log('ServiceWorker registration successful');
          })
          .catch(function(err) {
            console.log('ServiceWorker registration failed: ', err);
          });
      });
    }
  </script>
</body>
</html>

